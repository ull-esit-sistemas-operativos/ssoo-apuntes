<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.17">
<meta name="author" content="JesÃºs Torres">
<title>Sistemas Operativos</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
pre.rouge table td { padding: 5px; }
pre.rouge table pre { margin: 0; }
pre.rouge .cm {
  color: #999988;
  font-style: italic;
}
pre.rouge .cp {
  color: #999999;
  font-weight: bold;
}
pre.rouge .c1 {
  color: #999988;
  font-style: italic;
}
pre.rouge .cs {
  color: #999999;
  font-weight: bold;
  font-style: italic;
}
pre.rouge .c, pre.rouge .ch, pre.rouge .cd, pre.rouge .cpf {
  color: #999988;
  font-style: italic;
}
pre.rouge .err {
  color: #a61717;
  background-color: #e3d2d2;
}
pre.rouge .gd {
  color: #000000;
  background-color: #ffdddd;
}
pre.rouge .ge {
  color: #000000;
  font-style: italic;
}
pre.rouge .gr {
  color: #aa0000;
}
pre.rouge .gh {
  color: #999999;
}
pre.rouge .gi {
  color: #000000;
  background-color: #ddffdd;
}
pre.rouge .go {
  color: #888888;
}
pre.rouge .gp {
  color: #555555;
}
pre.rouge .gs {
  font-weight: bold;
}
pre.rouge .gu {
  color: #aaaaaa;
}
pre.rouge .gt {
  color: #aa0000;
}
pre.rouge .kc {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kd {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kn {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kp {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kr {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kt {
  color: #445588;
  font-weight: bold;
}
pre.rouge .k, pre.rouge .kv {
  color: #000000;
  font-weight: bold;
}
pre.rouge .mf {
  color: #009999;
}
pre.rouge .mh {
  color: #009999;
}
pre.rouge .il {
  color: #009999;
}
pre.rouge .mi {
  color: #009999;
}
pre.rouge .mo {
  color: #009999;
}
pre.rouge .m, pre.rouge .mb, pre.rouge .mx {
  color: #009999;
}
pre.rouge .sa {
  color: #000000;
  font-weight: bold;
}
pre.rouge .sb {
  color: #d14;
}
pre.rouge .sc {
  color: #d14;
}
pre.rouge .sd {
  color: #d14;
}
pre.rouge .s2 {
  color: #d14;
}
pre.rouge .se {
  color: #d14;
}
pre.rouge .sh {
  color: #d14;
}
pre.rouge .si {
  color: #d14;
}
pre.rouge .sx {
  color: #d14;
}
pre.rouge .sr {
  color: #009926;
}
pre.rouge .s1 {
  color: #d14;
}
pre.rouge .ss {
  color: #990073;
}
pre.rouge .s, pre.rouge .dl {
  color: #d14;
}
pre.rouge .na {
  color: #008080;
}
pre.rouge .bp {
  color: #999999;
}
pre.rouge .nb {
  color: #0086B3;
}
pre.rouge .nc {
  color: #445588;
  font-weight: bold;
}
pre.rouge .no {
  color: #008080;
}
pre.rouge .nd {
  color: #3c5d5d;
  font-weight: bold;
}
pre.rouge .ni {
  color: #800080;
}
pre.rouge .ne {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nf, pre.rouge .fm {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nl {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nn {
  color: #555555;
}
pre.rouge .nt {
  color: #000080;
}
pre.rouge .vc {
  color: #008080;
}
pre.rouge .vg {
  color: #008080;
}
pre.rouge .vi {
  color: #008080;
}
pre.rouge .nv, pre.rouge .vm {
  color: #008080;
}
pre.rouge .ow {
  color: #000000;
  font-weight: bold;
}
pre.rouge .o {
  color: #000000;
  font-weight: bold;
}
pre.rouge .w {
  color: #bbbbbb;
}
pre.rouge {
  background-color: #f8f8f8;
}
</style>
<meta name='robots' content='noindex,nofollow'>
<link rel="icon" href="media/extras/favicon.ico" sizes="any">
<link rel="icon" href="media/extras/ssoo-icon.svg" type="image/svg+xml">
<link rel="icon" type="image/png" sizes="192x192" href="media/extras/ssoo-icon-192.png">
<link rel="icon" type="image/png" sizes="512x512" href="media/extras/ssoo-icon-512.png">
<link rel="apple-touch-icon" href="media/extras/ssoo-apple-touch-icon.png"><!-- 180Ã180 -->
<link rel="stylesheet" href="media/extras/inlineDisqussions.css">
<style>
    body {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
    }
    content {
        flex: 1;
    }
    #preamble {
        margin-top: 0.5em;
    }
    #header, #content, #footnotes {
        margin: 0 auto 0 5em
    }
    #content h1>a.anchor, h2>a.anchor, h3>a.anchor,
    #toctitle>a.anchor, .sidebarblock>.content>.title>a.anchor,
    h4>a.anchor, h5>a.anchor, h6>a.anchor {
        color: #ba3925;
    }
    .imageblock {
        text-align: center;
    }
    .imageblock > .content {
        margin-bottom: 1rem;
    }
    .imageblock > .title {
        text-align: inherit;
    }
    .tableblock > .lightcell {
        color: gray;
    }
    table tfoot td p {
        font-weight: bold;
    }
    #footer-text {
        margin: 0 auto;
        max-width: 62.5em;
        padding-left: .9375em;
        padding-right: .9375em;
    }
    #footer-text a {
        color: hsla(0,0%,100%,.8);
        text-decoration: none;
        font-weight: bold;
    }
    #footer-text a:hover {
        color: hsla(0,0%,100%,.8);
    }
</style>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script src="media/extras/inlineDisqussions.js"></script>
<script type="text/javascript">
    window.onload = function(){
        if ('true' === 'true') {
            setTimeout(function() {
                disqus_shortname = 'ull-esit-sistemas-operativos';
                jQuery("img, p, .colist td, .stemblock").not('#toc p').inlineDisqussions();
                query_params = (new URL(document.location)).searchParams;
                if (query_params.has('disqussion')) {
                    let identifier = window.location.pathname + 'disqussion-' + query_params.get('disqussion');
                    let selection = jQuery('[data-disqus-identifier="' +  identifier + '"]').not('.disqussion-link');
                    if (selection.length) {
                        selection[0].scrollIntoView(true);
                    }
                }
            }, 500);
        }
    }
</script>
<style>.toc-current{font-weight: bold;} .toc-root{font-family: "Open Sans","DejaVu Sans",sans-serif;
                       font-size: 0.9em;} #content{display: flex; flex-direction: column; flex: 1 1 auto;}
             .nav-footer{text-align: center; margin-top: auto;}
             .nav-footer > p > a {white-space: nowrap;}</style>
<style>
.admonitionblock td.icon .icon-time:before {content:"\f017";color:#f28500;}
</style>
</head>
<body id="hilos" class="book toc2 toc-left">
<div id="header">
<h1>Sistemas Operativos</h1>
<div class="details">
<span id="author" class="author">JesÃºs Torres</span><br>
<span id="email" class="email"><a href="mailto:jmtorres@ull.es">jmtorres@ull.es</a></span><br>
<span id="revdate">EdiciÃ³n OCW</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Tabla de Contenido</div>
<p><span class="toc-root"><a href="main.html">Sistemas Operativos</a></span></p><ul class="sectlevel1">
<li><a href="ediciones_y_licencia.html">Ediciones y licencia</a>
</li>
<li><a href="cÃ³digo_de_los_ejemplos.html">CÃ³digo de los ejemplos</a>
</li>
<li><a href="introducciÃ³n.html">Parte I: IntroducciÃ³n</a>
</li>
<li><a href="organizaciÃ³n_de_los_sistemas_operativos.html">Parte II: OrganizaciÃ³n de los sistemas operativos</a>
</li>
<li><a href="gestiÃ³n_de_procesos.html">Parte III: GestiÃ³n de procesos</a>
<ul class="sectlevel1">
<li><a href="procesos.html">9. Procesos</a>
</li>
<li><a href="comunicaciÃ³n_mediante_paso_de_mensajes.html">10. ComunicaciÃ³n mediante paso de mensajes</a>
</li>
<li><a href="memoria_compartida.html">11. Memoria compartida</a>
</li>
<li><a href="hilos.html"><span class="toc-current">12. Hilos</span></a>
<ul class="sectlevel2">
<li><a href="hilos.html#_introducciÃ³n">12.1. IntroducciÃ³n</a>
</li>
<li><a href="hilos.html#_beneficios">12.2. Beneficios</a>
</li>
<li><a href="hilos.html#_soporte_multihilo">12.3. Soporte multihilo</a>
</li>
<li><a href="hilos.html#_modelos_multihilo">12.4. Modelos multihilo</a>
</li>
<li><a href="hilos.html#_operaciones_sobre_los_hilos">12.5. Operaciones sobre los hilos</a>
</li>
<li><a href="hilos.html#_otras_consideraciones_sobre_los_hilos">12.6. Otras consideraciones sobre los hilos</a>
</li>
</ul>
</li>
<li><a href="sincronizaciÃ³n.html">13. SincronizaciÃ³n</a>
</li>
<li><a href="planificaciÃ³n_de_la_cpu.html">14. PlanificaciÃ³n de la CPU</a>
</li>
</ul>
</li>
<li><a href="gestiÃ³n_de_la_memoria.html">Parte IV: GestiÃ³n de la memoria</a>
</li>
<li><a href="gestiÃ³n_del_almacenamiento.html">Parte V: GestiÃ³n del almacenamiento</a>
</li>
<li><a href="bibliografÃ­a.html">BibliografÃ­a</a>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="hilos"><a class="anchor" href="#hilos"></a>12. Hilos</h2>
<div class="sectionbody">
<div class="admonitionblock time">
<table>
<tr>
<td class="icon">
<i class="fa icon-time" title=""></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>Tiempo de lectura:</strong> 36 minutos</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>En el modelo de proceso que hemos descrito hasta el momento, cada proceso tiene una Ãºnica secuencia de instrucciones que se ejecuta en la CPU.
Si los procesos solo pueden tener una Ãºnica secuencia de instrucciones, solo pueden realizar una tarea a la vez.
Por ejemplo, en un procesador de textos en un sistema operativo con este modelo de procesos, el usuario nunca podrÃ­a escribir al mismo tiempo que se comprueba la ortografÃ­a.
Si queremos hacer varias tareas al mismo tiempo, estamos obligados a crear varios procesos y seleccionar un mecanismo de comunicaciÃ³n para que estos colaboren.</p>
</div>
<div class="paragraph">
<p>Por eso muchos sistemas operativos modernos han extendido el concepto de proceso para permitir que cada uno tenga mÃºltiples secuencias de instrucciones para ejecutarse en la CPU.
A cada una de estas secuencias de instrucciones se las conoce como <strong>hilo</strong> de ejecuciÃ³n.
Los procesos con varios hilos pueden realizar varias tareas a la vez.</p>
</div>
<div class="sect2">
<h3 id="_introducciÃ³n"><a class="anchor" href="#_introducciÃ³n"></a>12.1. IntroducciÃ³n</h3>
<div class="paragraph">
<p>Desde que introducimos el concepto de <strong>proceso</strong> hemos considerado que es la unidad bÃ¡sica de uso de la CPU.
Es decir, que la CPU se asignaba a los procesos, que la usaban para ejecutar sus instrucciones.
Sin embargo, en los <strong>sistemas operativos multihilo</strong> es el <strong>hilo</strong> la unidad bÃ¡sica de uso de la CPU.</p>
</div>
<div id="fig-multihilo" class="imageblock">
<div class="content">
<img src="media/C12-hilos/procesos_multihilo.svg" alt="procesos multihilo">
</div>
<div class="title">Figura 37. ComparaciÃ³n entre procesos monohilo y proceso multihilo.</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>Cada hilo tiene una serie de recursos propios dentro del proceso (vÃ©ase la <a href="hilos.html#fig-multihilo">Figura 37</a>):</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>El identificador del hilo</strong> es Ãºnico para cada hilo y sirve para identificarlos, de la misma manera que lo hace el identificador de proceso con cada proceso.</p>
</li>
<li>
<p><strong>El contador de programa</strong> es el registro de la CPU que indica la direcciÃ³n de la prÃ³xima instrucciÃ³n del hilo que debe ser ejecutada por la CPU.</p>
</li>
<li>
<p><strong>Los registros de la CPU</strong>, cuyos valores son diferentes en cada hilo, puesto que, aunque todos los hilos ejecutan el mismo programa, pueden ejecutar diferentes partes del mismo.</p>
</li>
<li>
<p><strong>La pila</strong> contiene datos temporales como argumentos y direcciones de retorno de las funciones y variables locales.
Al igual que ocurre con los registros de la CPU, cada hilo necesita su pila porque recorre el programa de manera diferente.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Sin embargo hay otros recursos que se asignan al proceso, por lo que se comparten entre todos los hilos del mismo (vÃ©ase la <a href="hilos.html#fig-multihilo">Figura 37</a>):</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>El cÃ³digo del programa</strong>.
El programa es el mismo para todos los hilos.</p>
</li>
<li>
<p><strong>Los segmentos BSS y de datos y el montÃ³n</strong>.
Las secciones de datos diferentes de la pila son accesibles a todos los hilos.
Eso quiere decir, por ejemplo, que cualquier hilo puede acceder y modificar una variable global o una asignada dinÃ¡micamente mediante <a href="https://en.cppreference.com/w/c/memory/malloc">malloc()</a> o <a href="https://en.cppreference.com/w/cpp/language/new">new</a>.</p>
</li>
<li>
<p><strong>Otros recursos del proceso</strong> como archivos, <em>sockets</em>, tuberÃ­as y dispositivos abiertos, regiones de memoria compartida, seÃ±ales, directorio actual de trabajo, entre muchos otros recursos.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>Esto significa que cada instante, en cada CPU del sistema se puede estar ejecutando un hilo, del mismo o de distintos procesos en el sistema; pero la memoria, los archivos y otros recursos pertenecen al proceso del que cada uno forma parte.
Si un hilo reserva memoria o abre un archivo o un dispositivo y no lo libera antes de terminar, el recurso permanecerÃ¡ reservado, no siendo liberado hasta que lo haga otro hilo o el proceso completo termine.
Si un hilo ejecuta una instrucciÃ³n privilegiada o intenta acceder a una zona de memoria para la que no tiene permiso, la condiciÃ³n de error se propaga a todo el proceso.
Por tanto, por lo general, el sistema operativo detendrÃ¡ el proceso completo del que formaba parte.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Nota"></i>
</td>
<td class="content">
Si se quiere ejecutar varias tareas al mismo tiempo de forma que la fiabilidad sea mÃ¡xima, haciendo que los errores en unas no puedan afectar a las otras, tendremos que olvidarnos de los hilos.
Debemos utilizar diferentes procesos para cada tarea.
AsÃ­ cada tarea tiene sus propios recursos y su propio espacio de direcciones virtual, lo que aÃ­sla a unas tareas de las otras.
</td>
</tr>
</table>
</div>
<div id="fig-proceso-multihilo-en-memoria" class="imageblock">
<div class="content">
<img src="media/C12-hilos/proceso_multihilo_en_memoria.svg" alt="proceso multihilo en memoria">
</div>
<div class="title">Figura 38. AnatomÃ­a de un proceso multihilo en memoria.</div>
</div>
<div class="paragraph">
<p>En la <a href="hilos.html#fig-proceso-multihilo-en-memoria">Figura 38</a> se puede observar como cambia la disposiciÃ³n de los elementos de un proceso en la memoria cuando es multihilo, respecto a lo que vimos en el <a href="procesos.html#_el_proceso">Apartado 9.1</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_beneficios"><a class="anchor" href="#_beneficios"></a>12.2. Beneficios</h3>
<div class="paragraph">
<p>Son muchos los beneficios que aporta la programaciÃ³n multihilo:</p>
</div>
<div class="sect3">
<h4 id="_tiempo_de_respuesta"><a class="anchor" href="#_tiempo_de_respuesta"></a>12.2.1. Tiempo de respuesta</h4>
<div class="paragraph">
<p>Una aplicaciÃ³n multihilo interactiva puede continuar ejecutando tareas aunque uno o varios hilos de la misma estÃ©n bloqueados o realizando operaciones muy lentamente, mejorando asÃ­ el tiempo de respuesta al usuario.</p>
</div>
<div class="paragraph">
<p>Por ejemplo, un navegador web multihilo puede gestionar la interacciÃ³n del usuario a travÃ©s de un hilo, mientras el contenido solicitado se descarga en otro.
Para hacer lo mismo en un navegador monohilo habrÃ­a que utilizar comunicaciones asÃ­ncronas, de lo contrario, mientras el proceso estÃ¡ en estado <strong>esperando</strong>, a la espera de que lleguen los datos a travÃ©s de la red, no puede atender las acciones del usuario.</p>
</div>
</div>
<div class="sect3">
<h4 id="_comparticiÃ³n_de_recursos"><a class="anchor" href="#_comparticiÃ³n_de_recursos"></a>12.2.2. ComparticiÃ³n de recursos</h4>
<div class="paragraph">
<p>En sistemas operativos monohilo se pueden crear varios procesos y comunicarlos mediante memoria compartida para conseguir algo similar a lo que ofrecen los sistemas multihilo.
Sin embargo, al utilizar hilos, las tareas ejecutadas en ellos comparten los recursos automÃ¡ticamente, sin que tengamos que hacer nada.
AdemÃ¡s, los hilos no solo comparten la memoria, sino tambiÃ©n otros muchos recursos del proceso.
Por lo que los hilos son una forma mÃ¡s conveniente de tener procesos que realizan diferentes actividades al mismo tiempo.</p>
</div>
</div>
<div class="sect3">
<h4 id="_economÃ­a"><a class="anchor" href="#_economÃ­a"></a>12.2.3. EconomÃ­a</h4>
<div class="paragraph">
<p>Reservar memoria y otros recursos para la creaciÃ³n de un proceso es muy costoso.
Por eso los sistemas operativos modernos han desarrollado diversas tÃ©cnicas para que sea lo mÃ¡s eficaz posible.</p>
</div>
<div class="paragraph">
<p>Aun asÃ­, puesto que los hilos comparten los recursos de los procesos a los que pertenecen, son mucho mÃ¡s econÃ³micos de crear.
TambiÃ©n es mÃ¡s econÃ³mico el cambio de contexto entre ellos, ya que hay que guardar y recuperar menos informaciÃ³n al cambiar entre dos hilos de un mismo proceso.</p>
</div>
<div class="paragraph">
<p>Por ejemplo, en Microsoft Windows crear un proceso puede ser 300 veces mÃ¡s costoso que un hilo. Mientras que en sistemas Linux es 3 veces mÃ¡s lento, por la eficiencia de <a href="https://man7.org/linux/man-pages/man2/fork.2.html">fork()</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_aprovechamiento_de_las_arquitecturas_multiprocesador"><a class="anchor" href="#_aprovechamiento_de_las_arquitecturas_multiprocesador"></a>12.2.4. Aprovechamiento de las arquitecturas multiprocesador.</h4>
<div class="paragraph">
<p>En los sistemas multiprocesador diferentes hilos pueden ejecutarse en paralelo en distintos procesadores.
Por el contrario, un proceso monohilo solo se puede ejecutar en una CPU a la vez, independientemente de cuantas CPU estÃ©n disponibles para ejecutarlo.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_soporte_multihilo"><a class="anchor" href="#_soporte_multihilo"></a>12.3. Soporte multihilo</h3>
<div class="paragraph">
<p>Las <strong>librerÃ­as de hilos</strong> proporcionan al programador la interfaz de programaciÃ³n para crear y gestionar los hilos de su proceso.
Hay dos formas de implementar una librerÃ­a de hilos: en el espacio de usuario o en el nÃºcleo.</p>
</div>
<div class="sect3">
<h4 id="_librerÃ­a_de_hilos_en_el_espacio_de_usuario"><a class="anchor" href="#_librerÃ­a_de_hilos_en_el_espacio_de_usuario"></a>12.3.1. LibrerÃ­a de hilos en el espacio de usuario</h4>
<div class="paragraph">
<p>La librerÃ­a de hilos se puede implementar en el espacio de usuario, junto al cÃ³digo y los datos del proceso, sin requerir ningÃºn soporte especial por parte del nÃºcleo.</p>
</div>
<div class="paragraph">
<p>Estos hilos no existen para el nÃºcleo del sistema operativo, solo para el proceso que los ha creado.
Por ese motivo se los denomina <strong>hilos de usuario</strong> o <strong>hilos del nivel de usuario</strong>.</p>
</div>
<div class="paragraph">
<p>Como el cÃ³digo y los datos de la librerÃ­a residen en el espacio de usuario, invocar una funciÃ³n de la misma se reduce a una simple llamada a una funciÃ³n, evitando el coste de hacer llamadas al sistema.</p>
</div>
</div>
<div class="sect3">
<h4 id="_librerÃ­a_de_hilos_en_el_nÃºcleo"><a class="anchor" href="#_librerÃ­a_de_hilos_en_el_nÃºcleo"></a>12.3.2. LibrerÃ­a de hilos en el nÃºcleo</h4>
<div class="paragraph">
<p>Si la librerÃ­a de hilos se implementa en el nÃºcleo, es el nÃºcleo del sistema el que se encarga de darles soporte.
Por ese motivo se los denomina <strong>hilos de nÃºcleo</strong> o <strong>hilos del nivel de nÃºcleo</strong>.</p>
</div>
<div class="paragraph">
<p>Aparte del <strong>PCB</strong> que vimos en el <a href="procesos.html#_bloque_de_control_de_proceso">Apartado 9.3</a>, cada hilo tiene una estructura llamada <strong>bloque de control del hilo</strong> o TCB (<em>Thread Control Block</em>) que representa a cada hilo en el sistema operativo y que guarda informaciÃ³n sobre su estado de actividad actual.</p>
</div>
<div class="paragraph">
<p>En estos sistemas, es el hilo la unidad bÃ¡sica de uso de la CPU.
Son los hilos los que se mueven por los estados del <a href="procesos.html#fig-diagrama-estado-proceso">Figura 28</a> y las colas de la <a href="procesos.html#fig-colas-de-planificaciÃ³n-procesos">Figura 29</a> y no los procesos.
El planificador de la CPU selecciona un hilo para ejecutarse en la CPU de entre todos los que estÃ¡n en el estado <strong>preparado</strong> en el sistema y el <strong>cambio de contexto</strong> asigna la CPU a un hilo distinto al que la tiene asignada en el momento actual.</p>
</div>
<div class="paragraph">
<p>Por tanto, es en <strong>TCB</strong> ây no en el <strong>PCB</strong>â donde se guarda la informaciÃ³n privada del hilo necesaria para la gestiÃ³n de los estados y para el cambio de contexto, como: los valores de los registros de la CPU y el contador de programa, el estado o la informaciÃ³n de planificaciÃ³n de la CPU; ademÃ¡s de un puntero al <strong>PCB</strong> al que pertenece el hilo con el resto de la informaciÃ³n privada del proceso.</p>
</div>
<div class="paragraph">
<p>Como el cÃ³digo y los datos de la librerÃ­a residen en el espacio del nÃºcleo, invocar una funciÃ³n de la misma requiere frecuentemente hacer una llamada al sistema.
Obviamente, la librerÃ­a del sistema ofrece funciones para no tener que hacer la llamada al sistema directamente.</p>
</div>
<div class="paragraph">
<p>En la actualidad, en los diferentes sistemas operativos se pueden encontrar librerÃ­as de ambos tipos.
Por ejemplo, la librerÃ­a de hilos de Windows API se implementa en el nÃºcleo (vÃ©ase <a href="https://docs.microsoft.com/en-us/windows/win32/procthread/using-processes-and-threads">Â«Using Processes and Threads&#8201;&#8212;&#8201;Microsoft DocsÂ»</a>) mientras que la librerÃ­a de hilos <a href="https://man7.org/linux/man-pages/man7/pthreads.7.html">POSIX Threads</a> âfrecuentemente utilizada en los sistemas POSIXâ puede ser de ambos tipos, dependiendo solamente del sistema donde se implemente. En Linux y en la mayor parte de los UNIX modernos, POSIX Threads se implementa en el nÃºcleo del sistema.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_modelos_multihilo"><a class="anchor" href="#_modelos_multihilo"></a>12.4. Modelos multihilo</h3>
<div class="paragraph">
<p>Las distintas formas de implementar los hilos comentadas anteriormente âen espacio de usuario o en el nÃºcleoâ no son excluyentes, ya que en un sistema operativo concreto se pueden implementar ambas, una de las dos o ninguna.</p>
</div>
<div class="paragraph">
<p>A continuaciÃ³n veremos los modelos a los que han dado lugar las distintas combinaciones.</p>
</div>
<div class="sect3">
<h4 id="_muchos_a_uno"><a class="anchor" href="#_muchos_a_uno"></a>12.4.1. Muchos a uno</h4>
<div class="paragraph">
<p>
En el modelo <strong>muchos a uno</strong> los hilos que ve el proceso se mapean en una Ãºnica Â«entidad planificable en la CPUÂ» del nÃºcleo.</p>
</div>
<div class="paragraph">
<p>Este, por lo general, es el modelo utilizado cuando el nÃºcleo no soporta mÃºltiples hilos de ejecuciÃ³n.
En ese caso, la Ãºnica entidad planificable en la CPU que conoce el nÃºcleo es el proceso, la librerÃ­a de hilos se implementa en el espacio de usuario âdentro del procesoâ y los hilos que ve el proceso son <strong>hilos de usuario</strong> (vÃ©ase la <a href="hilos.html#fig-modelo-muchos-a-uno">Figura 39</a>).</p>
</div>
<div id="fig-modelo-muchos-a-uno" class="imageblock">
<div class="content">
<img src="media/C12-hilos/modelo_muchos_a_uno.svg" alt="modelo muchos a uno">
</div>
<div class="title">Figura 39. Modelo muchos a uno.</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>Las principales caracterÃ­sticas de este modelo son:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>La gestiÃ³n de hilos se hace con una librerÃ­a en el espacio de usuario, por lo que los hilos se pueden crear de forma rÃ¡pida y con poco coste.
Como hemos visto anteriormente, la invocaciÃ³n de las funciones de la librerÃ­a se hace por medio de simples llamadas a funciones.</p>
</li>
<li>
<p>Si uno de los hilos solicita al sistema operativo una operaciÃ³n que deba ser bloqueada a la espera âpor ejemplo, operaciones de E/S sobre archivos, comunicaciones o esperar a que otro proceso termineâ todo el proceso es bloqueado, no pudiendo ejecutarse otros hilos del mismo proceso mientras tanto.
Eso significa que si nuestros hilos hacen ese tipo de operaciones, el resultado es como si no tuviÃ©ramos hilos.</p>
</li>
<li>
<p>Como solo un hilo puede ser asignado al proceso, los hilos de un mismo proceso no se pueden ejecutar en paralelo en sistemas multiprocesador.
El planificador de la librerÃ­a de hilos es el encargado de determinar quÃ© hilo de usuario es asignado al proceso y este solo puede ejecutarse en una Ãºnica CPU al mismo tiempo.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>El problema del bloqueo de procesos puede ser evitado interceptando las llamadas a funciones de la librerÃ­a del sistema, para evitar el uso de llamadas al sistema que se puedan bloquear y sustituirlas por versiones equivalentes pero asÃ­ncronas.</p>
</div>
<div class="paragraph">
<p>Por ejemplo, si un hilo llamase a las funciones <a href="https://man7.org/linux/man-pages/man2/recv.2.html">recv()</a> o <a href="https://man7.org/linux/man-pages/man2/send.2.html">send()</a> de la librerÃ­a del sistema, habrÃ­a que hacer que realmente se invocase una versiÃ³n diferente que utilizase estas funciones de forma asÃ­ncrona.
Mientras la operaciÃ³n es ejecutada por el sistema operativo, en lugar de retornar de la funciÃ³n, se llama al planificador de la librerÃ­a de hilos para que la ejecuciÃ³n continÃºe con otro hilo del proceso, dejando suspendido el que tiene pendiente la operaciÃ³n.
Obviamente, el planificador de la librerÃ­a de hilos debe estar al tanto de cuÃ¡ndo las operaciones asÃ­ncronas son completadas para poder volver a planificar los <strong>hilos de usuario</strong> suspendidos.</p>
</div>
<div class="paragraph">
<p>Este procedimiento es a todas luces bastante complejo y requiere versiones no bloqueantes de todas las llamadas al sistema âque no siempre existenâ asÃ­ como modificar o interceptar de alguna forma las funciones bloqueantes de la librerÃ­a del sistema para implementar el comportamiento descrito.</p>
</div>
<div class="sect4">
<h5 id="_implementaciones"><a class="anchor" href="#_implementaciones"></a>Implementaciones</h5>
<div class="paragraph">
<p>A este modelo de hilos frecuentemente se lo llama <a href="https://en.wikipedia.org/wiki/Green_threads">Green Threads</a>.
En Java 1.1 era el Ãºnico modelo soportado, pero debido a sus limitaciones se implementÃ³ el soporte del modelo <strong>uno a uno</strong> en versiones posteriores.</p>
</div>
<div class="paragraph">
<p>Otras implementaciones de este modelo son las <a href="https://docs.microsoft.com/en-us/windows/win32/procthread/fibers">fibras</a> de Windows API, <a href="http://www.stackless.com/">Stackless Python</a> y <a href="http://www.gnu.org/software/pth/">GNU Portable Threads</a>.
Estas implementaciones son muy Ãºtiles en los sistemas monohilo, de cara a poder ofrecer cierto soporte de hilos a las aplicaciones.
Pero tambiÃ©n lo son en los sistemas multihilo, ya que debido a su bajo coste en recursos y a su alta eficiencia son ideales cuando la cantidad de hilos a crear âel nivel de concurrenciaâ va a ser previsiblemente muy alta.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_uno_a_uno"><a class="anchor" href="#_uno_a_uno"></a>12.4.2. Uno a uno</h4>
<div class="paragraph">
<p></p>
</div>
<div class="paragraph">
<p>En el modelo <strong>uno a uno</strong> cada hilo que ve el proceso se mapea en una Â«entidad planificable en la CPUÂ» diferente del nÃºcleo.</p>
</div>
<div class="paragraph">
<p>Este, por lo general, es el modelo utilizado cuando el nÃºcleo del sistema operativo soporta hilos de ejecuciÃ³n.
En este caso, la librerÃ­a de hilos se implementa en el nÃºcleo, por lo que las entidades que planifica el nÃºcleo en la CPU son los <strong>hilos de nÃºcleo</strong> y los procesos pueden gestionar estos hilos mediante llamadas al sistema.</p>
</div>
<div id="fig-modelo-uno-a-uno" class="imageblock">
<div class="content">
<img src="media/C12-hilos/modelo_uno_a_uno.svg" alt="modelo uno a uno">
</div>
<div class="title">Figura 40. Modelo uno a uno.</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>Las principales caracterÃ­sticas de este modelo son:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Permite a otros hilos del mismo proceso ejecutarse aun cuando uno de ellos haga una llamada al sistema que debe bloquearse.
El nÃºcleo se encarga de ponerlo en espera y planificar en la CPU a otro de los hilos preparados para ejecutarse de entre todos los existentes en el sistema.</p>
</li>
<li>
<p>Permite paralelismo en sistemas multiprocesador, ya que diferentes hilos pueden ser planificados por el nÃºcleo en distintos procesadores.</p>
</li>
<li>
<p>Crear un hilo para un proceso implica crear ciertas estructuras de datos en el nÃºcleo.
Debido a que la cantidad de memoria disponible para el nÃºcleo suele estar limitada, muchos sistemas restringen la cantidad mÃ¡xima de <strong>hilos de nÃºcleo</strong> soportados.</p>
</li>
<li>
<p>La gestiÃ³n de los hilos se hace con una librerÃ­a en el espacio de nÃºcleo, lo que requiere que el proceso haga llamadas al sistema para gestionarlos.
Esto siempre es mÃ¡s lento que invocar simplemente una funciÃ³n, como ocurre en el modelo <strong>muchos a uno</strong>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>Este modelo se utiliza en la mayor parte de los sistemas operativos multihilo modernos.
Linux, Microsoft Windows âdesde Windows 95â <a href="https://es.wikipedia.org/wiki/Solaris_(sistema_operativo)">Solaris</a> 9 y superiores, macOS y la familia de UNIX BSD; son ejemplos de sistemas operativos que utiliza el modelo <strong>uno a uno</strong>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_muchos_a_muchos"><a class="anchor" href="#_muchos_a_muchos"></a>12.4.3. Muchos a muchos</h4>
<div class="paragraph">
<p>
En teorÃ­a deberÃ­a ser posible aprovechar lo mejor de los dos modelos anteriores con una librerÃ­a de hilos en el nÃºcleo, para crear <strong>hilos de nÃºcleo</strong>, y otra en el espacio de usuario, para crear <strong>hilos de usuario</strong>.
AsÃ­ los desarrolladores pueden utilizar la librerÃ­a de hilos en el espacio de usuario para crear tantos hilos como quieran y que se ejecuten sobre los <strong>hilos de nÃºcleo</strong>.</p>
</div>
<div class="paragraph">
<p>El planificador de la librerÃ­a de hilos se encarga de determinar quÃ© hilo de usuario es asignado a quÃ© hilo de nÃºcleo.
Mientras que el planificador de la CPU asigna la CPU a alguno de los <strong>hilos de nÃºcleo</strong> del sistema.</p>
</div>
<div id="fig-modelo-muchos-a-muchos" class="imageblock">
<div class="content">
<img src="media/C12-hilos/modelo_muchos_a_muchos.svg" alt="modelo muchos a muchos">
</div>
<div class="title">Figura 41. Modelo muchos a muchos.</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>En el modelo <strong>muchos a muchos</strong> se mapean los <strong>hilos de usuario</strong> en un menor o igual nÃºmero de <strong>hilos de nÃºcleo</strong> del proceso (vÃ©ase la <a href="hilos.html#fig-modelo-muchos-a-muchos">Figura 41</a>).</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Permite paralelismo en sistemas multiprocesador, ya que diferentes <strong>hilos de nÃºcleo</strong> pueden ser planificados en distintos procesadores y en cada uno puede ejecutarse cualquier hilo de usuario.</p>
</li>
<li>
<p>Permite a otro hilo de usuario del mismo proceso ejecutarse cuando un hilo hace una llamada al sistema que debe bloquearse, puesto que si esto ocurre el correspondiente hilo de nÃºcleo se queda bloqueado.
Sin embargo, el resto de los <strong>hilos de usuario</strong> pueden seguir ejecutÃ¡ndose en los otros <strong>hilos de nÃºcleo</strong> del proceso.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>Este modelo se soportaba en sistemas <a href="https://es.wikipedia.org/wiki/FreeBSD">FreeBSD</a> y versiones antiguas de <a href="https://es.wikipedia.org/wiki/NetBSD">NetBSD</a>, asÃ­ como en UNIX comerciales, como: <a href="https://es.wikipedia.org/wiki/Solaris_(sistema_operativo)">Solaris</a> 8 y anteriores, <a href="https://es.wikipedia.org/wiki/IRIX">IRIX</a>, <a href="https://es.wikipedia.org/wiki/HP-UX">HP-UX</a> y <a href="https://es.wikipedia.org/wiki/Tru64">Tru64 UNIX</a>.
TambiÃ©n Microsoft Windows âa partir de Windows 7â soporta este modelo gracias a incorporar un mecanismo denominado planificaciÃ³n en modo usuario (vÃ©ase <a href="https://docs.microsoft.com/en-us/windows/win32/procthread/user-mode-scheduling">Â«User-Mode Scheduling&#8201;&#8212;&#8201;Microsoft DocsÂ»</a>).</p>
</div>
<div class="paragraph">
<p>Algunos lenguajes de programaciÃ³n implementan el modelo <strong>muchos a muchos</strong> sobre el modelo <strong>uno a uno</strong> soportado por la mayorÃ­a de sistemas operativos modernos.
Ese es el caso de <a href="https://es.wikipedia.org/wiki/Go_(lenguaje_de_programaci%C3%B3n)">Go</a>, <a href="https://es.wikipedia.org/wiki/Erlang">Erlang</a> y <a href="https://es.wikipedia.org/wiki/Elixir_(lenguaje_de_programaci%C3%B3n)">Elixir</a>.</p>
</div>
<div class="sect4">
<h5 id="_activaciÃ³n_del_planificador"><a class="anchor" href="#_activaciÃ³n_del_planificador"></a>ActivaciÃ³n del planificador</h5>
<div class="paragraph">
<p>Tanto en el modelo <strong>muchos a muchos</strong> como en el de <strong>dos niveles</strong> es necesario cierto grado de coordinaciÃ³n entre el nÃºcleo y la librerÃ­a de hilos del espacio de usuario.
Dicha comunicaciÃ³n tiene como objeto ajustar dinÃ¡micamente el nÃºmero de <strong>hilos de nÃºcleo</strong> para garantizar la mÃ¡xima eficiencia.</p>
</div>
<div class="paragraph">
<p>Uno de los esquemas de comunicaciÃ³n se denomina <strong>activaciÃ³n del planificador</strong> y consiste en que el nÃºcleo informa a la librerÃ­a de hilos en espacio de usuario que una llamada al sistema va a bloquear un hilo de un proceso.
Antes de dicha notificaciÃ³n, el nÃºcleo se encarga de crear un nuevo hilo de nÃºcleo en el proceso y se lo pasa a la librerÃ­a de hilos en la notificaciÃ³n.
AsÃ­, el planificador de la librerÃ­a puede asignarle alguno de los otros <strong>hilos de usuario</strong>, evitando el bloqueo completo del proceso y ajustando el nÃºmero de <strong>hilos de nÃºcleo</strong> dinÃ¡micamente.</p>
</div>
<div class="paragraph">
<p>Debido a la complejidad del mecanismo descrito anteriormente y a la dificultad de coordinar el planificador de la librerÃ­a de hilos con el de la CPU para obtener un rendimiento Ã³ptimo, sistemas como Linux y <a href="https://es.wikipedia.org/wiki/Solaris_(sistema_operativo)">Solaris</a> âa partir de la versiÃ³n 9â han optado finalmente por el modelo <strong>uno a uno</strong>.</p>
</div>
<div class="paragraph">
<p>Con el objetivo de evitar los problemas derivados del coste de dicho modelo, los desarrolladores de Linux han preferido concentrar sus esfuerzos en conseguir un planificador de CPU mÃ¡s eficiente, asÃ­ como en reducir los costes de la creaciÃ³n de <strong>hilos de nÃºcleo</strong>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_dos_niveles"><a class="anchor" href="#_dos_niveles"></a>12.4.4. Dos niveles</h4>
<div class="paragraph">
<p>Existe una variaciÃ³n del modelo <strong>muchos a muchos</strong> donde, ademÃ¡s de funcionar de la forma comentada anteriormente, se permite que un hilo de usuario quede ligado indefinidamente a un Ãºnico hilo de nÃºcleo, como en el modelo <strong>uno a uno</strong>.</p>
</div>
<div class="paragraph">
<p>Esta variaciÃ³n se denomina, en ocasiones, modelo de <strong>dos niveles</strong> (vÃ©ase la <a href="hilos.html#fig-modelo-de-dos-niveles">Figura 42</a>).</p>
</div>
<div id="fig-modelo-de-dos-niveles" class="imageblock">
<div class="content">
<img src="media/C12-hilos/modelo_de_dos_niveles.svg" alt="modelo de dos niveles">
</div>
<div class="title">Figura 42. Modelo muchos a uno.</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_operaciones_sobre_los_hilos"><a class="anchor" href="#_operaciones_sobre_los_hilos"></a>12.5. Operaciones sobre los hilos</h3>
<div class="paragraph">
<p>Como ocurre con los procesos, es necesario que los hilos pueden ser creados y eliminados dinÃ¡micamente, por lo que los sistemas operativos deben proporcionar servicios para la creaciÃ³n y cancelaciÃ³n de los mismos.</p>
</div>
<div class="sect3">
<h4 id="_creaciÃ³n_de_hilos"><a class="anchor" href="#_creaciÃ³n_de_hilos"></a>12.5.1. CreaciÃ³n de hilos</h4>
<div class="paragraph">
<p>En un sistema operativo con librerÃ­a de hilos implementada en el nÃºcleo, todo proceso se crea con un hilo, denominado <strong>hilo principal</strong>.
Este es con el que comienza a ejecutarse el programa al entrar en <a href="https://en.cppreference.com/w/c/language/main_function">main()</a> y el que provoca la terminaciÃ³n de todo el proceso âincluida la terminaciÃ³n de los otros hilos que existanâ al retornar de dicha funciÃ³n.</p>
</div>
<div class="paragraph">
<p>El <strong>hilo principal</strong> puede crear otros hilos y estos, a su vez, crear los hilos que necesiten.
Pero, a diferencia de lo que ocurre con los procesos, no existe una relaciÃ³n de padres a hijos ni se crea un Ã¡rbol de hilos.
Excepto por la caracterÃ­stica especial del <strong>hilo principal</strong> de que su finalizaciÃ³n significa la terminaciÃ³n del proceso, todos los hilos son iguales entre sÃ­.</p>
</div>
<div class="paragraph">
<p>En el <a href="hilos.html#ejemplo-pthread">Ejemplo 5</a> se puede ver cÃ³mo se usa <a href="https://man7.org/linux/man-pages/man3/pthread_create.3.html">pthread_create()</a> en sistemas POSIX que implementan <a href="https://man7.org/linux/man-pages/man7/pthreads.7.html">POSIX Threads</a> para crear varios hilos y esperar a que terminen con <a href="https://man7.org/linux/man-pages/man3/pthread_join.3.html">pthread_join()</a>.</p>
</div>
<div id="ejemplo-pthread" class="exampleblock">
<div class="title">Ejemplo 5. Calcular el factorial de un nÃºmero con <a href="https://man7.org/linux/man-pages/man7/pthreads.7.html">POSIX Threads</a>.</div>
<div class="content">
<div class="paragraph">
<p>Vamos a calcular el factorial de 122 repartiendo la tarea entre dos hilos con el objeto de paralelizar los cÃ¡lculos en procesadores multinÃºcleo.</p>
</div>
<div class="paragraph">
<p>El cÃ³digo fuente completo de este ejemplo estÃ¡ disponible en <a href="https://github.com/ull-esit-sistemas-operativos/ssoo-ejemplos/blob/ocw/src/cap12/pthreads.cpp">pthreads.cpp</a> y, ademÃ¡s, permite indicar el nÃºmero que queramos para calcular el factorial.
En <a href="https://github.com/ull-esit-sistemas-operativos/ssoo-ejemplos/blob/ocw/src/cap12/threads.cpp">threads.cpp</a> se puede estudiar un ejemplo equivalente, pero usando <a href="https://en.cppreference.com/w/cpp/thread/thread">std::thread</a> de la librerÃ­a estÃ¡ndar de C&#43;&#43;, por lo que tambiÃ©n compila en sistemas no POSIX, como Microsoft Windows.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="cpp"><span class="k">struct</span> <span class="nc">factorial_thread_args</span> <i class="conum" data-value="9"></i><b>(9)</b>
<span class="p">{</span>
    <span class="n">BigInt</span> <span class="n">number</span><span class="p">;</span>
    <span class="n">BigInt</span> <span class="n">lower_bound</span><span class="p">;</span>
    <span class="n">BigInt</span> <span class="n">result</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">void</span><span class="o">*</span> <span class="n">factorial_thread</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">arg</span><span class="p">)</span>   <i class="conum" data-value="7"></i><b>(7)</b> <i class="conum" data-value="8"></i><b>(8)</b> <i class="conum" data-value="9"></i><b>(9)</b>
<span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">fmt</span><span class="o">::</span><span class="n">format</span><span class="p">(</span> <span class="s">"Hilo creado: 0x{:x}</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">pthread_self</span><span class="p">()</span> <span class="p">);</span>    <i class="conum" data-value="10"></i><b>(10)</b>

    <span class="n">factorial_thread_args</span><span class="o">*</span> <span class="n">args</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">factorial_thread_args</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span> <i class="conum" data-value="9"></i><b>(9)</b>
    <span class="n">args</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">calculate_factorial</span><span class="p">(</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">lower_bound</span> <span class="p">);</span>

    <span class="k">return</span> <span class="o">&amp;</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">;</span> <i class="conum" data-value="12"></i><b>(12)</b>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">return_code</span><span class="p">;</span>
    <span class="n">pthread_t</span> <span class="n">thread1</span><span class="p">,</span> <span class="n">thread2</span><span class="p">;</span>  <i class="conum" data-value="1"></i><b>(1)</b> <i class="conum" data-value="2"></i><b>(2)</b>

    <span class="n">factorial_thread_args</span> <span class="n">thread1_args</span> <span class="p">{</span>
        <span class="mi">122</span><span class="p">,</span>    <span class="c1">// El primer hilo calcula el factorial multiplicando</span>
        <span class="mi">61</span><span class="p">,</span>     <span class="c1">// desde 122 a 61.</span>
        <span class="mi">0</span>
    <span class="p">};</span>

    <span class="n">factorial_thread_args</span> <span class="n">thread2_args</span> <span class="p">{</span>
        <span class="mi">60</span><span class="p">,</span>     <span class="c1">// El segundo hilo calcula el factorial multiplicando</span>
        <span class="mi">2</span><span class="p">,</span>      <span class="c1">// desde 60 a 2</span>
        <span class="mi">0</span>
    <span class="p">};</span>

    <span class="kt">int</span> <span class="n">return_code</span> <span class="o">=</span> <span class="n">pthread_create</span><span class="p">(</span> <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="o">&amp;</span><span class="n">thread1</span><span class="p">,</span>           <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="nb">nullptr</span><span class="p">,</span>            <i class="conum" data-value="6"></i><b>(6)</b>
        <span class="n">factoria_thread</span><span class="p">,</span>    <i class="conum" data-value="7"></i><b>(7)</b>
        <span class="o">&amp;</span><span class="n">thread_args</span> <span class="p">);</span>      <i class="conum" data-value="8"></i><b>(8)</b> <i class="conum" data-value="9"></i><b>(9)</b>

    <span class="k">if</span> <span class="p">(</span><span class="n">return_code</span><span class="p">)</span> <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="n">fmt</span><span class="o">::</span><span class="n">format</span><span class="p">(</span> <span class="s">"Error ({}) al crear el hilo: {}</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
            <span class="n">return_code</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">return_code</span><span class="p">)</span> <span class="p">);</span> <i class="conum" data-value="5"></i><b>(5)</b>
        <span class="k">return</span> <span class="n">EXIT_FAILURE</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">return_code</span> <span class="o">=</span> <span class="n">pthread_create</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">thread2</span><span class="p">,</span> <span class="cm">/* ... */</span> <span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">return_code</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// ...</span>
    <span class="p">}</span>

    <span class="n">BigInt</span><span class="o">*</span> <span class="n">thread1_result</span><span class="p">,</span> <span class="o">*</span><span class="n">thread2_result</span><span class="p">;</span>
    <span class="n">pthread_join</span><span class="p">(</span> <i class="conum" data-value="11"></i><b>(11)</b>
        <span class="n">thread1</span><span class="p">,</span>
        <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">**&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">thread1_result</span><span class="p">)</span> <span class="p">);</span> <i class="conum" data-value="13"></i><b>(13)</b>
    <span class="n">pthread_join</span><span class="p">(</span> <span class="n">thread2</span><span class="p">,</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">**&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">thread2_result</span><span class="p">)</span> <span class="p">);</span>

    <span class="c1">// Multiplicar ambos resultados para obtener el factorial</span>
    <span class="k">auto</span> <span class="n">result</span> <span class="o">=</span> <span class="o">*</span><span class="n">thread1_result</span> <span class="o">*</span> <span class="o">*</span><span class="n">thread2_result</span><span class="p">;</span>

    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">fmt</span><span class="o">::</span><span class="n">format</span><span class="p">(</span> <span class="s">"El factorial de {} es {}</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
        <span class="n">number</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span> <span class="n">result</span><span class="p">.</span><span class="n">to_string</span><span class="p">()</span> <span class="p">);</span>

    <span class="k">return</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>En <a href="https://man7.org/linux/man-pages/man7/pthreads.7.html">POSIX Threads</a> se usa <a href="https://man7.org/linux/man-pages/man3/pthread_create.3.html">pthread_create()</a> para crear hilos.
Devuelve un manejador de tipo <code>pthread_t</code> que podemos usar con otras funciones de la API para indicar el hilo que queremos gestionar.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>pthread_t</code> no es el equivalente al PID de los hilos.
Si el sistema implementa la librerÃ­a de hilos en el nÃºcleo, por lo general, cada hilo tiene un identificador Ãºnico; pero <a href="https://man7.org/linux/man-pages/man7/pthreads.7.html">POSIX Threads</a> no ofrece una forma de obtenerlo.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>La variable <code>pthread_t</code> se pasa a <a href="https://man7.org/linux/man-pages/man3/pthread_create.3.html">pthread_create()</a> como puntero para que al retornar, si todo ha ido bien, contenga el manejador del hilo.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Si el hilo se puede crear, <a href="https://man7.org/linux/man-pages/man3/pthread_create.3.html">pthread_create()</a> devuelve 0.
En caso contrario devuelve un cÃ³digo de error.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Los cÃ³digos de error son los mismos que hasta ahora veÃ­amos en <a href="https://man7.org/linux/man-pages/man3/errno.3.html">errno</a>.
AsÃ­ que podemos llamar a <a href="https://man7.org/linux/man-pages/man3/strerror.3.html">strerror()</a> pasando el valor retornado, para obtener un texto descriptivo del error.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Es opcional pasar a <a href="https://man7.org/linux/man-pages/man3/pthread_create.3.html">pthread_create()</a> una estructura con atributos tales como: tamaÃ±o y posiciÃ³n de la pila, polÃ­tica y parÃ¡metros de planificaciÃ³n, entre otros.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Todo hilo tiene una funciÃ³n principal que serÃ¡ donde comience la ejecuciÃ³n del hilo.
Cuando esa funciÃ³n termine, el hilo finalizarÃ¡.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Los hilos pueden recibir un argumento en la forma de un puntero a <code>void*</code>.
Si queremos pasar varios, lo mÃ¡s sencillo es crear una estructura.</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>En este ejemplo definimos <code>factorial_thread_args</code> para pasar los argumentos a los hilos y lo pasamos como <code>void *</code> a la funciÃ³n principal.
AllÃ­ hacemos un <em>typecast</em> para recuperar el puntero a la estructura <code>factorial_thread_args</code> y poder acceder a sus campos.</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>En cualquier momento se puede llamar a <a href="https://man7.org/linux/man-pages/man3/pthread_self.3.html">pthread_self()</a> para obtener el manejador <code>pthread_t</code> del hilo actual.</td>
</tr>
<tr>
<td><i class="conum" data-value="11"></i><b>11</b></td>
<td>El hilo que invoca <a href="https://man7.org/linux/man-pages/man3/pthread_join.3.html">pthread_join()</a> se queda dormido hasta que el hilo indicado en el primer argumento termine.
Si el hilo principal sale de <a href="https://en.cppreference.com/w/c/language/main_function">main()</a> sin esperar a que todos los hilos del proceso terminen, estos mueren inmediatamente, junto con el proceso.</td>
</tr>
<tr>
<td><i class="conum" data-value="12"></i><b>12</b></td>
<td>El hilo puede retornar un resultado mediante un puntero 'void*'.
Esto se indica en la sentencia <code>return</code> de la funciÃ³n principal del hilo o invocando <a href="https://man7.org/linux/man-pages/man3/pthread_exit.3.html">pthread_exit()</a> para terminar.</td>
</tr>
<tr>
<td><i class="conum" data-value="13"></i><b>13</b></td>
<td>La funciÃ³n <a href="https://man7.org/linux/man-pages/man3/pthread_join.3.html">pthread_join()</a> acepta un puntero a <code>void*</code> para devolver ese valor de retorno al hilo que la invoca.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Como los hilos de <a href="https://man7.org/linux/man-pages/man7/pthreads.7.html">POSIX Threads</a> devuelven punteros, es importante no intentar devolver variables locales, ya que se destruirÃ¡n cuando el hilo termine y el punto devuelto no serÃ¡ vÃ¡lido.</p>
</div>
<div class="paragraph">
<p>Una alternativa es devolver los resultados a travÃ©s de la estructura pasada como argumento.
Por ejemplo, el campo <code>result</code> de la estructura <code>factorial_thread_args</code> ofrece una manera mÃ¡s cÃ³moda de obtener el resultado del cÃ¡lculo de cada hilo.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_cancelaciÃ³n_de_hilos"><a class="anchor" href="#_cancelaciÃ³n_de_hilos"></a>12.5.2. CancelaciÃ³n de hilos</h4>
<div class="paragraph">
<p>La <strong>cancelaciÃ³n</strong> es la operaciÃ³n de terminar un hilo antes de que termine su trabajo.
Por ejemplo, en un navegador web un hilo se puede encargar de la interfaz de usuario mientras otros hilos se encargan de descargar las pÃ¡ginas y las imÃ¡genes de la misma.
Si el usuario pulsa el botÃ³n <strong>Cancelar</strong> es necesario que todos los hilos que intervienen en la descarga sean cancelados.</p>
</div>
<div class="paragraph">
<p>Esto puede ocurrir de dos maneras:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>En la <strong>cancelaciÃ³n asÃ­ncrona</strong> el hilo termina inmediatamente.
Esto puede causar problemas al no liberarse los recursos reservados en el proceso por parte del hilo
Por ejemplo, antes de terminar no se cierran archivos abiertos ni se libera memoria de los que solo este hilo tiene los descriptores de archivo y los punteros, respectivamente.</p>
<div class="paragraph">
<p>AdemÃ¡s, si el hilo que termina estaba modificando datos que compartÃ­a con otros hilos, estos cambios podrÃ­an quedar a medias.
Esto puede dejar las estructuras de datos compartidas en un estado inconsistente, causando problemas en otros hilos.</p>
</div>
</li>
<li>
<p>En la <strong>cancelaciÃ³n en diferido</strong> el hilo comprueba periÃ³dicamente cuando debe terminar.
Si no se tiene cuidado, los problemas pueden ser similares a los de la <strong>cancelaciÃ³n asÃ­ncrona</strong>.
La diferencia es que ahora el desarrollador conoce de antemano los puntos donde podrÃ­a terminar el hilo, lo que da una oportunidad de introducirlos solo donde sea seguro terminar.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Nota"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Se denomina <strong>fuga de memoria</strong> al error que ocurre cuando un bloque de memoria reservada no se libera durante la ejecuciÃ³n del programa.
TambiÃ©n pueden ocurrir fugas con otros recursos del sistema operativo, como: archivos, <em>sockets</em>, colas de mensajes o regiones de memoria compartida.</p>
</div>
<div class="paragraph">
<p>Generalmente ocurre porque se pierden todas las referencias a un recurso, por lo que ya no hay oportunidad de liberarlo.
Por ejemplo, cuando se cancela un hilo que es el Ãºnico que tiene algunas referencias, sin liberar antes esos recursos.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_cancelaciÃ³n_en_posix_threads"><a class="anchor" href="#_cancelaciÃ³n_en_posix_threads"></a>12.5.3. CancelaciÃ³n en POSIX Threads</h4>
<div class="paragraph">
<p>En <a href="https://man7.org/linux/man-pages/man7/pthreads.7.html">POSIX Threads</a> un hilo puede solicitar la cancelaciÃ³n de otro hilo usando <a href="https://man7.org/linux/man-pages/man3/pthread_cancel.3.html">pthread_cancel()</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="kt">int</span> <span class="n">return_code</span> <span class="o">=</span> <span class="n">pthread_cancel</span><span class="p">(</span><span class="kr">thread</span><span class="p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El hilo identificado por el manejador <code>thread</code> serÃ¡ cancelado si estÃ¡ configurado como cancelable.
Por defecto todos los hilos son cancelables, pero eso lo puede cambiar el propio hilo llamando a <a href="https://man7.org/linux/man-pages/man3/pthread_setcancelstate.3.html">pthread_setcancelstate()</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="kt">int</span> <span class="n">return_code</span> <span class="o">=</span> <span class="n">pthread_setcancelstate</span><span class="p">(</span>
    <span class="n">PTHREAD_CANCEL_DISABLE</span><span class="p">,</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="o">&amp;</span><span class="n">oldstate</span>               <i class="conum" data-value="2"></i><b>(2)</b>
<span class="p">);</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Con <code>PTHREAD_CANCEL_DISABLE</code> se desactiva la cancelaciÃ³n en el hilo que llama la funciÃ³n.
El otro valor posible es <code>PTHREAD_CANCEL_ENABLE</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>La funciÃ³n devuelve a travÃ©s de un puntero a <code>int</code> el valor anterior del estado de cancelaciÃ³n.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>El tipo de cancelaciÃ³n se puede configurar con <a href="https://www.man7.org/linux/man-pages/man3/pthread_setcanceltype.3.html">pthread_setcanceltype()</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="kt">int</span> <span class="n">return_code</span> <span class="o">=</span> <span class="n">pthread_setcanceltypr</span><span class="p">(</span>
    <span class="n">PTHREAD_CANCEL_DEFERRED</span><span class="p">,</span>    <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="o">&amp;</span><span class="n">oldtype</span>                    <i class="conum" data-value="2"></i><b>(2)</b>
<span class="p">);</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Con <code>PTHREAD_CANCEL_DEFERRED</code> se activa la <strong>cancelaciÃ³n en diferido</strong>, que de todas formas es el tipo de cancelaciÃ³n por defecto. El otro valor posible es <code>PTHREAD_CANCEL_ASYNCHRONOUS</code>, que corresponde con la <strong>cancelaciÃ³n asÃ­ncrona</strong>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>La funciÃ³n devuelve a travÃ©s de un puntero a <code>int</code> el valor anterior del tipo de cancelaciÃ³n.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Se pueden cambiar entre estado y tipo de cancelaciÃ³n en cualquier momento, segÃºn lo que encaje mejor con las caracterÃ­sticas de las distintas partes del cÃ³digo.</p>
</div>
<div class="sect4">
<h5 id="_cancelaciÃ³n_asÃ­ncrona"><a class="anchor" href="#_cancelaciÃ³n_asÃ­ncrona"></a>CancelaciÃ³n asÃ­ncrona</h5>
<div class="paragraph">
<p>
Por los motivos comentados anteriormente, no es recomendable la <strong>cancelaciÃ³n asÃ­ncrona</strong>, a menos que estemos muy seguros de que no puede causar problemas.
Uno de los pocos casos con los que es compatible es en bucles 100% dedicados a ejecutar cÃ¡lculos en la CPU, como el siguiente:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="kt">int</span> <span class="n">factorial</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">for</span> <span class="p">(</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">number</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="n">factorial</span> <span class="o">=</span> <span class="n">factorial</span> <span class="o">*</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La <strong>cancelaciÃ³n asÃ­ncrona</strong> no se debe usar si el cÃ³digo reserva memoria dinÃ¡micamente o solicita otros recursos del sistema operativo, porque el hilo podrÃ­a terminar en cualquier momento sin liberarlos.
Tampoco si se modifican estructuras de datos, porque los cambios pueden quedar a medias.</p>
</div>
<div class="paragraph">
<p>Por ejemplo, si la cancelaciÃ³n ocurre en medio de una llamada a <a href="https://en.cppreference.com/w/c/memory/malloc">malloc()</a> o <a href="https://en.cppreference.com/w/cpp/language/new">new</a> no hay forma de saber si ocurriÃ³ antes de que la memoria fuera reservada o despuÃ©s.
Incluso puede haber ocurrido en medio de la operaciÃ³n, dejando en estado inconsistente las estructuras de datos que sirven para seguir la pista de las zonas de memoria reservadas y libres.</p>
</div>
<div class="paragraph">
<p>El estÃ¡ndar POSIX solo indica que las funciones <a href="https://man7.org/linux/man-pages/man3/pthread_setcancelstate.3.html">pthread_setcancelstate()</a> y <a href="https://www.man7.org/linux/man-pages/man3/pthread_setcanceltype.3.html">pthread_setcanceltype()</a> deben ser seguras frente a la <strong>cancelaciÃ³n asÃ­ncrona</strong> del hilo.
En general, no se puede llamar a otras funciones de la librerÃ­a del sistema de forma segura en un hilo cancelable asÃ­ncronamente.</p>
</div>
</div>
<div class="sect4">
<h5 id="_cancelaciÃ³n_en_diferido"><a class="anchor" href="#_cancelaciÃ³n_en_diferido"></a>CancelaciÃ³n en diferido</h5>
<div class="paragraph">
<p>
Por tanto, la <strong>cancelaciÃ³n en diferido</strong> es la mejor alternativa.
Con este tipo de cancelaciÃ³n, la terminaciÃ³n del hilo ocurre en puntos concretos del cÃ³digo.</p>
</div>
<div class="paragraph">
<p>En la terminologÃ­a de <a href="https://man7.org/linux/man-pages/man7/pthreads.7.html">POSIX Threads</a> a estos puntos se los denomina <strong>puntos de cancelaciÃ³n</strong> y la inmensa mayorÃ­a de las llamadas al sistema que puede poner el hilo en estado <strong>esperando</strong> lo son por sÃ­ mismas.
Por ejemplo, <a href="https://man7.org/linux/man-pages/man2/open.2.html">open()</a>, <a href="https://man7.org/linux/man-pages/man2/close.2.html">close()</a>, <a href="https://man7.org/linux/man-pages/man2/read.2.html">read()</a>, <a href="https://man7.org/linux/man-pages/man2/write.2.html">write()</a>, <a href="https://man7.org/linux/man-pages/man2/recv.2.html">recv()</a>, <a href="https://man7.org/linux/man-pages/man2/send.2.html">send()</a>, <a href="https://man7.org/linux/man-pages/man2/poll.2.html">poll()</a> y <a href="https://man7.org/linux/man-pages/man3/sleep.3.html">sleep()</a>, entre muchas otras (vÃ©ase la lista en la secciÃ³n Â«<em>Cancellation points</em>Â» de la documentaciÃ³n de <a href="https://man7.org/linux/man-pages/man7/pthreads.7.html">POSIX Threads</a>).
Eso significa que seguramente tambiÃ©n sean <strong>puntos de cancelaciÃ³n</strong>, las funciones de la librerÃ­a del sistema y de la librerÃ­a estÃ¡ndar del lenguaje que utilizan esas llamadas al sistema.</p>
</div>
<div class="paragraph">
<p>Sabiendo esto, se puede estudiar cada caso.
Si no es seguro permitir la cancelaciÃ³n de un hilo en la invocaciÃ³n de una de estas funciones en nuestro cÃ³digo, se puede usar <a href="https://man7.org/linux/man-pages/man3/pthread_setcancelstate.3.html">pthread_setcancelstate()</a> para desactivar temporalmente el mecanismo de cancelaciÃ³n.
Por ejemplo, una llamada a <a href="https://en.cppreference.com/w/c/io/fprintf">printf()</a> como ayuda para depurar, en medio de los pasos para modificar una estructura de datos âcomo una lista enlazada o una colaâ introduce un <strong>punto de cancelaciÃ³n</strong> en lugar poco seguro; porque si el hilo se cancela en ese punto, la estructura de datos quedarÃ¡ en estado inconsistente.
La soluciÃ³n es eliminar la llamada a <a href="https://en.cppreference.com/w/c/io/fprintf">printf()</a> o desactivar temporalmente el mecanismo de cancelaciÃ³n.</p>
</div>
<div class="paragraph">
<p>De forma inversa, se pueden introducir manualmente puntos de cancelaciÃ³n llamando a <a href="https://man7.org/linux/man-pages/man3/pthread_testcancel.3.html">pthread_testcancel()</a>.
Por ejemplo, el siguiente bucle no hace llamadas al sistema, por lo que no tiene puntos de cancelaciÃ³n:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="kt">int</span> <span class="n">factorial</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">for</span> <span class="p">(</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">number</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="n">factorial</span> <span class="o">=</span> <span class="n">factorial</span> <span class="o">*</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Eso significa que ese cÃ³digo para calcular el factorial de <code>number</code> podrÃ­a ejecutarse durante bastante tiempo sin ofrecer una oportunidad para cancelar el hilo; incluso aunque es un cÃ³digo muy seguro desde el punto de vista de la cancelaciÃ³n.
La soluciÃ³n es introducir manualmente un punto de cancelaciÃ³n:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="kt">int</span> <span class="n">factorial</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">for</span> <span class="p">(</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">number</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="n">factorial</span> <span class="o">=</span> <span class="n">factorial</span> <span class="o">*</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">pthread_testcancel</span><span class="p">();</span>   <i class="conum" data-value="1"></i><b>(1)</b>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Comprobar si se ha solicitado la cancelaciÃ³n del hilo y si es asÃ­, cancelar el hilo.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>La <strong>cancelaciÃ³n en diferido</strong> tambiÃ©n presenta retos desde el punto de vista de evitar las fugas de memoria y de otros recursos cuando un hilo es cancelado.
Por ejemplo, supongamos que tenemos una funciÃ³n que abre una tuberÃ­a, crea un hilo para gestionar los mensajes que llegan y devuelve un puntero a una estructura de datos que se puede usar en otras funciones de la librerÃ­a âde forma similar a <a href="https://en.cppreference.com/w/c/io/fopen">fopen()</a> y <code>FILE*</code>â:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="n">CONN</span><span class="o">*</span> <span class="nf">conn_open</span><span class="p">(</span> <span class="cm">/* ... */</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="n">CONN</span><span class="o">*</span> <span class="n">handler</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">CONN</span><span class="p">)</span> <span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">handler</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">handler</span><span class="o">-&gt;</span><span class="n">fifofd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span> <span class="cm">/* ... */</span> <span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fifofd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">free</span><span class="p">(</span> <span class="n">handler</span> <span class="p">);</span> <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">int</span> <span class="n">return_code</span> <span class="o">=</span> <span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">handler</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">,</span> <span class="cm">/* ... */</span><span class="p">,</span> <span class="n">handler</span> <span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">return_code</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">close</span><span class="p">(</span> <span class="n">handler</span><span class="o">-&gt;</span><span class="n">fifofd</span> <span class="p">);</span> <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="n">free</span><span class="p">(</span> <span class="n">handler</span> <span class="p">);</span> <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">handler</span><span class="p">;</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Evitar la <strong>fuga de memoria</strong> si <a href="https://man7.org/linux/man-pages/man2/open.2.html">open()</a> o <a href="https://man7.org/linux/man-pages/man3/pthread_create.3.html">pthread_create()</a> fallan.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Evitar la fuga del <em>socket</em> si <a href="https://man7.org/linux/man-pages/man3/pthread_create.3.html">pthread_create()</a> falla.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Este cÃ³digo y la forma en que maneja los errores funcionan bien en programas monohilo, porque estamos seguros de que al salir de la funciÃ³n o se completaron todas las etapas o ninguna.
Es decir, si alguna de las peticiones al sistema falla, las hechas anteriormente se Â«deshacenÂ» para evitar la fuga de recursos.</p>
</div>
<div class="paragraph">
<p>Pero no es correcto en programas multihilo porque <a href="https://man7.org/linux/man-pages/man2/open.2.html">open()</a> y <a href="https://man7.org/linux/man-pages/man2/close.2.html">close()</a> son <strong>puntos de cancelaciÃ³n</strong>.
Si <code>conn_open()</code> es llamada desde un hilo y ese hilo es cancelado, el hilo podrÃ­a terminar a mitad de la funciÃ³n, sin liberar <code>handler</code>, creando una <strong>fuga de memoria</strong> que no se liberarÃ¡ hasta que el proceso termine.
Si <code>conn_open()</code> es llamada en mÃºltiples ocasiones, cada una es una oportunidad para perder memoria.</p>
</div>
<div class="paragraph">
<p>El cÃ³digo anterior se puede mejorar usando <strong>manejadores de limpieza</strong>.
Esos manejadores se organizan en una pila de la que se pueden insertar o extraer llamando a <a href="https://man7.org/linux/man-pages/man3/pthread_cleanup_push.3.html">pthread_cleanup_push()</a> y <a href="https://man7.org/linux/man-pages/man3/pthread_cleanup_pop.3.html">pthread_cleanup_pop()</a>, respectivamente.
Cuando el hilo es cancelado, la librerÃ­a extrae los manejadores de la pila y los va ejecutando en orden, antes de terminar.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="n">CONN</span><span class="o">*</span> <span class="nf">conn_open</span><span class="p">(</span> <span class="cm">/* ... */</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="n">CONN</span><span class="o">*</span> <span class="n">handler</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">CONN</span><span class="p">)</span> <span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">handler</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">pthread_cleanup_push</span><span class="p">(</span><span class="o">&amp;</span><span class="n">free</span><span class="p">,</span> <span class="n">handler</span><span class="p">);</span> <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="n">handler</span><span class="o">-&gt;</span><span class="n">fifofd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span> <span class="cm">/* ... */</span> <span class="p">);</span>  <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="k">if</span> <span class="p">(</span><span class="n">fifofd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">pthread_cleanup_pop</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>     <span class="c1">// free(handler) </span><i class="conum" data-value="3"></i><b>(3)</b>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">pthread_cleanup_push</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cleanup_fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">handler</span><span class="o">-&gt;</span><span class="n">fifofd</span><span class="p">);</span>

    <span class="kt">int</span> <span class="n">return_code</span> <span class="o">=</span> <span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">handler</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">,</span> <span class="cm">/* ... */</span><span class="p">,</span> <span class="n">handler</span> <span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">return_code</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">close</span><span class="p">(</span> <span class="n">handler</span><span class="o">-&gt;</span><span class="n">fifofd</span> <span class="p">);</span> <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="n">pthread_cleanup_pop</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>     <span class="c1">// free(handler) </span><i class="conum" data-value="3"></i><b>(3)</b>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">pthread_cleanup_pop</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <i class="conum" data-value="4"></i><b>(4)</b>

    <span class="k">return</span> <span class="n">handler</span><span class="p">;</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Nada mÃ¡s reservar la memoria de <code>CONN</code> se aÃ±ade un <strong>manejador de limpieza</strong> que llamarÃ¡ a <code>free(handler)</code> si el hilo va a ser cancelado.
AsÃ­ nos aseguramos que <code>handler</code> serÃ¡ liberado si el hilo es cancelado.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>La cancelaciÃ³n solo puede ocurrir en los <strong>puntos de cancelaciÃ³n</strong> que son las llamadas a <a href="https://man7.org/linux/man-pages/man2/open.2.html">open()</a> y <a href="https://man7.org/linux/man-pages/man2/close.2.html">close()</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>En caso de error, el <strong>manejador de limpieza</strong> ya no hace falta, asÃ­ que se extrae antes de salir de la funciÃ³n.
Se llama a <a href="https://man7.org/linux/man-pages/man3/pthread_cleanup_pop.3.html">pthread_cleanup_pop()</a> con valor distinto de 0 porque asÃ­ la funciÃ³n extrae el manejador y lo invoca.
A fin de cuentas se sale a causa de un error, por lo que sigue siendo necesario ejecutar <code>free(handler)</code> para evitar una <strong>fuga de memoria</strong>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Al terminar la funciÃ³n se extraen todos los manejadores de seÃ±al, puesto que ya no hacen falta.
El argumento 0 hace que <a href="https://man7.org/linux/man-pages/man3/pthread_cleanup_pop.3.html">pthread_cleanup_pop()</a> no ejecute el manejador de limpieza extraÃ­do.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Ahora <code>conn_open()</code> maneja correctamente la cancelaciÃ³n del hilo donde se ejecuta, por lo que puede usarse sin problemas en aplicaciones multihilo.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_cancelaciÃ³n_de_hilos_en_lenguajes_de_alto_nivel"><a class="anchor" href="#_cancelaciÃ³n_de_hilos_en_lenguajes_de_alto_nivel"></a>12.5.4. CancelaciÃ³n de hilos en lenguajes de alto nivel</h4>
<div class="paragraph">
<p>El mecanismo de cancelaciÃ³n de hilos descrito funciona razonablemente bien en C, pero no con lenguajes de mÃ¡s alto nivel, como C&#43;&#43;, Java o C#.
Las librerÃ­as de hilos suelen ser librerÃ­as en C, que no conocen nada de objetos ni de otras particularidades de esos lenguajes.</p>
</div>
<div class="paragraph">
<p>Por ejemplo, en C&#43;&#43;, antes de terminar un hilo, deberÃ­an ser llamados todos los destructores de los objetos locales, para evitar <strong>fugas de memoria</strong> y de otros recursos, datos sin escribir y otros problemas derivados de tener objetos que no se destruyen adecuadamente.
Lamentablemente, el mecanismo de cancelaciÃ³n de <a href="https://man7.org/linux/man-pages/man7/pthreads.7.html">POSIX Threads</a> ây el de otras librerÃ­as de hilos, como la de Windows APIâ no sabe hacer nada de eso.
Cada lenguaje debe implementar su propia soluciÃ³n.</p>
</div>
<div class="paragraph">
<p>En Java y C#, por ejemplo, cuando un punto de cancelaciÃ³n detecta una peticiÃ³n de cancelaciÃ³n emite la excepciÃ³n <code>Thread.Interrupt</code>, que retrocede por la pila de llamadas, liberando las variables locales hasta salir por el mÃ©todo principal del hilo.
A este mecanismo se lo denomina <strong>cancelaciÃ³n coordinada</strong>.</p>
</div>
<div class="paragraph">
<p>En C&#43;&#43; no se ha incluido un mecanismo de cancelaciÃ³n en el estÃ¡ndar hasta C&#43;&#43;20.
Antes de C&#43;&#43;20, la forma recomendada de implementar la cancelaciÃ³n es pasando a los hilos una variable de tipo <code>bool</code> con la que seÃ±alarles cuÃ¡ndo deben terminar.
El cÃ³digo de los hilos debe comprobar frecuentemente el valor de dicha variable y, llegado el momento, terminar retornando ordenadamente por la funciÃ³n principal del hilo.</p>
</div>
<div class="paragraph">
<p>En C&#43;&#43;20 esta estrategia de <strong>cancelaciÃ³n cooperativa</strong> se ha formalizado e incluido en el estÃ¡ndar al introducir la clase <a href="https://en.cppreference.com/w/cpp/thread/jthread">std::jthread</a>.
Esta nueva clase de hilo puede pasar a la funciÃ³n principal lo que se llama un <strong><em>token</em> de cancelaciÃ³n</strong> âen lugar de una variable tipo <code>bool</code>â que se debe comprobar regularmente para saber si hay que terminar el hilo prematuramente.</p>
</div>
<div class="paragraph">
<p>Por ejemplo, la funciÃ³n del factorial podrÃ­a hacer uso de esa funcionalidad para terminar cuando se lo indiquen:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="cpp"><span class="kt">void</span> <span class="nf">compute_factorial</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">stop_token</span> <span class="n">stoken</span><span class="p">,</span> <span class="kt">int</span><span class="o">&amp;</span> <span class="n">factorial</span><span class="p">,</span> <span class="kt">int</span> <span class="n">number</span><span class="p">)</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="p">{</span>
    <span class="n">factorial</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">number</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="n">stoken</span><span class="p">.</span><span class="n">stop_requested</span><span class="p">())</span> <span class="k">return</span><span class="p">;</span> <i class="conum" data-value="4"></i><b>(4)</b>
        <span class="n">factorial</span> <span class="o">=</span> <span class="n">factorial</span> <span class="o">*</span> <span class="n">i</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// ...</span>

    <span class="kt">int</span> <span class="n">factorial</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">jthread</span> <span class="kr">thread</span><span class="p">(</span><span class="n">compute_factorial</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">ref</span><span class="p">(</span><span class="n">factorial</span><span class="p">),</span> <span class="mi">122</span><span class="p">);</span>  <i class="conum" data-value="1"></i><b>(1)</b> <i class="conum" data-value="2"></i><b>(2)</b>

    <span class="c1">// ...</span>

    <span class="kr">thread</span><span class="p">.</span><span class="n">request_stop</span><span class="p">();</span> <i class="conum" data-value="3"></i><b>(3)</b>

    <span class="c1">// ...</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Crear e iniciar el hilo con <a href="https://en.cppreference.com/w/cpp/thread/jthread">std::jthread</a> para calcular el factorial de 122.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Al crear el hilo se pasa a la funciÃ³n el <strong><em>token</em> de cancelaciÃ³n</strong> <code>stoken</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>En algÃºn momento de la ejecuciÃ³n del programa pedimos al hilo que se detenga antes de terminar los cÃ¡lculos.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>El cÃ³digo del hilo debe comprobar el <strong><em>token</em> de cancelaciÃ³n</strong> regularmente.
Si se ha pedido la cancelaciÃ³n, se termina el hilo retornando desde la funciÃ³n principal.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Java y C# han terminado incluyendo tambiÃ©n este tipo de <strong>cancelaciÃ³n cooperativa</strong> usando un <strong><em>token</em> de cancelaciÃ³n</strong>, debido a los problemas que tienen los desarrolladores para recordar usar correctamente la excepciÃ³n de la <strong>cancelaciÃ³n coordinada</strong>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_otras_consideraciones_sobre_los_hilos"><a class="anchor" href="#_otras_consideraciones_sobre_los_hilos"></a>12.6. Otras consideraciones sobre los hilos</h3>
<div class="sect3">
<h4 id="_las_llamadas_al_sistema_fork_y_exec_en_procesos_multihilo"><a class="anchor" href="#_las_llamadas_al_sistema_fork_y_exec_en_procesos_multihilo"></a>12.6.1. Las llamadas al sistema fork() y exec() en procesos multihilo</h4>
<div class="paragraph">
<p>La llamada al sistema <a href="https://man7.org/linux/man-pages/man2/fork.2.html">fork()</a> de los sistemas POSIX es anterior a la existencia del concepto de <strong>hilo</strong>.
AsÃ­ que cuando estos aparecieron surgiÃ³ el problema de si al llamar a <a href="https://man7.org/linux/man-pages/man2/fork.2.html">fork()</a> en un proceso multihilo:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>El nuevo proceso debÃ­a tener un duplicado de todos los hilos.</p>
</li>
<li>
<p>O el nuevo proceso debÃ­a tener un Ãºnico hilo copia del que invocÃ³ a <a href="https://man7.org/linux/man-pages/man2/fork.2.html">fork()</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Como hemos comentado anteriormente, la llamada al sistema <a href="https://man7.org/linux/man-pages/man2/fork.2.html">fork()</a> sustituye el programa en ejecuciÃ³n con un nuevo programa e inicia su ejecuciÃ³n en <a href="https://en.cppreference.com/w/c/language/main_function">main()</a>.
Esto incluye liberar toda la memoria reservada y la destrucciÃ³n de todos los hilos del programa original, por lo que duplicar los hilos en el proceso hijo creado por <a href="https://man7.org/linux/man-pages/man2/fork.2.html">fork()</a>, si luego se va a llamar a <a href="https://man7.org/linux/man-pages/man3/exec.3.html">exec()</a> parece algo innecesario.</p>
</div>
<div class="paragraph">
<p>El estÃ¡ndar POSIX establece que si se utiliza <a href="https://man7.org/linux/man-pages/man2/fork.2.html">fork()</a> en un programa multihilo, el nuevo proceso debe ser creado con un solo hilo, que serÃ¡ una rÃ©plica del que hizo la llamada, asÃ­ como un duplicado completo del espacio de direcciones del proceso.</p>
</div>
<div class="paragraph">
<p>Sin embargo, algunos sistemas UNIX tienen una segunda llamada no estÃ¡ndar denominada <code>forkall()</code>, capaz de duplicar todos los hilos del proceso padre.
Obviamente solo resulta conveniente emplearla si no se va a utilizar la llamada <a href="https://man7.org/linux/man-pages/man3/exec.3.html">exec()</a> a continuaciÃ³n.
La inclusiÃ³n de <code>forkall()</code> en el estÃ¡ndar POSIX fue considerada y rechazada.</p>
</div>
</div>
<div class="sect3">
<h4 id="_manejo_de_seÃ±ales_en_procesos_multihilo"><a class="anchor" href="#_manejo_de_seÃ±ales_en_procesos_multihilo"></a>12.6.2. Manejo de seÃ±ales en procesos multihilo</h4>
<div class="paragraph">
<p>En el <a href="comunicaciÃ³n_mediante_paso_de_mensajes.html#_seÃ±ales_en_sistemas_operativos_posix">Apartado 10.5.2</a> hablamos del uso de las seÃ±ales como mecanismo de comunicaciÃ³n, pero en general sirven para informar a un proceso del suceso de ciertos eventos.</p>
</div>
<div class="paragraph">
<p>Existen dos tipos de seÃ±ales:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Las <strong>seÃ±ales sÃ­ncronas</strong> se deben a alguna acciÃ³n del propio proceso.
Ejemplos de seÃ±ales de este tipo son <code>SIGSEV</code> y <code>SIGFE</code>, originadas por accesos ilegales a memoria o divisiones por 0, respectivamente.</p>
<div class="paragraph">
<p>Las seÃ±ales sÃ­ncronas son enviadas al mismo proceso que las origina.</p>
</div>
</li>
<li>
<p>Las <strong>seÃ±ales asÃ­ncronas</strong> son debidas a acciones externas.
Un ejemplo de este tipo de seÃ±ales es la terminaciÃ³n de procesos con teclas especiales como <span class="keyseq"><kbd>CTRL</kbd>+<kbd>C</kbd></span> o <kbd>CTRL-D</kbd>, que envÃ­an al proceso las seÃ±ales <code>SIGINT</code> y <code>SIGHUP</code> respectivamente.
TambiÃ©n lo son las seÃ±ales enviadas desde otro proceso, como cuando el proceso <strong>init</strong> envÃ­a <code>SIGTERM</code> al resto de procesos para informales que deben terminar porque el sistema se va a apagar.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Como hemos visto, las seÃ±ales que llegan a un proceso pueden ser interceptadas por una funciÃ³n definida por el programador llamada <strong>manejador de seÃ±al</strong>.</p>
</div>
<div class="paragraph">
<p>Las seÃ±ales tambiÃ©n son anteriores a los hilos, por lo que cuando aparecieron los hilos se tuvieron que tomar decisiones sobre cÃ³mo iban a encajar ambos conceptos.
Por ejemplo, decidir cuÃ¡l de los hilos del proceso, serÃ¡ interrumpido cuando llegue una seÃ±al, para ejecutar el manejador de seÃ±ales.</p>
</div>
<div class="sect4">
<h5 id="_seÃ±ales_enviadas_por_otros_hilos"><a class="anchor" href="#_seÃ±ales_enviadas_por_otros_hilos"></a>SeÃ±ales enviadas por otros hilos</h5>
<div class="paragraph">
<p>En los sistemas POSIX multihilo se pueden enviar seÃ±ales a un proceso:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="n">kill</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">SIGTERM</span><span class="p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En ese caso uno cualquiera de los hilos podrÃ¡ ser interrumpido para ejecutar el manejador de seÃ±al.</p>
</div>
<div class="paragraph">
<p>Cada hilo puede enmascarar las seÃ±ales que considere llamando a <a href="https://man7.org/linux/man-pages/man3/pthread_sigmask.3.html">pthread_sigmask()</a>
Es decir, cada hilo puede elegir quÃ© seÃ±ales quiere bloquear para no tener que atenderlas:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="n">sigset_t</span> <span class="n">set</span><span class="p">;</span>               <i class="conum" data-value="1"></i><b>(1)</b>

<span class="n">sigemptyset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">set</span><span class="p">);</span>          <i class="conum" data-value="2"></i><b>(2)</b>
<span class="n">sigaddset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">set</span><span class="p">,</span> <span class="n">SIGINT</span><span class="p">);</span>    <i class="conum" data-value="3"></i><b>(3)</b>
<span class="n">sigaddset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">set</span><span class="p">,</span> <span class="n">SIGUSR1</span><span class="p">);</span>   <i class="conum" data-value="4"></i><b>(4)</b>

<span class="n">pthread_sigmask</span><span class="p">(</span><span class="n">SIG_BLOCK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">set</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span> <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Las mÃ¡scaras de seÃ±ales se definen mediante <em>sets</em> de seÃ±ales.
El tipo de los <em>sets</em> de seÃ±ales es <code>sigset_t</code>, de cuyo tipo real no deberÃ­amos preocuparnos, por portabilidad.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Para manipular los <em>sets</em> se proporcionan una serie de funciones.
<a href="https://man7.org/linux/man-pages/man3/sigemptyset.3.html">sigemptyset()</a> es para asegurar que el <em>set</em> estÃ¡ vacÃ­o.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>AÃ±adimos al <em>set</em> la seÃ±al <code>SIGINT</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>AÃ±adimos al <em>set</em> la seÃ±al <code>SIGINT</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Bloqueamos en el hilo actual las seÃ±ales en el <em>set</em> <code>set</code>,es decir, <code>SIGINT</code> y <code>SIGUSR1</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>AsÃ­ una seÃ±al enviada a un proceso interrumpirÃ¡ a uno de los hilos que no la haya bloqueado.</p>
</div>
<div class="paragraph">
<p>TambiÃ©n se puede enviar una seÃ±al a un hilo en concreto usando <a href="https://man7.org/linux/man-pages/man3/pthread_kill.3.html">pthread_kill()</a>.
El hilo serÃ¡ interrumpido si no la ha bloqueado.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="n">pthread_kill</span><span class="p">(</span><span class="kr">thread</span><span class="p">,</span> <span class="n">SIGTERM</span><span class="p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Sin embargo, hay que tener en cuenta que el manejo de seÃ±ales es un recurso del proceso, compartido por todos sus hilos.
Esto quiere decir que si la seÃ±al estÃ¡ configurada para ser manejada usando la acciÃ³n por defecto y dicha acciÃ³n es terminar, terminarÃ¡ todo el proceso, aunque la seÃ±al haya sido dirigida a un hilo en concreto.</p>
</div>
</div>
<div class="sect4">
<h5 id="_seÃ±ales_enviadas_por_el_sistema"><a class="anchor" href="#_seÃ±ales_enviadas_por_el_sistema"></a>SeÃ±ales enviadas por el sistema</h5>
<div class="paragraph">
<p>Lo que queda por ver es a quiÃ©n va dirigida una seÃ±al, cuando es el sistema quiÃ©n la envÃ­a para notificar un evento:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Las seÃ±ales sÃ­ncronas son causadas por un error en la ejecuciÃ³n, que en un proceso multihilo es debido a la fallida ejecuciÃ³n de un hilo en particular.
Por eso estas seÃ±ales se dirigen al hilo que las causa.</p>
</li>
<li>
<p>Las seÃ±ales asÃ­ncronas llegan por causas externas, asÃ­ que se dirigen al proceso, pudiendo ser entregada a uno de los hilos que no la tenga bloqueada.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>La recomendaciÃ³n es elegir un hilo para el manejo de seÃ±ales asÃ­ncronas, de tal forma que sea el Ãºnico que no las tenga bloqueadas.
El resto de hilos deberÃ­an bloquear estas seÃ±ales nada mÃ¡s iniciar su ejecuciÃ³n.</p>
</div>
<div class="paragraph">
<p>Si se destina un hilo para esta tarea en exclusiva, este puede utilizar <a href="https://man7.org/linux/man-pages/man3/sigwait.3.html">sigwait()</a> para bloquearse hasta que llegue una seÃ±al.
Cuando eso ocurre, la funciÃ³n <a href="https://man7.org/linux/man-pages/man3/sigwait.3.html">sigwait()</a> retorna indicando el nÃºmero de seÃ±al recibida âsin necesitar <strong>manejadores de seÃ±al</strong>â.
Entonces el hilo puede solicitar la cancelaciÃ³n de los otros hilos para, por ejemplo, terminar el proceso.</p>
</div>
<div class="paragraph">
<p>Esta estrategia facilita el desarrollo de programas que manejen las seÃ±ales adecuadamente.
Al utilizar un hilo para manejar las seÃ±ales, tenemos a nuestra disposiciÃ³n cualquier funciÃ³n <strong>segura en hilos</strong> y sabemos cÃ³mo proteger las variables y estructuras de datos compartidas mediante el uso de mecanismos de <strong>sincromizaciÃ³n</strong> (vÃ©ase el <a href="sincronizaciÃ³n.html">CapÃ­tulo 13</a>).
Mientras que al trabajar con <strong>manejadores de seÃ±al</strong> estamos mucho mÃ¡s limitados, porque el cÃ³digo de estos debe ser <strong>reentrante</strong> y solo pueden usar alguna de las pocas funciones de la librerÃ­a del sistema marcadas como <a href="https://man7.org/linux/man-pages/man7/signal-safety.7.html">seguras en seÃ±ales</a>.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph nav-footer">
<p>âÂ Anterior:Â <a href="memoria_compartida.html">Memoria compartida</a>Â | âÂ Subir:Â <a href="gestiÃ³n_de_procesos.html">GestiÃ³n de procesos</a>Â | âÂ Inicio:Â <a href="main.html">Sistemas Operativos</a>Â | Siguiente:Â <a href="sincronizaciÃ³n.html">SincronizaciÃ³n</a>Â â</p>
</div>
</div>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  messageStyle: "none",
  tex2jax: {
    inlineMath: [["\\(", "\\)"]],
    displayMath: [["\\[", "\\]"]],
    ignoreClass: "nostem|nolatexmath"
  },
  asciimath2jax: {
    delimiters: [["\\$", "\\$"]],
    ignoreClass: "nostem|noasciimath"
  },
  TeX: { equationNumbers: { autoNumber: "none" } }
})
MathJax.Hub.Register.StartupHook("AsciiMath Jax Ready", function () {
  MathJax.InputJax.AsciiMath.postfilterHooks.Add(function (data, node) {
    if ((node = data.script.parentNode) && (node = node.parentNode) && node.classList.contains("stemblock")) {
      data.math.root.display = "block"
    }
    return data
  })
})
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js?config=TeX-MML-AM_HTMLorMML"></script>
<div id="footer">
    <div id="footer-text">
        Esta obra estÃ¡ sujeta a la licencia
        <a href="http://creativecommons.org/licenses/by/4.0/deed.es">Creative Commons AtribuciÃ³n 4.0 Internacional</a>,
        excepto donde se indique lo contrario.
    </div>
</div>
</body>
</html>