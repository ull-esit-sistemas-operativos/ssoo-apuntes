<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.17">
<meta name="author" content="Jesús Torres">
<title>Sistemas Operativos</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
pre.rouge table td { padding: 5px; }
pre.rouge table pre { margin: 0; }
pre.rouge .cm {
  color: #999988;
  font-style: italic;
}
pre.rouge .cp {
  color: #999999;
  font-weight: bold;
}
pre.rouge .c1 {
  color: #999988;
  font-style: italic;
}
pre.rouge .cs {
  color: #999999;
  font-weight: bold;
  font-style: italic;
}
pre.rouge .c, pre.rouge .ch, pre.rouge .cd, pre.rouge .cpf {
  color: #999988;
  font-style: italic;
}
pre.rouge .err {
  color: #a61717;
  background-color: #e3d2d2;
}
pre.rouge .gd {
  color: #000000;
  background-color: #ffdddd;
}
pre.rouge .ge {
  color: #000000;
  font-style: italic;
}
pre.rouge .gr {
  color: #aa0000;
}
pre.rouge .gh {
  color: #999999;
}
pre.rouge .gi {
  color: #000000;
  background-color: #ddffdd;
}
pre.rouge .go {
  color: #888888;
}
pre.rouge .gp {
  color: #555555;
}
pre.rouge .gs {
  font-weight: bold;
}
pre.rouge .gu {
  color: #aaaaaa;
}
pre.rouge .gt {
  color: #aa0000;
}
pre.rouge .kc {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kd {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kn {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kp {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kr {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kt {
  color: #445588;
  font-weight: bold;
}
pre.rouge .k, pre.rouge .kv {
  color: #000000;
  font-weight: bold;
}
pre.rouge .mf {
  color: #009999;
}
pre.rouge .mh {
  color: #009999;
}
pre.rouge .il {
  color: #009999;
}
pre.rouge .mi {
  color: #009999;
}
pre.rouge .mo {
  color: #009999;
}
pre.rouge .m, pre.rouge .mb, pre.rouge .mx {
  color: #009999;
}
pre.rouge .sa {
  color: #000000;
  font-weight: bold;
}
pre.rouge .sb {
  color: #d14;
}
pre.rouge .sc {
  color: #d14;
}
pre.rouge .sd {
  color: #d14;
}
pre.rouge .s2 {
  color: #d14;
}
pre.rouge .se {
  color: #d14;
}
pre.rouge .sh {
  color: #d14;
}
pre.rouge .si {
  color: #d14;
}
pre.rouge .sx {
  color: #d14;
}
pre.rouge .sr {
  color: #009926;
}
pre.rouge .s1 {
  color: #d14;
}
pre.rouge .ss {
  color: #990073;
}
pre.rouge .s, pre.rouge .dl {
  color: #d14;
}
pre.rouge .na {
  color: #008080;
}
pre.rouge .bp {
  color: #999999;
}
pre.rouge .nb {
  color: #0086B3;
}
pre.rouge .nc {
  color: #445588;
  font-weight: bold;
}
pre.rouge .no {
  color: #008080;
}
pre.rouge .nd {
  color: #3c5d5d;
  font-weight: bold;
}
pre.rouge .ni {
  color: #800080;
}
pre.rouge .ne {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nf, pre.rouge .fm {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nl {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nn {
  color: #555555;
}
pre.rouge .nt {
  color: #000080;
}
pre.rouge .vc {
  color: #008080;
}
pre.rouge .vg {
  color: #008080;
}
pre.rouge .vi {
  color: #008080;
}
pre.rouge .nv, pre.rouge .vm {
  color: #008080;
}
pre.rouge .ow {
  color: #000000;
  font-weight: bold;
}
pre.rouge .o {
  color: #000000;
  font-weight: bold;
}
pre.rouge .w {
  color: #bbbbbb;
}
pre.rouge {
  background-color: #f8f8f8;
}
</style>
<meta name='robots' content='noindex,nofollow'>
<link rel="icon" href="media/extras/favicon.ico" sizes="any">
<link rel="icon" href="media/extras/ssoo-icon.svg" type="image/svg+xml">
<link rel="icon" type="image/png" sizes="192x192" href="media/extras/ssoo-icon-192.png">
<link rel="icon" type="image/png" sizes="512x512" href="media/extras/ssoo-icon-512.png">
<link rel="apple-touch-icon" href="media/extras/ssoo-apple-touch-icon.png"><!-- 180×180 -->
<link rel="stylesheet" href="media/extras/inlineDisqussions.css">
<style>
    body {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
    }
    content {
        flex: 1;
    }
    #preamble {
        margin-top: 0.5em;
    }
    #header, #content, #footnotes {
        margin: 0 auto 0 5em
    }
    #content h1>a.anchor, h2>a.anchor, h3>a.anchor,
    #toctitle>a.anchor, .sidebarblock>.content>.title>a.anchor,
    h4>a.anchor, h5>a.anchor, h6>a.anchor {
        color: #ba3925;
    }
    .imageblock {
        text-align: center;
    }
    .imageblock > .content {
        margin-bottom: 1rem;
    }
    .imageblock > .title {
        text-align: inherit;
    }
    .tableblock > .lightcell {
        color: gray;
    }
    table tfoot td p {
        font-weight: bold;
    }
    #footer-text {
        margin: 0 auto;
        max-width: 62.5em;
        padding-left: .9375em;
        padding-right: .9375em;
    }
    #footer-text a {
        color: hsla(0,0%,100%,.8);
        text-decoration: none;
        font-weight: bold;
    }
    #footer-text a:hover {
        color: hsla(0,0%,100%,.8);
    }
</style>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script src="media/extras/inlineDisqussions.js"></script>
<script type="text/javascript">
    window.onload = function(){
        if ('true' === 'true') {
            setTimeout(function() {
                disqus_shortname = 'ull-esit-sistemas-operativos';
                jQuery("img, p, .colist td, .stemblock").not('#toc p').inlineDisqussions();
                query_params = (new URL(document.location)).searchParams;
                if (query_params.has('disqussion')) {
                    let identifier = window.location.pathname + 'disqussion-' + query_params.get('disqussion');
                    let selection = jQuery('[data-disqus-identifier="' +  identifier + '"]').not('.disqussion-link');
                    if (selection.length) {
                        selection[0].scrollIntoView(true);
                    }
                }
            }, 500);
        }
    }
</script>
<style>.toc-current{font-weight: bold;} .toc-root{font-family: "Open Sans","DejaVu Sans",sans-serif;
                       font-size: 0.9em;} #content{display: flex; flex-direction: column; flex: 1 1 auto;}
             .nav-footer{text-align: center; margin-top: auto;}
             .nav-footer > p > a {white-space: nowrap;}</style>
<style>
.admonitionblock td.icon .icon-time:before {content:"\f017";color:#f28500;}
</style>
</head>
<body id="hilos" class="book toc2 toc-left">
<div id="header">
<h1>Sistemas Operativos</h1>
<div class="details">
<span id="author" class="author">Jesús Torres</span><br>
<span id="email" class="email"><a href="mailto:jmtorres@ull.es">jmtorres@ull.es</a></span><br>
<span id="revdate">Edición OCW</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Tabla de Contenido</div>
<p><span class="toc-root"><a href="main.html">Sistemas Operativos</a></span></p><ul class="sectlevel1">
<li><a href="ediciones_y_licencia.html">Ediciones y licencia</a>
</li>
<li><a href="código_de_los_ejemplos.html">Código de los ejemplos</a>
</li>
<li><a href="introducción.html">Parte I: Introducción</a>
</li>
<li><a href="organización_de_los_sistemas_operativos.html">Parte II: Organización de los sistemas operativos</a>
</li>
<li><a href="gestión_de_procesos.html">Parte III: Gestión de procesos</a>
<ul class="sectlevel1">
<li><a href="procesos.html">9. Procesos</a>
</li>
<li><a href="comunicación_mediante_paso_de_mensajes.html">10. Comunicación mediante paso de mensajes</a>
</li>
<li><a href="memoria_compartida.html">11. Memoria compartida</a>
</li>
<li><a href="hilos.html"><span class="toc-current">12. Hilos</span></a>
<ul class="sectlevel2">
<li><a href="hilos.html#_introducción">12.1. Introducción</a>
</li>
<li><a href="hilos.html#_beneficios">12.2. Beneficios</a>
</li>
<li><a href="hilos.html#_soporte_multihilo">12.3. Soporte multihilo</a>
</li>
<li><a href="hilos.html#_modelos_multihilo">12.4. Modelos multihilo</a>
</li>
<li><a href="hilos.html#_operaciones_sobre_los_hilos">12.5. Operaciones sobre los hilos</a>
</li>
<li><a href="hilos.html#_otras_consideraciones_sobre_los_hilos">12.6. Otras consideraciones sobre los hilos</a>
</li>
</ul>
</li>
<li><a href="sincronización.html">13. Sincronización</a>
</li>
<li><a href="planificación_de_la_cpu.html">14. Planificación de la CPU</a>
</li>
</ul>
</li>
<li><a href="gestión_de_la_memoria.html">Parte IV: Gestión de la memoria</a>
</li>
<li><a href="gestión_del_almacenamiento.html">Parte V: Gestión del almacenamiento</a>
</li>
<li><a href="bibliografía.html">Bibliografía</a>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="hilos"><a class="anchor" href="#hilos"></a>12. Hilos</h2>
<div class="sectionbody">
<div class="admonitionblock time">
<table>
<tr>
<td class="icon">
<i class="fa icon-time" title=""></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>Tiempo de lectura:</strong> 36 minutos</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>En el modelo de proceso que hemos descrito hasta el momento, cada proceso tiene una única secuencia de instrucciones que se ejecuta en la CPU.
Si los procesos solo pueden tener una única secuencia de instrucciones, solo pueden realizar una tarea a la vez.
Por ejemplo, en un procesador de textos en un sistema operativo con este modelo de procesos, el usuario nunca podría escribir al mismo tiempo que se comprueba la ortografía.
Si queremos hacer varias tareas al mismo tiempo, estamos obligados a crear varios procesos y seleccionar un mecanismo de comunicación para que estos colaboren.</p>
</div>
<div class="paragraph">
<p>Por eso muchos sistemas operativos modernos han extendido el concepto de proceso para permitir que cada uno tenga múltiples secuencias de instrucciones para ejecutarse en la CPU.
A cada una de estas secuencias de instrucciones se las conoce como <strong>hilo</strong> de ejecución.
Los procesos con varios hilos pueden realizar varias tareas a la vez.</p>
</div>
<div class="sect2">
<h3 id="_introducción"><a class="anchor" href="#_introducción"></a>12.1. Introducción</h3>
<div class="paragraph">
<p>Desde que introducimos el concepto de <strong>proceso</strong> hemos considerado que es la unidad básica de uso de la CPU.
Es decir, que la CPU se asignaba a los procesos, que la usaban para ejecutar sus instrucciones.
Sin embargo, en los <strong>sistemas operativos multihilo</strong> es el <strong>hilo</strong> la unidad básica de uso de la CPU.</p>
</div>
<div id="fig-multihilo" class="imageblock">
<div class="content">
<img src="media/C12-hilos/procesos_multihilo.svg" alt="procesos multihilo">
</div>
<div class="title">Figura 37. Comparación entre procesos monohilo y proceso multihilo.</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>Cada hilo tiene una serie de recursos propios dentro del proceso (véase la <a href="hilos.html#fig-multihilo">Figura 37</a>):</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>El identificador del hilo</strong> es único para cada hilo y sirve para identificarlos, de la misma manera que lo hace el identificador de proceso con cada proceso.</p>
</li>
<li>
<p><strong>El contador de programa</strong> es el registro de la CPU que indica la dirección de la próxima instrucción del hilo que debe ser ejecutada por la CPU.</p>
</li>
<li>
<p><strong>Los registros de la CPU</strong>, cuyos valores son diferentes en cada hilo, puesto que, aunque todos los hilos ejecutan el mismo programa, pueden ejecutar diferentes partes del mismo.</p>
</li>
<li>
<p><strong>La pila</strong> contiene datos temporales como argumentos y direcciones de retorno de las funciones y variables locales.
Al igual que ocurre con los registros de la CPU, cada hilo necesita su pila porque recorre el programa de manera diferente.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Sin embargo hay otros recursos que se asignan al proceso, por lo que se comparten entre todos los hilos del mismo (véase la <a href="hilos.html#fig-multihilo">Figura 37</a>):</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>El código del programa</strong>.
El programa es el mismo para todos los hilos.</p>
</li>
<li>
<p><strong>Los segmentos BSS y de datos y el montón</strong>.
Las secciones de datos diferentes de la pila son accesibles a todos los hilos.
Eso quiere decir, por ejemplo, que cualquier hilo puede acceder y modificar una variable global o una asignada dinámicamente mediante <a href="https://en.cppreference.com/w/c/memory/malloc">malloc()</a> o <a href="https://en.cppreference.com/w/cpp/language/new">new</a>.</p>
</li>
<li>
<p><strong>Otros recursos del proceso</strong> como archivos, <em>sockets</em>, tuberías y dispositivos abiertos, regiones de memoria compartida, señales, directorio actual de trabajo, entre muchos otros recursos.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>Esto significa que cada instante, en cada CPU del sistema se puede estar ejecutando un hilo, del mismo o de distintos procesos en el sistema; pero la memoria, los archivos y otros recursos pertenecen al proceso del que cada uno forma parte.
Si un hilo reserva memoria o abre un archivo o un dispositivo y no lo libera antes de terminar, el recurso permanecerá reservado, no siendo liberado hasta que lo haga otro hilo o el proceso completo termine.
Si un hilo ejecuta una instrucción privilegiada o intenta acceder a una zona de memoria para la que no tiene permiso, la condición de error se propaga a todo el proceso.
Por tanto, por lo general, el sistema operativo detendrá el proceso completo del que formaba parte.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Nota"></i>
</td>
<td class="content">
Si se quiere ejecutar varias tareas al mismo tiempo de forma que la fiabilidad sea máxima, haciendo que los errores en unas no puedan afectar a las otras, tendremos que olvidarnos de los hilos.
Debemos utilizar diferentes procesos para cada tarea.
Así cada tarea tiene sus propios recursos y su propio espacio de direcciones virtual, lo que aísla a unas tareas de las otras.
</td>
</tr>
</table>
</div>
<div id="fig-proceso-multihilo-en-memoria" class="imageblock">
<div class="content">
<img src="media/C12-hilos/proceso_multihilo_en_memoria.svg" alt="proceso multihilo en memoria">
</div>
<div class="title">Figura 38. Anatomía de un proceso multihilo en memoria.</div>
</div>
<div class="paragraph">
<p>En la <a href="hilos.html#fig-proceso-multihilo-en-memoria">Figura 38</a> se puede observar como cambia la disposición de los elementos de un proceso en la memoria cuando es multihilo, respecto a lo que vimos en el <a href="procesos.html#_el_proceso">Apartado 9.1</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_beneficios"><a class="anchor" href="#_beneficios"></a>12.2. Beneficios</h3>
<div class="paragraph">
<p>Son muchos los beneficios que aporta la programación multihilo:</p>
</div>
<div class="sect3">
<h4 id="_tiempo_de_respuesta"><a class="anchor" href="#_tiempo_de_respuesta"></a>12.2.1. Tiempo de respuesta</h4>
<div class="paragraph">
<p>Una aplicación multihilo interactiva puede continuar ejecutando tareas aunque uno o varios hilos de la misma estén bloqueados o realizando operaciones muy lentamente, mejorando así el tiempo de respuesta al usuario.</p>
</div>
<div class="paragraph">
<p>Por ejemplo, un navegador web multihilo puede gestionar la interacción del usuario a través de un hilo, mientras el contenido solicitado se descarga en otro.
Para hacer lo mismo en un navegador monohilo habría que utilizar comunicaciones asíncronas, de lo contrario, mientras el proceso está en estado <strong>esperando</strong>, a la espera de que lleguen los datos a través de la red, no puede atender las acciones del usuario.</p>
</div>
</div>
<div class="sect3">
<h4 id="_compartición_de_recursos"><a class="anchor" href="#_compartición_de_recursos"></a>12.2.2. Compartición de recursos</h4>
<div class="paragraph">
<p>En sistemas operativos monohilo se pueden crear varios procesos y comunicarlos mediante memoria compartida para conseguir algo similar a lo que ofrecen los sistemas multihilo.
Sin embargo, al utilizar hilos, las tareas ejecutadas en ellos comparten los recursos automáticamente, sin que tengamos que hacer nada.
Además, los hilos no solo comparten la memoria, sino también otros muchos recursos del proceso.
Por lo que los hilos son una forma más conveniente de tener procesos que realizan diferentes actividades al mismo tiempo.</p>
</div>
</div>
<div class="sect3">
<h4 id="_economía"><a class="anchor" href="#_economía"></a>12.2.3. Economía</h4>
<div class="paragraph">
<p>Reservar memoria y otros recursos para la creación de un proceso es muy costoso.
Por eso los sistemas operativos modernos han desarrollado diversas técnicas para que sea lo más eficaz posible.</p>
</div>
<div class="paragraph">
<p>Aun así, puesto que los hilos comparten los recursos de los procesos a los que pertenecen, son mucho más económicos de crear.
También es más económico el cambio de contexto entre ellos, ya que hay que guardar y recuperar menos información al cambiar entre dos hilos de un mismo proceso.</p>
</div>
<div class="paragraph">
<p>Por ejemplo, en Microsoft Windows crear un proceso puede ser 300 veces más costoso que un hilo. Mientras que en sistemas Linux es 3 veces más lento, por la eficiencia de <a href="https://man7.org/linux/man-pages/man2/fork.2.html">fork()</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_aprovechamiento_de_las_arquitecturas_multiprocesador"><a class="anchor" href="#_aprovechamiento_de_las_arquitecturas_multiprocesador"></a>12.2.4. Aprovechamiento de las arquitecturas multiprocesador.</h4>
<div class="paragraph">
<p>En los sistemas multiprocesador diferentes hilos pueden ejecutarse en paralelo en distintos procesadores.
Por el contrario, un proceso monohilo solo se puede ejecutar en una CPU a la vez, independientemente de cuantas CPU estén disponibles para ejecutarlo.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_soporte_multihilo"><a class="anchor" href="#_soporte_multihilo"></a>12.3. Soporte multihilo</h3>
<div class="paragraph">
<p>Las <strong>librerías de hilos</strong> proporcionan al programador la interfaz de programación para crear y gestionar los hilos de su proceso.
Hay dos formas de implementar una librería de hilos: en el espacio de usuario o en el núcleo.</p>
</div>
<div class="sect3">
<h4 id="_librería_de_hilos_en_el_espacio_de_usuario"><a class="anchor" href="#_librería_de_hilos_en_el_espacio_de_usuario"></a>12.3.1. Librería de hilos en el espacio de usuario</h4>
<div class="paragraph">
<p>La librería de hilos se puede implementar en el espacio de usuario, junto al código y los datos del proceso, sin requerir ningún soporte especial por parte del núcleo.</p>
</div>
<div class="paragraph">
<p>Estos hilos no existen para el núcleo del sistema operativo, solo para el proceso que los ha creado.
Por ese motivo se los denomina <strong>hilos de usuario</strong> o <strong>hilos del nivel de usuario</strong>.</p>
</div>
<div class="paragraph">
<p>Como el código y los datos de la librería residen en el espacio de usuario, invocar una función de la misma se reduce a una simple llamada a una función, evitando el coste de hacer llamadas al sistema.</p>
</div>
</div>
<div class="sect3">
<h4 id="_librería_de_hilos_en_el_núcleo"><a class="anchor" href="#_librería_de_hilos_en_el_núcleo"></a>12.3.2. Librería de hilos en el núcleo</h4>
<div class="paragraph">
<p>Si la librería de hilos se implementa en el núcleo, es el núcleo del sistema el que se encarga de darles soporte.
Por ese motivo se los denomina <strong>hilos de núcleo</strong> o <strong>hilos del nivel de núcleo</strong>.</p>
</div>
<div class="paragraph">
<p>Aparte del <strong>PCB</strong> que vimos en el <a href="procesos.html#_bloque_de_control_de_proceso">Apartado 9.3</a>, cada hilo tiene una estructura llamada <strong>bloque de control del hilo</strong> o TCB (<em>Thread Control Block</em>) que representa a cada hilo en el sistema operativo y que guarda información sobre su estado de actividad actual.</p>
</div>
<div class="paragraph">
<p>En estos sistemas, es el hilo la unidad básica de uso de la CPU.
Son los hilos los que se mueven por los estados del <a href="procesos.html#fig-diagrama-estado-proceso">Figura 28</a> y las colas de la <a href="procesos.html#fig-colas-de-planificación-procesos">Figura 29</a> y no los procesos.
El planificador de la CPU selecciona un hilo para ejecutarse en la CPU de entre todos los que están en el estado <strong>preparado</strong> en el sistema y el <strong>cambio de contexto</strong> asigna la CPU a un hilo distinto al que la tiene asignada en el momento actual.</p>
</div>
<div class="paragraph">
<p>Por tanto, es en <strong>TCB</strong> —y no en el <strong>PCB</strong>— donde se guarda la información privada del hilo necesaria para la gestión de los estados y para el cambio de contexto, como: los valores de los registros de la CPU y el contador de programa, el estado o la información de planificación de la CPU; además de un puntero al <strong>PCB</strong> al que pertenece el hilo con el resto de la información privada del proceso.</p>
</div>
<div class="paragraph">
<p>Como el código y los datos de la librería residen en el espacio del núcleo, invocar una función de la misma requiere frecuentemente hacer una llamada al sistema.
Obviamente, la librería del sistema ofrece funciones para no tener que hacer la llamada al sistema directamente.</p>
</div>
<div class="paragraph">
<p>En la actualidad, en los diferentes sistemas operativos se pueden encontrar librerías de ambos tipos.
Por ejemplo, la librería de hilos de Windows API se implementa en el núcleo (véase <a href="https://docs.microsoft.com/en-us/windows/win32/procthread/using-processes-and-threads">«Using Processes and Threads&#8201;&#8212;&#8201;Microsoft Docs»</a>) mientras que la librería de hilos <a href="https://man7.org/linux/man-pages/man7/pthreads.7.html">POSIX Threads</a> —frecuentemente utilizada en los sistemas POSIX— puede ser de ambos tipos, dependiendo solamente del sistema donde se implemente. En Linux y en la mayor parte de los UNIX modernos, POSIX Threads se implementa en el núcleo del sistema.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_modelos_multihilo"><a class="anchor" href="#_modelos_multihilo"></a>12.4. Modelos multihilo</h3>
<div class="paragraph">
<p>Las distintas formas de implementar los hilos comentadas anteriormente —en espacio de usuario o en el núcleo— no son excluyentes, ya que en un sistema operativo concreto se pueden implementar ambas, una de las dos o ninguna.</p>
</div>
<div class="paragraph">
<p>A continuación veremos los modelos a los que han dado lugar las distintas combinaciones.</p>
</div>
<div class="sect3">
<h4 id="_muchos_a_uno"><a class="anchor" href="#_muchos_a_uno"></a>12.4.1. Muchos a uno</h4>
<div class="paragraph">
<p>
En el modelo <strong>muchos a uno</strong> los hilos que ve el proceso se mapean en una única «entidad planificable en la CPU» del núcleo.</p>
</div>
<div class="paragraph">
<p>Este, por lo general, es el modelo utilizado cuando el núcleo no soporta múltiples hilos de ejecución.
En ese caso, la única entidad planificable en la CPU que conoce el núcleo es el proceso, la librería de hilos se implementa en el espacio de usuario —dentro del proceso— y los hilos que ve el proceso son <strong>hilos de usuario</strong> (véase la <a href="hilos.html#fig-modelo-muchos-a-uno">Figura 39</a>).</p>
</div>
<div id="fig-modelo-muchos-a-uno" class="imageblock">
<div class="content">
<img src="media/C12-hilos/modelo_muchos_a_uno.svg" alt="modelo muchos a uno">
</div>
<div class="title">Figura 39. Modelo muchos a uno.</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>Las principales características de este modelo son:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>La gestión de hilos se hace con una librería en el espacio de usuario, por lo que los hilos se pueden crear de forma rápida y con poco coste.
Como hemos visto anteriormente, la invocación de las funciones de la librería se hace por medio de simples llamadas a funciones.</p>
</li>
<li>
<p>Si uno de los hilos solicita al sistema operativo una operación que deba ser bloqueada a la espera —por ejemplo, operaciones de E/S sobre archivos, comunicaciones o esperar a que otro proceso termine— todo el proceso es bloqueado, no pudiendo ejecutarse otros hilos del mismo proceso mientras tanto.
Eso significa que si nuestros hilos hacen ese tipo de operaciones, el resultado es como si no tuviéramos hilos.</p>
</li>
<li>
<p>Como solo un hilo puede ser asignado al proceso, los hilos de un mismo proceso no se pueden ejecutar en paralelo en sistemas multiprocesador.
El planificador de la librería de hilos es el encargado de determinar qué hilo de usuario es asignado al proceso y este solo puede ejecutarse en una única CPU al mismo tiempo.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>El problema del bloqueo de procesos puede ser evitado interceptando las llamadas a funciones de la librería del sistema, para evitar el uso de llamadas al sistema que se puedan bloquear y sustituirlas por versiones equivalentes pero asíncronas.</p>
</div>
<div class="paragraph">
<p>Por ejemplo, si un hilo llamase a las funciones <a href="https://man7.org/linux/man-pages/man2/recv.2.html">recv()</a> o <a href="https://man7.org/linux/man-pages/man2/send.2.html">send()</a> de la librería del sistema, habría que hacer que realmente se invocase una versión diferente que utilizase estas funciones de forma asíncrona.
Mientras la operación es ejecutada por el sistema operativo, en lugar de retornar de la función, se llama al planificador de la librería de hilos para que la ejecución continúe con otro hilo del proceso, dejando suspendido el que tiene pendiente la operación.
Obviamente, el planificador de la librería de hilos debe estar al tanto de cuándo las operaciones asíncronas son completadas para poder volver a planificar los <strong>hilos de usuario</strong> suspendidos.</p>
</div>
<div class="paragraph">
<p>Este procedimiento es a todas luces bastante complejo y requiere versiones no bloqueantes de todas las llamadas al sistema —que no siempre existen— así como modificar o interceptar de alguna forma las funciones bloqueantes de la librería del sistema para implementar el comportamiento descrito.</p>
</div>
<div class="sect4">
<h5 id="_implementaciones"><a class="anchor" href="#_implementaciones"></a>Implementaciones</h5>
<div class="paragraph">
<p>A este modelo de hilos frecuentemente se lo llama <a href="https://en.wikipedia.org/wiki/Green_threads">Green Threads</a>.
En Java 1.1 era el único modelo soportado, pero debido a sus limitaciones se implementó el soporte del modelo <strong>uno a uno</strong> en versiones posteriores.</p>
</div>
<div class="paragraph">
<p>Otras implementaciones de este modelo son las <a href="https://docs.microsoft.com/en-us/windows/win32/procthread/fibers">fibras</a> de Windows API, <a href="http://www.stackless.com/">Stackless Python</a> y <a href="http://www.gnu.org/software/pth/">GNU Portable Threads</a>.
Estas implementaciones son muy útiles en los sistemas monohilo, de cara a poder ofrecer cierto soporte de hilos a las aplicaciones.
Pero también lo son en los sistemas multihilo, ya que debido a su bajo coste en recursos y a su alta eficiencia son ideales cuando la cantidad de hilos a crear —el nivel de concurrencia— va a ser previsiblemente muy alta.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_uno_a_uno"><a class="anchor" href="#_uno_a_uno"></a>12.4.2. Uno a uno</h4>
<div class="paragraph">
<p></p>
</div>
<div class="paragraph">
<p>En el modelo <strong>uno a uno</strong> cada hilo que ve el proceso se mapea en una «entidad planificable en la CPU» diferente del núcleo.</p>
</div>
<div class="paragraph">
<p>Este, por lo general, es el modelo utilizado cuando el núcleo del sistema operativo soporta hilos de ejecución.
En este caso, la librería de hilos se implementa en el núcleo, por lo que las entidades que planifica el núcleo en la CPU son los <strong>hilos de núcleo</strong> y los procesos pueden gestionar estos hilos mediante llamadas al sistema.</p>
</div>
<div id="fig-modelo-uno-a-uno" class="imageblock">
<div class="content">
<img src="media/C12-hilos/modelo_uno_a_uno.svg" alt="modelo uno a uno">
</div>
<div class="title">Figura 40. Modelo uno a uno.</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>Las principales características de este modelo son:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Permite a otros hilos del mismo proceso ejecutarse aun cuando uno de ellos haga una llamada al sistema que debe bloquearse.
El núcleo se encarga de ponerlo en espera y planificar en la CPU a otro de los hilos preparados para ejecutarse de entre todos los existentes en el sistema.</p>
</li>
<li>
<p>Permite paralelismo en sistemas multiprocesador, ya que diferentes hilos pueden ser planificados por el núcleo en distintos procesadores.</p>
</li>
<li>
<p>Crear un hilo para un proceso implica crear ciertas estructuras de datos en el núcleo.
Debido a que la cantidad de memoria disponible para el núcleo suele estar limitada, muchos sistemas restringen la cantidad máxima de <strong>hilos de núcleo</strong> soportados.</p>
</li>
<li>
<p>La gestión de los hilos se hace con una librería en el espacio de núcleo, lo que requiere que el proceso haga llamadas al sistema para gestionarlos.
Esto siempre es más lento que invocar simplemente una función, como ocurre en el modelo <strong>muchos a uno</strong>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>Este modelo se utiliza en la mayor parte de los sistemas operativos multihilo modernos.
Linux, Microsoft Windows —desde Windows 95— <a href="https://es.wikipedia.org/wiki/Solaris_(sistema_operativo)">Solaris</a> 9 y superiores, macOS y la familia de UNIX BSD; son ejemplos de sistemas operativos que utiliza el modelo <strong>uno a uno</strong>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_muchos_a_muchos"><a class="anchor" href="#_muchos_a_muchos"></a>12.4.3. Muchos a muchos</h4>
<div class="paragraph">
<p>
En teoría debería ser posible aprovechar lo mejor de los dos modelos anteriores con una librería de hilos en el núcleo, para crear <strong>hilos de núcleo</strong>, y otra en el espacio de usuario, para crear <strong>hilos de usuario</strong>.
Así los desarrolladores pueden utilizar la librería de hilos en el espacio de usuario para crear tantos hilos como quieran y que se ejecuten sobre los <strong>hilos de núcleo</strong>.</p>
</div>
<div class="paragraph">
<p>El planificador de la librería de hilos se encarga de determinar qué hilo de usuario es asignado a qué hilo de núcleo.
Mientras que el planificador de la CPU asigna la CPU a alguno de los <strong>hilos de núcleo</strong> del sistema.</p>
</div>
<div id="fig-modelo-muchos-a-muchos" class="imageblock">
<div class="content">
<img src="media/C12-hilos/modelo_muchos_a_muchos.svg" alt="modelo muchos a muchos">
</div>
<div class="title">Figura 41. Modelo muchos a muchos.</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>En el modelo <strong>muchos a muchos</strong> se mapean los <strong>hilos de usuario</strong> en un menor o igual número de <strong>hilos de núcleo</strong> del proceso (véase la <a href="hilos.html#fig-modelo-muchos-a-muchos">Figura 41</a>).</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Permite paralelismo en sistemas multiprocesador, ya que diferentes <strong>hilos de núcleo</strong> pueden ser planificados en distintos procesadores y en cada uno puede ejecutarse cualquier hilo de usuario.</p>
</li>
<li>
<p>Permite a otro hilo de usuario del mismo proceso ejecutarse cuando un hilo hace una llamada al sistema que debe bloquearse, puesto que si esto ocurre el correspondiente hilo de núcleo se queda bloqueado.
Sin embargo, el resto de los <strong>hilos de usuario</strong> pueden seguir ejecutándose en los otros <strong>hilos de núcleo</strong> del proceso.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>Este modelo se soportaba en sistemas <a href="https://es.wikipedia.org/wiki/FreeBSD">FreeBSD</a> y versiones antiguas de <a href="https://es.wikipedia.org/wiki/NetBSD">NetBSD</a>, así como en UNIX comerciales, como: <a href="https://es.wikipedia.org/wiki/Solaris_(sistema_operativo)">Solaris</a> 8 y anteriores, <a href="https://es.wikipedia.org/wiki/IRIX">IRIX</a>, <a href="https://es.wikipedia.org/wiki/HP-UX">HP-UX</a> y <a href="https://es.wikipedia.org/wiki/Tru64">Tru64 UNIX</a>.
También Microsoft Windows —a partir de Windows 7— soporta este modelo gracias a incorporar un mecanismo denominado planificación en modo usuario (véase <a href="https://docs.microsoft.com/en-us/windows/win32/procthread/user-mode-scheduling">«User-Mode Scheduling&#8201;&#8212;&#8201;Microsoft Docs»</a>).</p>
</div>
<div class="paragraph">
<p>Algunos lenguajes de programación implementan el modelo <strong>muchos a muchos</strong> sobre el modelo <strong>uno a uno</strong> soportado por la mayoría de sistemas operativos modernos.
Ese es el caso de <a href="https://es.wikipedia.org/wiki/Go_(lenguaje_de_programaci%C3%B3n)">Go</a>, <a href="https://es.wikipedia.org/wiki/Erlang">Erlang</a> y <a href="https://es.wikipedia.org/wiki/Elixir_(lenguaje_de_programaci%C3%B3n)">Elixir</a>.</p>
</div>
<div class="sect4">
<h5 id="_activación_del_planificador"><a class="anchor" href="#_activación_del_planificador"></a>Activación del planificador</h5>
<div class="paragraph">
<p>Tanto en el modelo <strong>muchos a muchos</strong> como en el de <strong>dos niveles</strong> es necesario cierto grado de coordinación entre el núcleo y la librería de hilos del espacio de usuario.
Dicha comunicación tiene como objeto ajustar dinámicamente el número de <strong>hilos de núcleo</strong> para garantizar la máxima eficiencia.</p>
</div>
<div class="paragraph">
<p>Uno de los esquemas de comunicación se denomina <strong>activación del planificador</strong> y consiste en que el núcleo informa a la librería de hilos en espacio de usuario que una llamada al sistema va a bloquear un hilo de un proceso.
Antes de dicha notificación, el núcleo se encarga de crear un nuevo hilo de núcleo en el proceso y se lo pasa a la librería de hilos en la notificación.
Así, el planificador de la librería puede asignarle alguno de los otros <strong>hilos de usuario</strong>, evitando el bloqueo completo del proceso y ajustando el número de <strong>hilos de núcleo</strong> dinámicamente.</p>
</div>
<div class="paragraph">
<p>Debido a la complejidad del mecanismo descrito anteriormente y a la dificultad de coordinar el planificador de la librería de hilos con el de la CPU para obtener un rendimiento óptimo, sistemas como Linux y <a href="https://es.wikipedia.org/wiki/Solaris_(sistema_operativo)">Solaris</a> —a partir de la versión 9— han optado finalmente por el modelo <strong>uno a uno</strong>.</p>
</div>
<div class="paragraph">
<p>Con el objetivo de evitar los problemas derivados del coste de dicho modelo, los desarrolladores de Linux han preferido concentrar sus esfuerzos en conseguir un planificador de CPU más eficiente, así como en reducir los costes de la creación de <strong>hilos de núcleo</strong>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_dos_niveles"><a class="anchor" href="#_dos_niveles"></a>12.4.4. Dos niveles</h4>
<div class="paragraph">
<p>Existe una variación del modelo <strong>muchos a muchos</strong> donde, además de funcionar de la forma comentada anteriormente, se permite que un hilo de usuario quede ligado indefinidamente a un único hilo de núcleo, como en el modelo <strong>uno a uno</strong>.</p>
</div>
<div class="paragraph">
<p>Esta variación se denomina, en ocasiones, modelo de <strong>dos niveles</strong> (véase la <a href="hilos.html#fig-modelo-de-dos-niveles">Figura 42</a>).</p>
</div>
<div id="fig-modelo-de-dos-niveles" class="imageblock">
<div class="content">
<img src="media/C12-hilos/modelo_de_dos_niveles.svg" alt="modelo de dos niveles">
</div>
<div class="title">Figura 42. Modelo muchos a uno.</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_operaciones_sobre_los_hilos"><a class="anchor" href="#_operaciones_sobre_los_hilos"></a>12.5. Operaciones sobre los hilos</h3>
<div class="paragraph">
<p>Como ocurre con los procesos, es necesario que los hilos pueden ser creados y eliminados dinámicamente, por lo que los sistemas operativos deben proporcionar servicios para la creación y cancelación de los mismos.</p>
</div>
<div class="sect3">
<h4 id="_creación_de_hilos"><a class="anchor" href="#_creación_de_hilos"></a>12.5.1. Creación de hilos</h4>
<div class="paragraph">
<p>En un sistema operativo con librería de hilos implementada en el núcleo, todo proceso se crea con un hilo, denominado <strong>hilo principal</strong>.
Este es con el que comienza a ejecutarse el programa al entrar en <a href="https://en.cppreference.com/w/c/language/main_function">main()</a> y el que provoca la terminación de todo el proceso —incluida la terminación de los otros hilos que existan— al retornar de dicha función.</p>
</div>
<div class="paragraph">
<p>El <strong>hilo principal</strong> puede crear otros hilos y estos, a su vez, crear los hilos que necesiten.
Pero, a diferencia de lo que ocurre con los procesos, no existe una relación de padres a hijos ni se crea un árbol de hilos.
Excepto por la característica especial del <strong>hilo principal</strong> de que su finalización significa la terminación del proceso, todos los hilos son iguales entre sí.</p>
</div>
<div class="paragraph">
<p>En el <a href="hilos.html#ejemplo-pthread">Ejemplo 5</a> se puede ver cómo se usa <a href="https://man7.org/linux/man-pages/man3/pthread_create.3.html">pthread_create()</a> en sistemas POSIX que implementan <a href="https://man7.org/linux/man-pages/man7/pthreads.7.html">POSIX Threads</a> para crear varios hilos y esperar a que terminen con <a href="https://man7.org/linux/man-pages/man3/pthread_join.3.html">pthread_join()</a>.</p>
</div>
<div id="ejemplo-pthread" class="exampleblock">
<div class="title">Ejemplo 5. Calcular el factorial de un número con <a href="https://man7.org/linux/man-pages/man7/pthreads.7.html">POSIX Threads</a>.</div>
<div class="content">
<div class="paragraph">
<p>Vamos a calcular el factorial de 122 repartiendo la tarea entre dos hilos con el objeto de paralelizar los cálculos en procesadores multinúcleo.</p>
</div>
<div class="paragraph">
<p>El código fuente completo de este ejemplo está disponible en <a href="https://github.com/ull-esit-sistemas-operativos/ssoo-ejemplos/blob/ocw/src/cap12/pthreads.cpp">pthreads.cpp</a> y, además, permite indicar el número que queramos para calcular el factorial.
En <a href="https://github.com/ull-esit-sistemas-operativos/ssoo-ejemplos/blob/ocw/src/cap12/threads.cpp">threads.cpp</a> se puede estudiar un ejemplo equivalente, pero usando <a href="https://en.cppreference.com/w/cpp/thread/thread">std::thread</a> de la librería estándar de C&#43;&#43;, por lo que también compila en sistemas no POSIX, como Microsoft Windows.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="cpp"><span class="k">struct</span> <span class="nc">factorial_thread_args</span> <i class="conum" data-value="9"></i><b>(9)</b>
<span class="p">{</span>
    <span class="n">BigInt</span> <span class="n">number</span><span class="p">;</span>
    <span class="n">BigInt</span> <span class="n">lower_bound</span><span class="p">;</span>
    <span class="n">BigInt</span> <span class="n">result</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">void</span><span class="o">*</span> <span class="n">factorial_thread</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">arg</span><span class="p">)</span>   <i class="conum" data-value="7"></i><b>(7)</b> <i class="conum" data-value="8"></i><b>(8)</b> <i class="conum" data-value="9"></i><b>(9)</b>
<span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">fmt</span><span class="o">::</span><span class="n">format</span><span class="p">(</span> <span class="s">"Hilo creado: 0x{:x}</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">pthread_self</span><span class="p">()</span> <span class="p">);</span>    <i class="conum" data-value="10"></i><b>(10)</b>

    <span class="n">factorial_thread_args</span><span class="o">*</span> <span class="n">args</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">factorial_thread_args</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span> <i class="conum" data-value="9"></i><b>(9)</b>
    <span class="n">args</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">calculate_factorial</span><span class="p">(</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">lower_bound</span> <span class="p">);</span>

    <span class="k">return</span> <span class="o">&amp;</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">;</span> <i class="conum" data-value="12"></i><b>(12)</b>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">return_code</span><span class="p">;</span>
    <span class="n">pthread_t</span> <span class="n">thread1</span><span class="p">,</span> <span class="n">thread2</span><span class="p">;</span>  <i class="conum" data-value="1"></i><b>(1)</b> <i class="conum" data-value="2"></i><b>(2)</b>

    <span class="n">factorial_thread_args</span> <span class="n">thread1_args</span> <span class="p">{</span>
        <span class="mi">122</span><span class="p">,</span>    <span class="c1">// El primer hilo calcula el factorial multiplicando</span>
        <span class="mi">61</span><span class="p">,</span>     <span class="c1">// desde 122 a 61.</span>
        <span class="mi">0</span>
    <span class="p">};</span>

    <span class="n">factorial_thread_args</span> <span class="n">thread2_args</span> <span class="p">{</span>
        <span class="mi">60</span><span class="p">,</span>     <span class="c1">// El segundo hilo calcula el factorial multiplicando</span>
        <span class="mi">2</span><span class="p">,</span>      <span class="c1">// desde 60 a 2</span>
        <span class="mi">0</span>
    <span class="p">};</span>

    <span class="kt">int</span> <span class="n">return_code</span> <span class="o">=</span> <span class="n">pthread_create</span><span class="p">(</span> <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="o">&amp;</span><span class="n">thread1</span><span class="p">,</span>           <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="nb">nullptr</span><span class="p">,</span>            <i class="conum" data-value="6"></i><b>(6)</b>
        <span class="n">factoria_thread</span><span class="p">,</span>    <i class="conum" data-value="7"></i><b>(7)</b>
        <span class="o">&amp;</span><span class="n">thread_args</span> <span class="p">);</span>      <i class="conum" data-value="8"></i><b>(8)</b> <i class="conum" data-value="9"></i><b>(9)</b>

    <span class="k">if</span> <span class="p">(</span><span class="n">return_code</span><span class="p">)</span> <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="n">fmt</span><span class="o">::</span><span class="n">format</span><span class="p">(</span> <span class="s">"Error ({}) al crear el hilo: {}</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
            <span class="n">return_code</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">return_code</span><span class="p">)</span> <span class="p">);</span> <i class="conum" data-value="5"></i><b>(5)</b>
        <span class="k">return</span> <span class="n">EXIT_FAILURE</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">return_code</span> <span class="o">=</span> <span class="n">pthread_create</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">thread2</span><span class="p">,</span> <span class="cm">/* ... */</span> <span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">return_code</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// ...</span>
    <span class="p">}</span>

    <span class="n">BigInt</span><span class="o">*</span> <span class="n">thread1_result</span><span class="p">,</span> <span class="o">*</span><span class="n">thread2_result</span><span class="p">;</span>
    <span class="n">pthread_join</span><span class="p">(</span> <i class="conum" data-value="11"></i><b>(11)</b>
        <span class="n">thread1</span><span class="p">,</span>
        <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">**&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">thread1_result</span><span class="p">)</span> <span class="p">);</span> <i class="conum" data-value="13"></i><b>(13)</b>
    <span class="n">pthread_join</span><span class="p">(</span> <span class="n">thread2</span><span class="p">,</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">**&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">thread2_result</span><span class="p">)</span> <span class="p">);</span>

    <span class="c1">// Multiplicar ambos resultados para obtener el factorial</span>
    <span class="k">auto</span> <span class="n">result</span> <span class="o">=</span> <span class="o">*</span><span class="n">thread1_result</span> <span class="o">*</span> <span class="o">*</span><span class="n">thread2_result</span><span class="p">;</span>

    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">fmt</span><span class="o">::</span><span class="n">format</span><span class="p">(</span> <span class="s">"El factorial de {} es {}</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
        <span class="n">number</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span> <span class="n">result</span><span class="p">.</span><span class="n">to_string</span><span class="p">()</span> <span class="p">);</span>

    <span class="k">return</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>En <a href="https://man7.org/linux/man-pages/man7/pthreads.7.html">POSIX Threads</a> se usa <a href="https://man7.org/linux/man-pages/man3/pthread_create.3.html">pthread_create()</a> para crear hilos.
Devuelve un manejador de tipo <code>pthread_t</code> que podemos usar con otras funciones de la API para indicar el hilo que queremos gestionar.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>pthread_t</code> no es el equivalente al PID de los hilos.
Si el sistema implementa la librería de hilos en el núcleo, por lo general, cada hilo tiene un identificador único; pero <a href="https://man7.org/linux/man-pages/man7/pthreads.7.html">POSIX Threads</a> no ofrece una forma de obtenerlo.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>La variable <code>pthread_t</code> se pasa a <a href="https://man7.org/linux/man-pages/man3/pthread_create.3.html">pthread_create()</a> como puntero para que al retornar, si todo ha ido bien, contenga el manejador del hilo.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Si el hilo se puede crear, <a href="https://man7.org/linux/man-pages/man3/pthread_create.3.html">pthread_create()</a> devuelve 0.
En caso contrario devuelve un código de error.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Los códigos de error son los mismos que hasta ahora veíamos en <a href="https://man7.org/linux/man-pages/man3/errno.3.html">errno</a>.
Así que podemos llamar a <a href="https://man7.org/linux/man-pages/man3/strerror.3.html">strerror()</a> pasando el valor retornado, para obtener un texto descriptivo del error.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Es opcional pasar a <a href="https://man7.org/linux/man-pages/man3/pthread_create.3.html">pthread_create()</a> una estructura con atributos tales como: tamaño y posición de la pila, política y parámetros de planificación, entre otros.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Todo hilo tiene una función principal que será donde comience la ejecución del hilo.
Cuando esa función termine, el hilo finalizará.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Los hilos pueden recibir un argumento en la forma de un puntero a <code>void*</code>.
Si queremos pasar varios, lo más sencillo es crear una estructura.</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>En este ejemplo definimos <code>factorial_thread_args</code> para pasar los argumentos a los hilos y lo pasamos como <code>void *</code> a la función principal.
Allí hacemos un <em>typecast</em> para recuperar el puntero a la estructura <code>factorial_thread_args</code> y poder acceder a sus campos.</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>En cualquier momento se puede llamar a <a href="https://man7.org/linux/man-pages/man3/pthread_self.3.html">pthread_self()</a> para obtener el manejador <code>pthread_t</code> del hilo actual.</td>
</tr>
<tr>
<td><i class="conum" data-value="11"></i><b>11</b></td>
<td>El hilo que invoca <a href="https://man7.org/linux/man-pages/man3/pthread_join.3.html">pthread_join()</a> se queda dormido hasta que el hilo indicado en el primer argumento termine.
Si el hilo principal sale de <a href="https://en.cppreference.com/w/c/language/main_function">main()</a> sin esperar a que todos los hilos del proceso terminen, estos mueren inmediatamente, junto con el proceso.</td>
</tr>
<tr>
<td><i class="conum" data-value="12"></i><b>12</b></td>
<td>El hilo puede retornar un resultado mediante un puntero 'void*'.
Esto se indica en la sentencia <code>return</code> de la función principal del hilo o invocando <a href="https://man7.org/linux/man-pages/man3/pthread_exit.3.html">pthread_exit()</a> para terminar.</td>
</tr>
<tr>
<td><i class="conum" data-value="13"></i><b>13</b></td>
<td>La función <a href="https://man7.org/linux/man-pages/man3/pthread_join.3.html">pthread_join()</a> acepta un puntero a <code>void*</code> para devolver ese valor de retorno al hilo que la invoca.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Como los hilos de <a href="https://man7.org/linux/man-pages/man7/pthreads.7.html">POSIX Threads</a> devuelven punteros, es importante no intentar devolver variables locales, ya que se destruirán cuando el hilo termine y el punto devuelto no será válido.</p>
</div>
<div class="paragraph">
<p>Una alternativa es devolver los resultados a través de la estructura pasada como argumento.
Por ejemplo, el campo <code>result</code> de la estructura <code>factorial_thread_args</code> ofrece una manera más cómoda de obtener el resultado del cálculo de cada hilo.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_cancelación_de_hilos"><a class="anchor" href="#_cancelación_de_hilos"></a>12.5.2. Cancelación de hilos</h4>
<div class="paragraph">
<p>La <strong>cancelación</strong> es la operación de terminar un hilo antes de que termine su trabajo.
Por ejemplo, en un navegador web un hilo se puede encargar de la interfaz de usuario mientras otros hilos se encargan de descargar las páginas y las imágenes de la misma.
Si el usuario pulsa el botón <strong>Cancelar</strong> es necesario que todos los hilos que intervienen en la descarga sean cancelados.</p>
</div>
<div class="paragraph">
<p>Esto puede ocurrir de dos maneras:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>En la <strong>cancelación asíncrona</strong> el hilo termina inmediatamente.
Esto puede causar problemas al no liberarse los recursos reservados en el proceso por parte del hilo
Por ejemplo, antes de terminar no se cierran archivos abiertos ni se libera memoria de los que solo este hilo tiene los descriptores de archivo y los punteros, respectivamente.</p>
<div class="paragraph">
<p>Además, si el hilo que termina estaba modificando datos que compartía con otros hilos, estos cambios podrían quedar a medias.
Esto puede dejar las estructuras de datos compartidas en un estado inconsistente, causando problemas en otros hilos.</p>
</div>
</li>
<li>
<p>En la <strong>cancelación en diferido</strong> el hilo comprueba periódicamente cuando debe terminar.
Si no se tiene cuidado, los problemas pueden ser similares a los de la <strong>cancelación asíncrona</strong>.
La diferencia es que ahora el desarrollador conoce de antemano los puntos donde podría terminar el hilo, lo que da una oportunidad de introducirlos solo donde sea seguro terminar.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Nota"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Se denomina <strong>fuga de memoria</strong> al error que ocurre cuando un bloque de memoria reservada no se libera durante la ejecución del programa.
También pueden ocurrir fugas con otros recursos del sistema operativo, como: archivos, <em>sockets</em>, colas de mensajes o regiones de memoria compartida.</p>
</div>
<div class="paragraph">
<p>Generalmente ocurre porque se pierden todas las referencias a un recurso, por lo que ya no hay oportunidad de liberarlo.
Por ejemplo, cuando se cancela un hilo que es el único que tiene algunas referencias, sin liberar antes esos recursos.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_cancelación_en_posix_threads"><a class="anchor" href="#_cancelación_en_posix_threads"></a>12.5.3. Cancelación en POSIX Threads</h4>
<div class="paragraph">
<p>En <a href="https://man7.org/linux/man-pages/man7/pthreads.7.html">POSIX Threads</a> un hilo puede solicitar la cancelación de otro hilo usando <a href="https://man7.org/linux/man-pages/man3/pthread_cancel.3.html">pthread_cancel()</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="kt">int</span> <span class="n">return_code</span> <span class="o">=</span> <span class="n">pthread_cancel</span><span class="p">(</span><span class="kr">thread</span><span class="p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El hilo identificado por el manejador <code>thread</code> será cancelado si está configurado como cancelable.
Por defecto todos los hilos son cancelables, pero eso lo puede cambiar el propio hilo llamando a <a href="https://man7.org/linux/man-pages/man3/pthread_setcancelstate.3.html">pthread_setcancelstate()</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="kt">int</span> <span class="n">return_code</span> <span class="o">=</span> <span class="n">pthread_setcancelstate</span><span class="p">(</span>
    <span class="n">PTHREAD_CANCEL_DISABLE</span><span class="p">,</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="o">&amp;</span><span class="n">oldstate</span>               <i class="conum" data-value="2"></i><b>(2)</b>
<span class="p">);</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Con <code>PTHREAD_CANCEL_DISABLE</code> se desactiva la cancelación en el hilo que llama la función.
El otro valor posible es <code>PTHREAD_CANCEL_ENABLE</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>La función devuelve a través de un puntero a <code>int</code> el valor anterior del estado de cancelación.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>El tipo de cancelación se puede configurar con <a href="https://www.man7.org/linux/man-pages/man3/pthread_setcanceltype.3.html">pthread_setcanceltype()</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="kt">int</span> <span class="n">return_code</span> <span class="o">=</span> <span class="n">pthread_setcanceltypr</span><span class="p">(</span>
    <span class="n">PTHREAD_CANCEL_DEFERRED</span><span class="p">,</span>    <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="o">&amp;</span><span class="n">oldtype</span>                    <i class="conum" data-value="2"></i><b>(2)</b>
<span class="p">);</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Con <code>PTHREAD_CANCEL_DEFERRED</code> se activa la <strong>cancelación en diferido</strong>, que de todas formas es el tipo de cancelación por defecto. El otro valor posible es <code>PTHREAD_CANCEL_ASYNCHRONOUS</code>, que corresponde con la <strong>cancelación asíncrona</strong>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>La función devuelve a través de un puntero a <code>int</code> el valor anterior del tipo de cancelación.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Se pueden cambiar entre estado y tipo de cancelación en cualquier momento, según lo que encaje mejor con las características de las distintas partes del código.</p>
</div>
<div class="sect4">
<h5 id="_cancelación_asíncrona"><a class="anchor" href="#_cancelación_asíncrona"></a>Cancelación asíncrona</h5>
<div class="paragraph">
<p>
Por los motivos comentados anteriormente, no es recomendable la <strong>cancelación asíncrona</strong>, a menos que estemos muy seguros de que no puede causar problemas.
Uno de los pocos casos con los que es compatible es en bucles 100% dedicados a ejecutar cálculos en la CPU, como el siguiente:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="kt">int</span> <span class="n">factorial</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">for</span> <span class="p">(</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">number</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="n">factorial</span> <span class="o">=</span> <span class="n">factorial</span> <span class="o">*</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La <strong>cancelación asíncrona</strong> no se debe usar si el código reserva memoria dinámicamente o solicita otros recursos del sistema operativo, porque el hilo podría terminar en cualquier momento sin liberarlos.
Tampoco si se modifican estructuras de datos, porque los cambios pueden quedar a medias.</p>
</div>
<div class="paragraph">
<p>Por ejemplo, si la cancelación ocurre en medio de una llamada a <a href="https://en.cppreference.com/w/c/memory/malloc">malloc()</a> o <a href="https://en.cppreference.com/w/cpp/language/new">new</a> no hay forma de saber si ocurrió antes de que la memoria fuera reservada o después.
Incluso puede haber ocurrido en medio de la operación, dejando en estado inconsistente las estructuras de datos que sirven para seguir la pista de las zonas de memoria reservadas y libres.</p>
</div>
<div class="paragraph">
<p>El estándar POSIX solo indica que las funciones <a href="https://man7.org/linux/man-pages/man3/pthread_setcancelstate.3.html">pthread_setcancelstate()</a> y <a href="https://www.man7.org/linux/man-pages/man3/pthread_setcanceltype.3.html">pthread_setcanceltype()</a> deben ser seguras frente a la <strong>cancelación asíncrona</strong> del hilo.
En general, no se puede llamar a otras funciones de la librería del sistema de forma segura en un hilo cancelable asíncronamente.</p>
</div>
</div>
<div class="sect4">
<h5 id="_cancelación_en_diferido"><a class="anchor" href="#_cancelación_en_diferido"></a>Cancelación en diferido</h5>
<div class="paragraph">
<p>
Por tanto, la <strong>cancelación en diferido</strong> es la mejor alternativa.
Con este tipo de cancelación, la terminación del hilo ocurre en puntos concretos del código.</p>
</div>
<div class="paragraph">
<p>En la terminología de <a href="https://man7.org/linux/man-pages/man7/pthreads.7.html">POSIX Threads</a> a estos puntos se los denomina <strong>puntos de cancelación</strong> y la inmensa mayoría de las llamadas al sistema que puede poner el hilo en estado <strong>esperando</strong> lo son por sí mismas.
Por ejemplo, <a href="https://man7.org/linux/man-pages/man2/open.2.html">open()</a>, <a href="https://man7.org/linux/man-pages/man2/close.2.html">close()</a>, <a href="https://man7.org/linux/man-pages/man2/read.2.html">read()</a>, <a href="https://man7.org/linux/man-pages/man2/write.2.html">write()</a>, <a href="https://man7.org/linux/man-pages/man2/recv.2.html">recv()</a>, <a href="https://man7.org/linux/man-pages/man2/send.2.html">send()</a>, <a href="https://man7.org/linux/man-pages/man2/poll.2.html">poll()</a> y <a href="https://man7.org/linux/man-pages/man3/sleep.3.html">sleep()</a>, entre muchas otras (véase la lista en la sección «<em>Cancellation points</em>» de la documentación de <a href="https://man7.org/linux/man-pages/man7/pthreads.7.html">POSIX Threads</a>).
Eso significa que seguramente también sean <strong>puntos de cancelación</strong>, las funciones de la librería del sistema y de la librería estándar del lenguaje que utilizan esas llamadas al sistema.</p>
</div>
<div class="paragraph">
<p>Sabiendo esto, se puede estudiar cada caso.
Si no es seguro permitir la cancelación de un hilo en la invocación de una de estas funciones en nuestro código, se puede usar <a href="https://man7.org/linux/man-pages/man3/pthread_setcancelstate.3.html">pthread_setcancelstate()</a> para desactivar temporalmente el mecanismo de cancelación.
Por ejemplo, una llamada a <a href="https://en.cppreference.com/w/c/io/fprintf">printf()</a> como ayuda para depurar, en medio de los pasos para modificar una estructura de datos —como una lista enlazada o una cola— introduce un <strong>punto de cancelación</strong> en lugar poco seguro; porque si el hilo se cancela en ese punto, la estructura de datos quedará en estado inconsistente.
La solución es eliminar la llamada a <a href="https://en.cppreference.com/w/c/io/fprintf">printf()</a> o desactivar temporalmente el mecanismo de cancelación.</p>
</div>
<div class="paragraph">
<p>De forma inversa, se pueden introducir manualmente puntos de cancelación llamando a <a href="https://man7.org/linux/man-pages/man3/pthread_testcancel.3.html">pthread_testcancel()</a>.
Por ejemplo, el siguiente bucle no hace llamadas al sistema, por lo que no tiene puntos de cancelación:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="kt">int</span> <span class="n">factorial</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">for</span> <span class="p">(</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">number</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="n">factorial</span> <span class="o">=</span> <span class="n">factorial</span> <span class="o">*</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Eso significa que ese código para calcular el factorial de <code>number</code> podría ejecutarse durante bastante tiempo sin ofrecer una oportunidad para cancelar el hilo; incluso aunque es un código muy seguro desde el punto de vista de la cancelación.
La solución es introducir manualmente un punto de cancelación:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="kt">int</span> <span class="n">factorial</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">for</span> <span class="p">(</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">number</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="n">factorial</span> <span class="o">=</span> <span class="n">factorial</span> <span class="o">*</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">pthread_testcancel</span><span class="p">();</span>   <i class="conum" data-value="1"></i><b>(1)</b>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Comprobar si se ha solicitado la cancelación del hilo y si es así, cancelar el hilo.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>La <strong>cancelación en diferido</strong> también presenta retos desde el punto de vista de evitar las fugas de memoria y de otros recursos cuando un hilo es cancelado.
Por ejemplo, supongamos que tenemos una función que abre una tubería, crea un hilo para gestionar los mensajes que llegan y devuelve un puntero a una estructura de datos que se puede usar en otras funciones de la librería —de forma similar a <a href="https://en.cppreference.com/w/c/io/fopen">fopen()</a> y <code>FILE*</code>—:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="n">CONN</span><span class="o">*</span> <span class="nf">conn_open</span><span class="p">(</span> <span class="cm">/* ... */</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="n">CONN</span><span class="o">*</span> <span class="n">handler</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">CONN</span><span class="p">)</span> <span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">handler</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">handler</span><span class="o">-&gt;</span><span class="n">fifofd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span> <span class="cm">/* ... */</span> <span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fifofd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">free</span><span class="p">(</span> <span class="n">handler</span> <span class="p">);</span> <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">int</span> <span class="n">return_code</span> <span class="o">=</span> <span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">handler</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">,</span> <span class="cm">/* ... */</span><span class="p">,</span> <span class="n">handler</span> <span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">return_code</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">close</span><span class="p">(</span> <span class="n">handler</span><span class="o">-&gt;</span><span class="n">fifofd</span> <span class="p">);</span> <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="n">free</span><span class="p">(</span> <span class="n">handler</span> <span class="p">);</span> <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">handler</span><span class="p">;</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Evitar la <strong>fuga de memoria</strong> si <a href="https://man7.org/linux/man-pages/man2/open.2.html">open()</a> o <a href="https://man7.org/linux/man-pages/man3/pthread_create.3.html">pthread_create()</a> fallan.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Evitar la fuga del <em>socket</em> si <a href="https://man7.org/linux/man-pages/man3/pthread_create.3.html">pthread_create()</a> falla.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Este código y la forma en que maneja los errores funcionan bien en programas monohilo, porque estamos seguros de que al salir de la función o se completaron todas las etapas o ninguna.
Es decir, si alguna de las peticiones al sistema falla, las hechas anteriormente se «deshacen» para evitar la fuga de recursos.</p>
</div>
<div class="paragraph">
<p>Pero no es correcto en programas multihilo porque <a href="https://man7.org/linux/man-pages/man2/open.2.html">open()</a> y <a href="https://man7.org/linux/man-pages/man2/close.2.html">close()</a> son <strong>puntos de cancelación</strong>.
Si <code>conn_open()</code> es llamada desde un hilo y ese hilo es cancelado, el hilo podría terminar a mitad de la función, sin liberar <code>handler</code>, creando una <strong>fuga de memoria</strong> que no se liberará hasta que el proceso termine.
Si <code>conn_open()</code> es llamada en múltiples ocasiones, cada una es una oportunidad para perder memoria.</p>
</div>
<div class="paragraph">
<p>El código anterior se puede mejorar usando <strong>manejadores de limpieza</strong>.
Esos manejadores se organizan en una pila de la que se pueden insertar o extraer llamando a <a href="https://man7.org/linux/man-pages/man3/pthread_cleanup_push.3.html">pthread_cleanup_push()</a> y <a href="https://man7.org/linux/man-pages/man3/pthread_cleanup_pop.3.html">pthread_cleanup_pop()</a>, respectivamente.
Cuando el hilo es cancelado, la librería extrae los manejadores de la pila y los va ejecutando en orden, antes de terminar.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="n">CONN</span><span class="o">*</span> <span class="nf">conn_open</span><span class="p">(</span> <span class="cm">/* ... */</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="n">CONN</span><span class="o">*</span> <span class="n">handler</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">CONN</span><span class="p">)</span> <span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">handler</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">pthread_cleanup_push</span><span class="p">(</span><span class="o">&amp;</span><span class="n">free</span><span class="p">,</span> <span class="n">handler</span><span class="p">);</span> <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="n">handler</span><span class="o">-&gt;</span><span class="n">fifofd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span> <span class="cm">/* ... */</span> <span class="p">);</span>  <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="k">if</span> <span class="p">(</span><span class="n">fifofd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">pthread_cleanup_pop</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>     <span class="c1">// free(handler) </span><i class="conum" data-value="3"></i><b>(3)</b>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">pthread_cleanup_push</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cleanup_fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">handler</span><span class="o">-&gt;</span><span class="n">fifofd</span><span class="p">);</span>

    <span class="kt">int</span> <span class="n">return_code</span> <span class="o">=</span> <span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">handler</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">,</span> <span class="cm">/* ... */</span><span class="p">,</span> <span class="n">handler</span> <span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">return_code</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">close</span><span class="p">(</span> <span class="n">handler</span><span class="o">-&gt;</span><span class="n">fifofd</span> <span class="p">);</span> <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="n">pthread_cleanup_pop</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>     <span class="c1">// free(handler) </span><i class="conum" data-value="3"></i><b>(3)</b>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">pthread_cleanup_pop</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <i class="conum" data-value="4"></i><b>(4)</b>

    <span class="k">return</span> <span class="n">handler</span><span class="p">;</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Nada más reservar la memoria de <code>CONN</code> se añade un <strong>manejador de limpieza</strong> que llamará a <code>free(handler)</code> si el hilo va a ser cancelado.
Así nos aseguramos que <code>handler</code> será liberado si el hilo es cancelado.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>La cancelación solo puede ocurrir en los <strong>puntos de cancelación</strong> que son las llamadas a <a href="https://man7.org/linux/man-pages/man2/open.2.html">open()</a> y <a href="https://man7.org/linux/man-pages/man2/close.2.html">close()</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>En caso de error, el <strong>manejador de limpieza</strong> ya no hace falta, así que se extrae antes de salir de la función.
Se llama a <a href="https://man7.org/linux/man-pages/man3/pthread_cleanup_pop.3.html">pthread_cleanup_pop()</a> con valor distinto de 0 porque así la función extrae el manejador y lo invoca.
A fin de cuentas se sale a causa de un error, por lo que sigue siendo necesario ejecutar <code>free(handler)</code> para evitar una <strong>fuga de memoria</strong>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Al terminar la función se extraen todos los manejadores de señal, puesto que ya no hacen falta.
El argumento 0 hace que <a href="https://man7.org/linux/man-pages/man3/pthread_cleanup_pop.3.html">pthread_cleanup_pop()</a> no ejecute el manejador de limpieza extraído.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Ahora <code>conn_open()</code> maneja correctamente la cancelación del hilo donde se ejecuta, por lo que puede usarse sin problemas en aplicaciones multihilo.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_cancelación_de_hilos_en_lenguajes_de_alto_nivel"><a class="anchor" href="#_cancelación_de_hilos_en_lenguajes_de_alto_nivel"></a>12.5.4. Cancelación de hilos en lenguajes de alto nivel</h4>
<div class="paragraph">
<p>El mecanismo de cancelación de hilos descrito funciona razonablemente bien en C, pero no con lenguajes de más alto nivel, como C&#43;&#43;, Java o C#.
Las librerías de hilos suelen ser librerías en C, que no conocen nada de objetos ni de otras particularidades de esos lenguajes.</p>
</div>
<div class="paragraph">
<p>Por ejemplo, en C&#43;&#43;, antes de terminar un hilo, deberían ser llamados todos los destructores de los objetos locales, para evitar <strong>fugas de memoria</strong> y de otros recursos, datos sin escribir y otros problemas derivados de tener objetos que no se destruyen adecuadamente.
Lamentablemente, el mecanismo de cancelación de <a href="https://man7.org/linux/man-pages/man7/pthreads.7.html">POSIX Threads</a> —y el de otras librerías de hilos, como la de Windows API— no sabe hacer nada de eso.
Cada lenguaje debe implementar su propia solución.</p>
</div>
<div class="paragraph">
<p>En Java y C#, por ejemplo, cuando un punto de cancelación detecta una petición de cancelación emite la excepción <code>Thread.Interrupt</code>, que retrocede por la pila de llamadas, liberando las variables locales hasta salir por el método principal del hilo.
A este mecanismo se lo denomina <strong>cancelación coordinada</strong>.</p>
</div>
<div class="paragraph">
<p>En C&#43;&#43; no se ha incluido un mecanismo de cancelación en el estándar hasta C&#43;&#43;20.
Antes de C&#43;&#43;20, la forma recomendada de implementar la cancelación es pasando a los hilos una variable de tipo <code>bool</code> con la que señalarles cuándo deben terminar.
El código de los hilos debe comprobar frecuentemente el valor de dicha variable y, llegado el momento, terminar retornando ordenadamente por la función principal del hilo.</p>
</div>
<div class="paragraph">
<p>En C&#43;&#43;20 esta estrategia de <strong>cancelación cooperativa</strong> se ha formalizado e incluido en el estándar al introducir la clase <a href="https://en.cppreference.com/w/cpp/thread/jthread">std::jthread</a>.
Esta nueva clase de hilo puede pasar a la función principal lo que se llama un <strong><em>token</em> de cancelación</strong> —en lugar de una variable tipo <code>bool</code>— que se debe comprobar regularmente para saber si hay que terminar el hilo prematuramente.</p>
</div>
<div class="paragraph">
<p>Por ejemplo, la función del factorial podría hacer uso de esa funcionalidad para terminar cuando se lo indiquen:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="cpp"><span class="kt">void</span> <span class="nf">compute_factorial</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">stop_token</span> <span class="n">stoken</span><span class="p">,</span> <span class="kt">int</span><span class="o">&amp;</span> <span class="n">factorial</span><span class="p">,</span> <span class="kt">int</span> <span class="n">number</span><span class="p">)</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="p">{</span>
    <span class="n">factorial</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">number</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="n">stoken</span><span class="p">.</span><span class="n">stop_requested</span><span class="p">())</span> <span class="k">return</span><span class="p">;</span> <i class="conum" data-value="4"></i><b>(4)</b>
        <span class="n">factorial</span> <span class="o">=</span> <span class="n">factorial</span> <span class="o">*</span> <span class="n">i</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// ...</span>

    <span class="kt">int</span> <span class="n">factorial</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">jthread</span> <span class="kr">thread</span><span class="p">(</span><span class="n">compute_factorial</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">ref</span><span class="p">(</span><span class="n">factorial</span><span class="p">),</span> <span class="mi">122</span><span class="p">);</span>  <i class="conum" data-value="1"></i><b>(1)</b> <i class="conum" data-value="2"></i><b>(2)</b>

    <span class="c1">// ...</span>

    <span class="kr">thread</span><span class="p">.</span><span class="n">request_stop</span><span class="p">();</span> <i class="conum" data-value="3"></i><b>(3)</b>

    <span class="c1">// ...</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Crear e iniciar el hilo con <a href="https://en.cppreference.com/w/cpp/thread/jthread">std::jthread</a> para calcular el factorial de 122.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Al crear el hilo se pasa a la función el <strong><em>token</em> de cancelación</strong> <code>stoken</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>En algún momento de la ejecución del programa pedimos al hilo que se detenga antes de terminar los cálculos.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>El código del hilo debe comprobar el <strong><em>token</em> de cancelación</strong> regularmente.
Si se ha pedido la cancelación, se termina el hilo retornando desde la función principal.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Java y C# han terminado incluyendo también este tipo de <strong>cancelación cooperativa</strong> usando un <strong><em>token</em> de cancelación</strong>, debido a los problemas que tienen los desarrolladores para recordar usar correctamente la excepción de la <strong>cancelación coordinada</strong>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_otras_consideraciones_sobre_los_hilos"><a class="anchor" href="#_otras_consideraciones_sobre_los_hilos"></a>12.6. Otras consideraciones sobre los hilos</h3>
<div class="sect3">
<h4 id="_las_llamadas_al_sistema_fork_y_exec_en_procesos_multihilo"><a class="anchor" href="#_las_llamadas_al_sistema_fork_y_exec_en_procesos_multihilo"></a>12.6.1. Las llamadas al sistema fork() y exec() en procesos multihilo</h4>
<div class="paragraph">
<p>La llamada al sistema <a href="https://man7.org/linux/man-pages/man2/fork.2.html">fork()</a> de los sistemas POSIX es anterior a la existencia del concepto de <strong>hilo</strong>.
Así que cuando estos aparecieron surgió el problema de si al llamar a <a href="https://man7.org/linux/man-pages/man2/fork.2.html">fork()</a> en un proceso multihilo:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>El nuevo proceso debía tener un duplicado de todos los hilos.</p>
</li>
<li>
<p>O el nuevo proceso debía tener un único hilo copia del que invocó a <a href="https://man7.org/linux/man-pages/man2/fork.2.html">fork()</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Como hemos comentado anteriormente, la llamada al sistema <a href="https://man7.org/linux/man-pages/man2/fork.2.html">fork()</a> sustituye el programa en ejecución con un nuevo programa e inicia su ejecución en <a href="https://en.cppreference.com/w/c/language/main_function">main()</a>.
Esto incluye liberar toda la memoria reservada y la destrucción de todos los hilos del programa original, por lo que duplicar los hilos en el proceso hijo creado por <a href="https://man7.org/linux/man-pages/man2/fork.2.html">fork()</a>, si luego se va a llamar a <a href="https://man7.org/linux/man-pages/man3/exec.3.html">exec()</a> parece algo innecesario.</p>
</div>
<div class="paragraph">
<p>El estándar POSIX establece que si se utiliza <a href="https://man7.org/linux/man-pages/man2/fork.2.html">fork()</a> en un programa multihilo, el nuevo proceso debe ser creado con un solo hilo, que será una réplica del que hizo la llamada, así como un duplicado completo del espacio de direcciones del proceso.</p>
</div>
<div class="paragraph">
<p>Sin embargo, algunos sistemas UNIX tienen una segunda llamada no estándar denominada <code>forkall()</code>, capaz de duplicar todos los hilos del proceso padre.
Obviamente solo resulta conveniente emplearla si no se va a utilizar la llamada <a href="https://man7.org/linux/man-pages/man3/exec.3.html">exec()</a> a continuación.
La inclusión de <code>forkall()</code> en el estándar POSIX fue considerada y rechazada.</p>
</div>
</div>
<div class="sect3">
<h4 id="_manejo_de_señales_en_procesos_multihilo"><a class="anchor" href="#_manejo_de_señales_en_procesos_multihilo"></a>12.6.2. Manejo de señales en procesos multihilo</h4>
<div class="paragraph">
<p>En el <a href="comunicación_mediante_paso_de_mensajes.html#_señales_en_sistemas_operativos_posix">Apartado 10.5.2</a> hablamos del uso de las señales como mecanismo de comunicación, pero en general sirven para informar a un proceso del suceso de ciertos eventos.</p>
</div>
<div class="paragraph">
<p>Existen dos tipos de señales:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Las <strong>señales síncronas</strong> se deben a alguna acción del propio proceso.
Ejemplos de señales de este tipo son <code>SIGSEV</code> y <code>SIGFE</code>, originadas por accesos ilegales a memoria o divisiones por 0, respectivamente.</p>
<div class="paragraph">
<p>Las señales síncronas son enviadas al mismo proceso que las origina.</p>
</div>
</li>
<li>
<p>Las <strong>señales asíncronas</strong> son debidas a acciones externas.
Un ejemplo de este tipo de señales es la terminación de procesos con teclas especiales como <span class="keyseq"><kbd>CTRL</kbd>+<kbd>C</kbd></span> o <kbd>CTRL-D</kbd>, que envían al proceso las señales <code>SIGINT</code> y <code>SIGHUP</code> respectivamente.
También lo son las señales enviadas desde otro proceso, como cuando el proceso <strong>init</strong> envía <code>SIGTERM</code> al resto de procesos para informales que deben terminar porque el sistema se va a apagar.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Como hemos visto, las señales que llegan a un proceso pueden ser interceptadas por una función definida por el programador llamada <strong>manejador de señal</strong>.</p>
</div>
<div class="paragraph">
<p>Las señales también son anteriores a los hilos, por lo que cuando aparecieron los hilos se tuvieron que tomar decisiones sobre cómo iban a encajar ambos conceptos.
Por ejemplo, decidir cuál de los hilos del proceso, será interrumpido cuando llegue una señal, para ejecutar el manejador de señales.</p>
</div>
<div class="sect4">
<h5 id="_señales_enviadas_por_otros_hilos"><a class="anchor" href="#_señales_enviadas_por_otros_hilos"></a>Señales enviadas por otros hilos</h5>
<div class="paragraph">
<p>En los sistemas POSIX multihilo se pueden enviar señales a un proceso:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="n">kill</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">SIGTERM</span><span class="p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En ese caso uno cualquiera de los hilos podrá ser interrumpido para ejecutar el manejador de señal.</p>
</div>
<div class="paragraph">
<p>Cada hilo puede enmascarar las señales que considere llamando a <a href="https://man7.org/linux/man-pages/man3/pthread_sigmask.3.html">pthread_sigmask()</a>
Es decir, cada hilo puede elegir qué señales quiere bloquear para no tener que atenderlas:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="n">sigset_t</span> <span class="n">set</span><span class="p">;</span>               <i class="conum" data-value="1"></i><b>(1)</b>

<span class="n">sigemptyset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">set</span><span class="p">);</span>          <i class="conum" data-value="2"></i><b>(2)</b>
<span class="n">sigaddset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">set</span><span class="p">,</span> <span class="n">SIGINT</span><span class="p">);</span>    <i class="conum" data-value="3"></i><b>(3)</b>
<span class="n">sigaddset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">set</span><span class="p">,</span> <span class="n">SIGUSR1</span><span class="p">);</span>   <i class="conum" data-value="4"></i><b>(4)</b>

<span class="n">pthread_sigmask</span><span class="p">(</span><span class="n">SIG_BLOCK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">set</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span> <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Las máscaras de señales se definen mediante <em>sets</em> de señales.
El tipo de los <em>sets</em> de señales es <code>sigset_t</code>, de cuyo tipo real no deberíamos preocuparnos, por portabilidad.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Para manipular los <em>sets</em> se proporcionan una serie de funciones.
<a href="https://man7.org/linux/man-pages/man3/sigemptyset.3.html">sigemptyset()</a> es para asegurar que el <em>set</em> está vacío.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Añadimos al <em>set</em> la señal <code>SIGINT</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Añadimos al <em>set</em> la señal <code>SIGINT</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Bloqueamos en el hilo actual las señales en el <em>set</em> <code>set</code>,es decir, <code>SIGINT</code> y <code>SIGUSR1</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Así una señal enviada a un proceso interrumpirá a uno de los hilos que no la haya bloqueado.</p>
</div>
<div class="paragraph">
<p>También se puede enviar una señal a un hilo en concreto usando <a href="https://man7.org/linux/man-pages/man3/pthread_kill.3.html">pthread_kill()</a>.
El hilo será interrumpido si no la ha bloqueado.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="n">pthread_kill</span><span class="p">(</span><span class="kr">thread</span><span class="p">,</span> <span class="n">SIGTERM</span><span class="p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Sin embargo, hay que tener en cuenta que el manejo de señales es un recurso del proceso, compartido por todos sus hilos.
Esto quiere decir que si la señal está configurada para ser manejada usando la acción por defecto y dicha acción es terminar, terminará todo el proceso, aunque la señal haya sido dirigida a un hilo en concreto.</p>
</div>
</div>
<div class="sect4">
<h5 id="_señales_enviadas_por_el_sistema"><a class="anchor" href="#_señales_enviadas_por_el_sistema"></a>Señales enviadas por el sistema</h5>
<div class="paragraph">
<p>Lo que queda por ver es a quién va dirigida una señal, cuando es el sistema quién la envía para notificar un evento:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Las señales síncronas son causadas por un error en la ejecución, que en un proceso multihilo es debido a la fallida ejecución de un hilo en particular.
Por eso estas señales se dirigen al hilo que las causa.</p>
</li>
<li>
<p>Las señales asíncronas llegan por causas externas, así que se dirigen al proceso, pudiendo ser entregada a uno de los hilos que no la tenga bloqueada.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>La recomendación es elegir un hilo para el manejo de señales asíncronas, de tal forma que sea el único que no las tenga bloqueadas.
El resto de hilos deberían bloquear estas señales nada más iniciar su ejecución.</p>
</div>
<div class="paragraph">
<p>Si se destina un hilo para esta tarea en exclusiva, este puede utilizar <a href="https://man7.org/linux/man-pages/man3/sigwait.3.html">sigwait()</a> para bloquearse hasta que llegue una señal.
Cuando eso ocurre, la función <a href="https://man7.org/linux/man-pages/man3/sigwait.3.html">sigwait()</a> retorna indicando el número de señal recibida —sin necesitar <strong>manejadores de señal</strong>—.
Entonces el hilo puede solicitar la cancelación de los otros hilos para, por ejemplo, terminar el proceso.</p>
</div>
<div class="paragraph">
<p>Esta estrategia facilita el desarrollo de programas que manejen las señales adecuadamente.
Al utilizar un hilo para manejar las señales, tenemos a nuestra disposición cualquier función <strong>segura en hilos</strong> y sabemos cómo proteger las variables y estructuras de datos compartidas mediante el uso de mecanismos de <strong>sincromización</strong> (véase el <a href="sincronización.html">Capítulo 13</a>).
Mientras que al trabajar con <strong>manejadores de señal</strong> estamos mucho más limitados, porque el código de estos debe ser <strong>reentrante</strong> y solo pueden usar alguna de las pocas funciones de la librería del sistema marcadas como <a href="https://man7.org/linux/man-pages/man7/signal-safety.7.html">seguras en señales</a>.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph nav-footer">
<p>← Anterior: <a href="memoria_compartida.html">Memoria compartida</a> | ↑ Subir: <a href="gestión_de_procesos.html">Gestión de procesos</a> | ⌂ Inicio: <a href="main.html">Sistemas Operativos</a> | Siguiente: <a href="sincronización.html">Sincronización</a> →</p>
</div>
</div>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  messageStyle: "none",
  tex2jax: {
    inlineMath: [["\\(", "\\)"]],
    displayMath: [["\\[", "\\]"]],
    ignoreClass: "nostem|nolatexmath"
  },
  asciimath2jax: {
    delimiters: [["\\$", "\\$"]],
    ignoreClass: "nostem|noasciimath"
  },
  TeX: { equationNumbers: { autoNumber: "none" } }
})
MathJax.Hub.Register.StartupHook("AsciiMath Jax Ready", function () {
  MathJax.InputJax.AsciiMath.postfilterHooks.Add(function (data, node) {
    if ((node = data.script.parentNode) && (node = node.parentNode) && node.classList.contains("stemblock")) {
      data.math.root.display = "block"
    }
    return data
  })
})
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js?config=TeX-MML-AM_HTMLorMML"></script>
<div id="footer">
    <div id="footer-text">
        Esta obra está sujeta a la licencia
        <a href="http://creativecommons.org/licenses/by/4.0/deed.es">Creative Commons Atribución 4.0 Internacional</a>,
        excepto donde se indique lo contrario.
    </div>
</div>
</body>
</html>