<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.17">
<meta name="author" content="JesÃºs Torres">
<title>Sistemas Operativos</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
pre.rouge table td { padding: 5px; }
pre.rouge table pre { margin: 0; }
pre.rouge .cm {
  color: #999988;
  font-style: italic;
}
pre.rouge .cp {
  color: #999999;
  font-weight: bold;
}
pre.rouge .c1 {
  color: #999988;
  font-style: italic;
}
pre.rouge .cs {
  color: #999999;
  font-weight: bold;
  font-style: italic;
}
pre.rouge .c, pre.rouge .ch, pre.rouge .cd, pre.rouge .cpf {
  color: #999988;
  font-style: italic;
}
pre.rouge .err {
  color: #a61717;
  background-color: #e3d2d2;
}
pre.rouge .gd {
  color: #000000;
  background-color: #ffdddd;
}
pre.rouge .ge {
  color: #000000;
  font-style: italic;
}
pre.rouge .gr {
  color: #aa0000;
}
pre.rouge .gh {
  color: #999999;
}
pre.rouge .gi {
  color: #000000;
  background-color: #ddffdd;
}
pre.rouge .go {
  color: #888888;
}
pre.rouge .gp {
  color: #555555;
}
pre.rouge .gs {
  font-weight: bold;
}
pre.rouge .gu {
  color: #aaaaaa;
}
pre.rouge .gt {
  color: #aa0000;
}
pre.rouge .kc {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kd {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kn {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kp {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kr {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kt {
  color: #445588;
  font-weight: bold;
}
pre.rouge .k, pre.rouge .kv {
  color: #000000;
  font-weight: bold;
}
pre.rouge .mf {
  color: #009999;
}
pre.rouge .mh {
  color: #009999;
}
pre.rouge .il {
  color: #009999;
}
pre.rouge .mi {
  color: #009999;
}
pre.rouge .mo {
  color: #009999;
}
pre.rouge .m, pre.rouge .mb, pre.rouge .mx {
  color: #009999;
}
pre.rouge .sa {
  color: #000000;
  font-weight: bold;
}
pre.rouge .sb {
  color: #d14;
}
pre.rouge .sc {
  color: #d14;
}
pre.rouge .sd {
  color: #d14;
}
pre.rouge .s2 {
  color: #d14;
}
pre.rouge .se {
  color: #d14;
}
pre.rouge .sh {
  color: #d14;
}
pre.rouge .si {
  color: #d14;
}
pre.rouge .sx {
  color: #d14;
}
pre.rouge .sr {
  color: #009926;
}
pre.rouge .s1 {
  color: #d14;
}
pre.rouge .ss {
  color: #990073;
}
pre.rouge .s, pre.rouge .dl {
  color: #d14;
}
pre.rouge .na {
  color: #008080;
}
pre.rouge .bp {
  color: #999999;
}
pre.rouge .nb {
  color: #0086B3;
}
pre.rouge .nc {
  color: #445588;
  font-weight: bold;
}
pre.rouge .no {
  color: #008080;
}
pre.rouge .nd {
  color: #3c5d5d;
  font-weight: bold;
}
pre.rouge .ni {
  color: #800080;
}
pre.rouge .ne {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nf, pre.rouge .fm {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nl {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nn {
  color: #555555;
}
pre.rouge .nt {
  color: #000080;
}
pre.rouge .vc {
  color: #008080;
}
pre.rouge .vg {
  color: #008080;
}
pre.rouge .vi {
  color: #008080;
}
pre.rouge .nv, pre.rouge .vm {
  color: #008080;
}
pre.rouge .ow {
  color: #000000;
  font-weight: bold;
}
pre.rouge .o {
  color: #000000;
  font-weight: bold;
}
pre.rouge .w {
  color: #bbbbbb;
}
pre.rouge {
  background-color: #f8f8f8;
}
</style>
<meta name='robots' content='noindex,nofollow'>
<link rel="icon" href="media/extras/favicon.ico" sizes="any">
<link rel="icon" href="media/extras/ssoo-icon.svg" type="image/svg+xml">
<link rel="icon" type="image/png" sizes="192x192" href="media/extras/ssoo-icon-192.png">
<link rel="icon" type="image/png" sizes="512x512" href="media/extras/ssoo-icon-512.png">
<link rel="apple-touch-icon" href="media/extras/ssoo-apple-touch-icon.png"><!-- 180Ã180 -->
<link rel="stylesheet" href="media/extras/inlineDisqussions.css">
<style>
    body {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
    }
    content {
        flex: 1;
    }
    #preamble {
        margin-top: 0.5em;
    }
    #header, #content, #footnotes {
        margin: 0 auto 0 5em
    }
    #content h1>a.anchor, h2>a.anchor, h3>a.anchor,
    #toctitle>a.anchor, .sidebarblock>.content>.title>a.anchor,
    h4>a.anchor, h5>a.anchor, h6>a.anchor {
        color: #ba3925;
    }
    .imageblock {
        text-align: center;
    }
    .imageblock > .content {
        margin-bottom: 1rem;
    }
    .imageblock > .title {
        text-align: inherit;
    }
    .tableblock > .lightcell {
        color: gray;
    }
    table tfoot td p {
        font-weight: bold;
    }
    #footer-text {
        margin: 0 auto;
        max-width: 62.5em;
        padding-left: .9375em;
        padding-right: .9375em;
    }
    #footer-text a {
        color: hsla(0,0%,100%,.8);
        text-decoration: none;
        font-weight: bold;
    }
    #footer-text a:hover {
        color: hsla(0,0%,100%,.8);
    }
</style>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script src="media/extras/inlineDisqussions.js"></script>
<script type="text/javascript">
    window.onload = function(){
        if ('true' === 'true') {
            setTimeout(function() {
                disqus_shortname = 'ull-esit-sistemas-operativos';
                jQuery("img, p, .colist td, .stemblock").not('#toc p').inlineDisqussions();
                query_params = (new URL(document.location)).searchParams;
                if (query_params.has('disqussion')) {
                    let identifier = window.location.pathname + 'disqussion-' + query_params.get('disqussion');
                    let selection = jQuery('[data-disqus-identifier="' +  identifier + '"]').not('.disqussion-link');
                    if (selection.length) {
                        selection[0].scrollIntoView(true);
                    }
                }
            }, 500);
        }
    }
</script>
<style>.toc-current{font-weight: bold;} .toc-root{font-family: "Open Sans","DejaVu Sans",sans-serif;
                       font-size: 0.9em;} #content{display: flex; flex-direction: column; flex: 1 1 auto;}
             .nav-footer{text-align: center; margin-top: auto;}
             .nav-footer > p > a {white-space: nowrap;}</style>
<style>
.admonitionblock td.icon .icon-time:before {content:"\f017";color:#f28500;}
</style>
</head>
<body id="sincronizaciÃ³n" class="book toc2 toc-left">
<div id="header">
<h1>Sistemas Operativos</h1>
<div class="details">
<span id="author" class="author">JesÃºs Torres</span><br>
<span id="email" class="email"><a href="mailto:jmtorres@ull.es">jmtorres@ull.es</a></span><br>
<span id="revdate">Curso 2022-2023</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Tabla de Contenido</div>
<p><span class="toc-root"><a href="main.html">Sistemas Operativos</a></span></p><ul class="sectlevel1">
<li><a href="ediciones_y_licencia.html">Ediciones y licencia</a>
</li>
<li><a href="cÃ³digo_de_los_ejemplos.html">CÃ³digo de los ejemplos</a>
</li>
<li><a href="introducciÃ³n.html">Parte I: IntroducciÃ³n</a>
</li>
<li><a href="organizaciÃ³n_de_los_sistemas_operativos.html">Parte II: OrganizaciÃ³n de los sistemas operativos</a>
</li>
<li><a href="gestiÃ³n_de_procesos.html">Parte III: GestiÃ³n de procesos</a>
<ul class="sectlevel1">
<li><a href="procesos.html">9. Procesos</a>
</li>
<li><a href="comunicaciÃ³n_mediante_paso_de_mensajes.html">10. ComunicaciÃ³n mediante paso de mensajes</a>
</li>
<li><a href="memoria_compartida.html">11. Memoria compartida</a>
</li>
<li><a href="hilos.html">12. Hilos</a>
</li>
<li><a href="sincronizaciÃ³n.html"><span class="toc-current">13. SincronizaciÃ³n</span></a>
<ul class="sectlevel2">
<li><a href="sincronizaciÃ³n.html#_el_problema_de_las_secciones_crÃ­ticas">13.1. El problema de las secciones crÃ­ticas</a>
</li>
<li><a href="sincronizaciÃ³n.html#_sincronizaciÃ³n_por_hardware">13.2. SincronizaciÃ³n por hardware</a>
</li>
<li><a href="sincronizaciÃ³n.html#_semÃ¡foros">13.3. SemÃ¡foros</a>
</li>
<li><a href="sincronizaciÃ³n.html#_mutex">13.4. Mutex</a>
</li>
<li><a href="sincronizaciÃ³n.html#_variables_de_condiciÃ³n">13.5. Variables de condiciÃ³n</a>
</li>
<li><a href="sincronizaciÃ³n.html#_esperas">13.6. Esperas</a>
</li>
<li><a href="sincronizaciÃ³n.html#_funciones_reentrantes_y_seguras_en_hilos">13.7. Funciones reentrantes y seguras en hilos</a>
</li>
</ul>
</li>
<li><a href="planificaciÃ³n_de_la_cpu.html">14. PlanificaciÃ³n de la CPU</a>
</li>
</ul>
</li>
<li><a href="gestiÃ³n_de_la_memoria.html">Parte IV: GestiÃ³n de la memoria</a>
</li>
<li><a href="gestiÃ³n_del_almacenamiento.html">Parte V: GestiÃ³n del almacenamiento</a>
</li>
<li><a href="bibliografÃ­a.html">BibliografÃ­a</a>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="sincronizaciÃ³n"><a class="anchor" href="#sincronizaciÃ³n"></a>13. SincronizaciÃ³n</h2>
<div class="sectionbody">
<div class="admonitionblock time">
<table>
<tr>
<td class="icon">
<i class="fa icon-time" title=""></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>Tiempo de lectura:</strong> 30 minutos</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>En el <a href="memoria_compartida.html">CapÃ­tulo 11</a> vimos que varios procesos pueden compartir regiones de la memoria con el objeto de cooperar en las tareas que deben desempeÃ±ar.
AdemÃ¡s, en el <a href="hilos.html">CapÃ­tulo 12</a> vimos que en los procesos multihilo todos los hilos comparten el espacio de direcciones del proceso al que pertenecen, lo que significa que pueden acceder al mismo tiempo a las variables globales y a la memoria reservada dinÃ¡micamente.</p>
</div>
<div class="paragraph">
<p>Ambas posibilidades introducen algunos riesgos, puesto que el acceso simultÃ¡neo a los datos compartidos puede ocasionar inconsistencias.
AsÃ­ que ha llegado el momento de discutir cÃ³mo se puede asegurar la ejecuciÃ³n ordenada de hilos o procesos cooperativos que comparten regiones de la memoria, con el fin de mantener la consistencia de los datos.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Nota"></i>
</td>
<td class="content">
<div class="paragraph">
<p>En este capÃ­tulo hablaremos de hilos y de procesos que comparten memoria indistintamente.
En ambos casos el problema es el mismo y las soluciones similares.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_el_problema_de_las_secciones_crÃ­ticas"><a class="anchor" href="#_el_problema_de_las_secciones_crÃ­ticas"></a>13.1. El problema de las secciones crÃ­ticas</h3>
<div class="paragraph">
<p>Llamamos <strong>condiciÃ³n de carrera</strong> a la situaciÃ³n en la que varios procesos o hilos pueden acceder y manipular los mismos datos al mismo tiempo âes decir, de forma <strong>concurrente</strong>â y donde el resultado de la ejecuciÃ³n depende del orden particular en el que tienen lugar dichos accesos.
Estas situaciones ocurren frecuentemente en los sistemas operativos, puesto que diferentes componentes del mismo manipulan los mismos recursos interfiriendo unos con otros.</p>
</div>
<div class="sect3">
<h4 id="_problema_del_productor_consumidor"><a class="anchor" href="#_problema_del_productor_consumidor"></a>13.1.1. Problema del productor-consumidor</h4>
<div class="paragraph">
<p>Para ilustrarlo, veamos un problema clÃ¡sico de concurrencia: el <strong>problema del productor-consumidor</strong>.</p>
</div>
<div class="paragraph">
<p>Supongamos que dos hilos o procesos comparten una regiÃ³n de la memoria que contiene un vector de elementos y un contador con el nÃºmero de elementos del vector.</p>
</div>
<div class="paragraph">
<p>El primer hilo realiza varias tareas, que no entraremos a describir.
Lo importante es que, como resultado de esas tareas, en ocasiones aÃ±ade un elemento al vector e incrementa el contador que indica el nÃºmero de elementos en el vector.
Es decir, el primer hilo actÃºa como un <strong>productor</strong> de elementos del vector.</p>
</div>
<div class="paragraph">
<p>A continuaciÃ³n mostramos una porciÃ³n de la funciÃ³n del productor:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="cpp"><span class="k">while</span><span class="p">(</span><span class="cm">/* ... */</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">item</span> <span class="o">=</span> <span class="n">produce_item</span><span class="p">();</span>

    <span class="c1">// Si el vector estÃ¡ lleno, esperar</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="n">VECTOR_SIZE</span><span class="p">);</span>

    <span class="c1">// AÃ±adir el elemento al vector</span>
    <span class="n">vector</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="p">;</span>
    <span class="o">++</span><span class="n">count</span><span class="p">;</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El segundo hilo tambiÃ©n realiza varias tareas que no describiremos.
Pero para realizar esas tareas en ocasiones debe tomar un elemento del vector compartido, decrementando el contador para indicar que ahora hay un elemento menos en el vector.
Es decir, el segundo hilo actÃºa como un <strong>consumidor</strong> de elementos del vector.</p>
</div>
<div class="paragraph">
<p>A continuaciÃ³n mostramos una porciÃ³n de la funciÃ³n del consumidor:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="cpp"><span class="k">while</span><span class="p">(</span><span class="cm">/* ... */</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// Si el vector estÃ¡ vacio, esperar</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

    <span class="c1">// Extraer un elemento del vector</span>
    <span class="o">--</span><span class="n">count</span><span class="p">;</span>
    <span class="n">item</span> <span class="o">=</span> <span class="n">vector</span><span class="p">[</span><span class="n">count</span><span class="p">];</span>

    <span class="n">consume_item</span><span class="p">(</span><span class="n">item</span><span class="p">);</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Nota"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Aunque el <strong>problema del productor-consumidor</strong> parezca artificial, lo cierto es que es muy comÃºn.</p>
</div>
<div class="paragraph">
<p>Por ejemplo, en una herramienta de grabaciÃ³n de audio, el <strong>productor</strong> es un hilo dedicado a obtener bloques de muestras grabadas a travÃ©s de la API multimedia del sistema operativo.
Mientras tanto, otro hilo puede dedicarse a tomar las muestras y realizar diversas transformaciones, como: reducir el ruido, mezclar con otras fuentes de sonido o aplicar algÃºn tipo de efecto digital.
Este segundo hilo es el <strong>consumidor</strong>.
La manera de conectar ambos es tener un vector compartido, donde se depositan los bloques de muestras cuando llegan y de dÃ³nde se extraen para su tratamiento.
AsÃ­, ambos hilos pueden trabajar a su propio ritmo, de forma casi independiente.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Aunque el cÃ³digo anterior del productor y del consumidor es correcto cuando no coinciden en el tiempo al ejecutarse, no funciona adecuadamente cuando sÃ­ lo hacen.
El motivo es que los dos hilos comparten la variable <code>count</code> y tanto las sentencias <code>++count</code> y como <code>--count</code> pueden interrumpirse a medias para dejar paso a la ejecuciÃ³n del otro hilo.</p>
</div>
<div class="paragraph">
<p>Por ejemplo, <code>++count</code> podrÃ­a dividirse por el compilador en las siguientes operaciones, al generar las instrucciones del procesador:</p>
</div>
<div class="listingblock">
<div class="title">++count</div>
<div class="content">
<pre>registro1 = count;
registro1 = registro1 + 1;
count = registro1;</pre>
</div>
</div>
<div class="paragraph">
<p>Donde <code>registro1</code> representa un registro de la CPU.
De forma parecida la sentencia <code>--count</code> podrÃ­a ser implementada de la siguiente manera:</p>
</div>
<div class="listingblock">
<div class="title">--count</div>
<div class="content">
<pre>registro2 = count;
registro2 = registro2 - 1;
count = registro2;</pre>
</div>
</div>
<div class="paragraph">
<p>Donde nuevamente <code>registro2</code> representa un registro de la CPU.
Realmente, aunque <code>registro1</code> y <code>registro2</code> pueden ser el mismo registro fÃ­sico, el contenido de los registros se guarda y se recupera durante los cambios de contexto de un hilo al otro, por lo que cada uno ve sus propios valores y no los del otro.</p>
</div>
<div class="paragraph">
<p>El que las sentencias <code>++count</code> y <code>--count</code> se ejecute de forma concurrente, es similar a que las instrucciones de lenguaje mÃ¡quina de ambas sentencias en ambos hilos o procesos se entrelacen en algÃºn orden aleatorio.</p>
</div>
<div class="paragraph">
<p>Un posible entrelazado de las instrucciones en lenguaje mÃ¡quina entre hilos, suponiendo que inicialmente <code>count = 5</code>, podrÃ­a ser el siguiente:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="c1">// Entra ++count</span>
<span class="n">registro1</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>          <span class="c1">// registro1 = 5</span>
<span class="n">registro1</span> <span class="o">=</span> <span class="n">registro1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>  <span class="c1">// registro1 = 6</span>
<span class="c1">// Sale ++count y entra --count</span>
<span class="n">registro2</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>          <span class="c1">// registro2 = 5</span>
<span class="n">registro2</span> <span class="o">=</span> <span class="n">registro2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>  <span class="c1">// registro2 = 4</span>
<span class="c1">// Sale --count y entra ++count</span>
<span class="n">count</span> <span class="o">=</span> <span class="n">registro1</span><span class="p">;</span>          <span class="c1">// count = 6 </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="c1">// Entra --count</span>
<span class="n">count</span> <span class="o">=</span> <span class="n">registro2</span><span class="p">;</span>          <span class="c1">// count = 4 </span><i class="conum" data-value="1"></i><b>(1)</b> <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>AsÃ­ llegamos al resultado incorrecto <code>count = 4</code>, indicando que hay 4 elementos en el vector cuando realmente hay 5.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Si invertimos el orden de las sentencias obtendremos el resultado, tambiÃ©n incorrecto, <code>count = 6</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Como se puede apreciar, hemos llegado a estos valores incorrectos porque hemos permitido la manipulaciÃ³n concurrente de la variable <code>count</code>.
SegÃºn como se entrelacen las instrucciones de <code>++count</code> y <code>--count</code> en la CPU, el resultado final podrÃ­a ser: 4, 5 o 6.
Pero el Ãºnico resultado correcto es 5, que es el que obtendremos si ejecutamos las sentencias secuencialmente, sin mezclar las operaciones en las que se dividen.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Nota"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Ambos hilos se ejecutan de forma concurrente porque o bien, tenemos un sistema multiprocesador o multinÃºcleo, donde ambos hilos se ejecutan a la vez en procesadores diferentes, o bien, porque tenemos un sistema operativo donde uno de los hilos puede ver interrumpida su ejecuciÃ³n en cualquier momento para asignar la CPU a otro (vÃ©ase el <a href="planificaciÃ³n_de_la_cpu.html#_planificaciÃ³n_expropiativa">Apartado 14.1</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_manipular_estructuras_de_datos"><a class="anchor" href="#_manipular_estructuras_de_datos"></a>13.1.2. Manipular estructuras de datos</h4>
<div class="paragraph">
<p>Obviamente, el problema comentado no aparece solo en sentencias simples, sino tambiÃ©n en bloques de cÃ³digo destinados a hacer tareas complejas, como manipular estructuras de datos.</p>
</div>
<div class="paragraph">
<p>Por ejemplo, supongamos que <code>vector</code> no es un simple <em>array</em> de elementos, sino una lista enlazada, de tal forma que ahora extraer un elemento serÃ­a asÃ­:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="cpp"><span class="o">--</span><span class="n">count</span><span class="p">;</span>
<span class="n">item</span> <span class="o">=</span> <span class="n">vector</span><span class="p">.</span><span class="n">extract</span><span class="p">(</span><span class="n">count</span><span class="p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>y el mÃ©todo <code>extract()</code> tendrÃ­a que dar los siguientes pasos:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Iterar sobre la lista para buscar el nodo en la posiciÃ³n <code>count</code>.</p>
</li>
<li>
<p>Al encontrarlo, preservar en variables locales el puntero a ese nodo y al previo.</p>
</li>
<li>
<p>Cambiar en el nodo previo el puntero al siguiente nodo, para que apunte al nodo tras el que queremos extraer.
En este momento el nodo a extraer ya no pertenece a la lista enlazada.</p>
</li>
<li>
<p>Extrae el <code>item</code> del campo que lo contiene en el nodo.</p>
</li>
<li>
<p>Destruir el nodo.</p>
</li>
<li>
<p>Salir del mÃ©todo retornando el elemento.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Esto genera varios momentos cruciales en torno al paso 3, que puedan dar lugar a <strong>condiciones de carrera</strong>.
Por ejemplo, si el hilo es interrumpido tras guardar el puntero al nodo en una variable local y llega otro hilo que extrae ây destruyeâ antes ese mismo nodo, el puntero ya no es vÃ¡lido âes un <em>dangling pointer</em> o referencia colganteâ al continuar la ejecuciÃ³n del primer hilo.
Y lo mismo ocurre con el puntero al nodo previo o al siguiente, si el hilo es interrumpido y otro hilo destruye antes alguno de ellos.</p>
</div>
<div class="paragraph">
<p>Los problemas que esto puede causar son diversos, segÃºn el momento exacto en el que ocurra.
Puede haberlos al intentar leer el elemento guardado en el nodo en el paso 4, porque este Ãºltimo ya no exista.
TambiÃ©n, al intentar actualizar, en el paso 3, el puntero al siguiente nodo en el nodo previo, porque el nodo previo no exista.
Incluso puede que la funciÃ³n termine con aparente normalidad, pero dejando que el nodo previo apunte a un nodo siguiente que no existe.
En este Ãºltimo supuesto, la lista quedarÃ­a en estado inconsistente y asÃ­ el problema se lo encontrarÃ­a el prÃ³ximo hilo que intente usarla.</p>
</div>
</div>
<div class="sect3">
<h4 id="_exclusiÃ³n_mutua"><a class="anchor" href="#_exclusiÃ³n_mutua"></a>13.1.3. ExclusiÃ³n mutua</h4>
<div class="paragraph">
<p>Para evitar que estas situaciones lleven a la corrupciÃ³n de datos y a caÃ­das de servicios y sistemas, debemos asegurarnos que solo un hilo en cada momento puede manipular recursos y variables compartidas.
Por tanto, necesitamos algÃºn tipo de mecanismo de sincronizaciÃ³n para que mientras se ejecuta <code>++count</code> no se pueda ejecutar <code>--count</code> en otro hilo, ni viceversa.
O para que mientras un hilo haga un <code>insert()</code> o un <code>extract()</code> en una lista, otro no pueda utilizar ni estas ni otras funciones de la misma clase.</p>
</div>
<div class="paragraph">
<p>Para resolver esto, debemos empezar buscando las <strong>secciones crÃ­ticas</strong> de nuestro cÃ³digo.
Una <strong>secciÃ³n crÃ­tica</strong> es una porciÃ³n del cÃ³digo donde se accede a variables, tablas, listas, archivos y otros recursos compartidos.</p>
</div>
<div class="paragraph">
<p>Para evitar <strong>condiciones de carrera</strong>, el acceso a las <strong>secciones crÃ­ticas</strong> debe ser controlado, de manera que cuando un hilo se estÃ© ejecutando en una secciÃ³n de este tipo ningÃºn otro pueda hacerlo en la suya correspondiente para manipular los mismos recursos.
En estos casos se dice que existe <strong>exclusiÃ³n mutua</strong> entre las <strong>secciones crÃ­ticas</strong>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_eventos"><a class="anchor" href="#_eventos"></a>13.1.4. Eventos</h4>
<div class="paragraph">
<p>Las <strong>condiciones de carrera</strong> son el principal problema del cÃ³digo anterior del productor y el consumidor, pero no el Ãºnico.
En ambos ejemplos se usan bucles para que el hilo espere si el vector estÃ¡ lleno o vacÃ­o, antes de continuar.
A esta tÃ©cnica se la denomina <strong>espera ocupada</strong> o <strong>espera activa</strong> y estÃ¡ completamente desaconsejada usarla en cÃ³digo del espacio de usuario, porque contribuye a gastar tiempo de CPU inÃºtilmente.</p>
</div>
<div class="paragraph">
<p>En su lugar, se recomienda usar mecanismos de sincronizaciÃ³n ofrecidos por el sistema operativo; diseÃ±ados para que un hilo o proceso notifique eventos a otro, de tal forma que hasta que eso ocurre, el que espera permanezca en estado <strong>esperando</strong>, dejando la CPU para los hilos que la necesitan.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_sincronizaciÃ³n_por_hardware"><a class="anchor" href="#_sincronizaciÃ³n_por_hardware"></a>13.2. SincronizaciÃ³n por hardware</h3>
<div class="paragraph">
<p>Las soluciones ofrecidas por el sistema operativo, para resolver los problemas anteriores, suelen tener que apoyarse en caracterÃ­sticas del hardware.
A continuaciÃ³n veremos algunas de esas caracterÃ­sticas, antes de profundizar en los mecanismos ofrecidos por el sistema operativo.</p>
</div>
<div class="sect3">
<h4 id="_bloque_de_las_interrupciones"><a class="anchor" href="#_bloque_de_las_interrupciones"></a>13.2.1. Bloque de las interrupciones</h4>
<div class="paragraph">
<p>El problema de la secciÃ³n crÃ­tica puede ser resuelto de forma sencilla en un sistema monoprocesador.</p>
</div>
<div class="paragraph">
<p>Como el nÃºcleo del sistema operativo es un software controlado mediante interrupciones, basta con que los hilos bloqueen las interrupciones mientras se estÃ¡ dentro de la secciÃ³n crÃ­tica.
AsÃ­, el sistema operativo no puede tomar el control y asignar otro hilo a la CPU, lo que impide que se ejecute otra secuencia de instrucciones que podrÃ­a modificar los datos compartidos.</p>
</div>
<div class="paragraph">
<p>Indudablemente esta soluciÃ³n no es prÃ¡ctica en sistema multiprocesador, donde hay varios procesadores ejecutÃ¡ndose a la vez.</p>
</div>
</div>
<div class="sect3">
<h4 id="_instrucciones_atÃ³micas"><a class="anchor" href="#_instrucciones_atÃ³micas"></a>13.2.2. Instrucciones atÃ³micas</h4>
<div class="paragraph">
<p>
Todas las CPU modernas disponen de instrucciones para comparar y modificar el contenido de una variable o intercambiar el contenido de dos variables, de forma <strong>atÃ³mica</strong>.
El tÃ©rmino <strong>atÃ³mico</strong> hace referencia a que las operaciones se ejecutan como una unidad ininterrumpible.
No importa que varias CPU ejecuten estas instrucciones simultÃ¡neamente, puesto el hardware se encargarÃ¡ de que sean ejecutadas secuencialmente en algÃºn orden arbitrario.</p>
</div>
<div class="paragraph">
<p>Estas instrucciones estÃ¡n disponibles para los programadores de C y C&#43;&#43; a travÃ©s de tipos especiales.
Por ejemplo, en C11 <a href="https://en.cppreference.com/w/c/atomic">&lt;stdatomic.h&gt;</a> define tipos como: <code>atomic_bool</code>, <code>atomic_uint</code> o <code>atomic_char</code> para declarar variables atÃ³micas de los tipos <code>bool</code>, <code>unsigned int</code> y <code>char</code>, respectivamente.
TambiÃ©n declara funciones para inicializar, leer, guardar, intercambiar, sumar, restar y realizar operaciones lÃ³gicas, de forma atÃ³mica sobre estas variables:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="n">atomic_int</span> <span class="n">count</span><span class="p">;</span>
<span class="n">atomic_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">count</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="kt">int</span> <span class="n">old_count</span> <span class="o">=</span> <span class="n">atomic_fetch_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">count</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Inicializar el valor de la variable atÃ³mica.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Como un <code>count++</code> atÃ³mico: incrementa la variable devolviendo el valor previo.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>En C&#43;&#43;11, <a href="https://en.cppreference.com/w/cpp/header/atomic">&lt;atomic&gt;</a> declara la plantilla <a href="https://en.cppreference.com/w/cpp/atomic/atomic">std::atomic</a> que ofrece una funcionada similar:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="cpp"><span class="n">std</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">count</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>  <i class="conum" data-value="1"></i><b>(1)</b> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="kt">int</span> <span class="n">old_count</span> <span class="o">=</span> <span class="n">count</span><span class="o">++</span><span class="p">;</span>    <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>TambiÃ©n hay un tipo <code>std::atomic_int</code> que es equivalente.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Se usa el constructor para inicializar la variable atÃ³mica.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>AdemÃ¡s de soportar los operadores '++' y '--', soporta los mÃ©todos <a href="https://en.cppreference.com/w/cpp/atomic/atomic/fetch_add">std::atomic::fetch_add()</a> y <a href="https://en.cppreference.com/w/cpp/atomic/atomic/fetch_sub">std::atomic::fetch_sub()</a> para sumar y restar devolviendo el valor previo.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>La importancia de estas instrucciones estÃ¡ en que pueden ser utilizadas por el sistema operativo para ofrecer soluciones sencillas al problema de la secciÃ³n crÃ­tica.
Por ejemplo, <strong>semÃ¡foros</strong> o <strong><em>mutex</em></strong>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_semÃ¡foros"><a class="anchor" href="#_semÃ¡foros"></a>13.3. SemÃ¡foros</h3>
<div class="paragraph">
<p>
La exclusiÃ³n mutua en las secciones crÃ­ticas se asegura utilizando adecuadamente una serie de recursos que para ese fin proporciona el sistema operativo.
Estos recursos utilizan internamente instrucciones y otras caracterÃ­sticas de la CPU, incluidas por los diseÃ±adores para resolver este tipo de problemas, que hemos comentado anteriormente.
Ese es el caso de los <strong>semÃ¡foros</strong>.</p>
</div>
<div class="paragraph">
<p>Los <strong>semÃ¡foros</strong> son un tipo de objetos del sistema operativo que nos permiten controlar el acceso a una secciÃ³n crÃ­tica, por medio de dos primitivas: <strong>acquire</strong> y <strong>release</strong> âo <strong>wait</strong> y <strong>signal</strong>, segÃºn el libro de texto que consultemosâ.
A continuaciÃ³n describimos el mecanismo de funcionamiento:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="cpp"><span class="n">semaphore</span> <span class="nf">S</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>    <i class="conum" data-value="1"></i><b>(1)</b>

<span class="n">S</span><span class="p">.</span><span class="n">acquire</span><span class="p">()</span>         <i class="conum" data-value="2"></i><b>(2)</b>

<span class="c1">// CÃ³digo de la secciÃ³n crÃ­tica... </span><i class="conum" data-value="3"></i><b>(3)</b>

<span class="n">S</span><span class="p">.</span><span class="n">signal</span><span class="p">();</span>         <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Crear el <strong>semÃ¡foro</strong> <code>S</code> inicializado a 10.
Un <strong>semÃ¡foro</strong> contiene fundamentalmente un contador con el nÃºmero mÃ¡ximo de hilos que pueden estar ejecutando el cÃ³digo de la secciÃ³n crÃ­tica al mismo tiempo.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Intentar entrar en la secciÃ³n crÃ­tica:
<div class="ulist">
<ul>
<li>
<p>Si el contador interno del <strong>semÃ¡foro</strong> es mayor que 0, <code>acquire()</code> lo decrementa y retorna para que la ejecuciÃ³n continÃºe.</p>
</li>
<li>
<p>Si el contador interno del <strong>semÃ¡foro</strong> es igual a 0, <code>acquire()</code> saca al hilo de la CPU y lo pone en una cola de espera, suspendiendo asÃ­ su ejecuciÃ³n.
BÃ¡sicamente, es que hay demasiados hilos dentro de la secciÃ³n crÃ­tica.</p>
</li>
</ul>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>AquÃ­ irÃ­a el cÃ³digo protegido con el <strong>semÃ¡foro</strong>.
Es decir, el cÃ³digo de la secciÃ³n crÃ­tica en sÃ­.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Salir de la secciÃ³n crÃ­tica:
<div class="ulist">
<ul>
<li>
<p>Si el contador interno del <strong>semÃ¡foro</strong> es mayor que 0, <code>release()</code> lo incrementa y retorna para que la ejecuciÃ³n continÃºe.</p>
</li>
<li>
<p>Si el contador interno del <strong>semÃ¡foro</strong> es igual a 0, <code>release()</code> lo incrementa y saca a uno de los hilos en la cola de espera âdonde los puso su <code>acquire()</code>â para meterlo en la cola de preparados, dejÃ¡ndolo listo para entrar en la CPU.
Cuando eso ocurra, ese hilo decrementarÃ¡ el contador interno del <strong>semÃ¡foro</strong> y saldrÃ¡ de su <code>acquire()</code>, donde hasta ahora estaba atrapado.
Mientras tanto <code>release()</code> retorna y la ejecuciÃ³n del hilo que sale del secciÃ³n crÃ­tica continÃºa.</p>
</li>
</ul>
</div></td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Nota"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Para que funcione correctamente, el <strong>semÃ¡foro</strong> <code>S</code> debe ser el mismo para todos los hilos que tengan secciones crÃ­ticas en cuya ejecuciÃ³n debe haber <strong>exclusiÃ³n mutua</strong>.
Es decir, el <strong>semÃ¡foro</strong> <code>S</code> debe estar compartido entre los hilos de la misma manera que las estructuras de datos, variables y otros recursos que protege.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_tipos_de_semÃ¡foros"><a class="anchor" href="#_tipos_de_semÃ¡foros"></a>13.3.1. Tipos de semÃ¡foros</h4>
<div class="paragraph">
<p>Tanto el estÃ¡ndar POSIX como Windows API soportan semÃ¡foros y ambos admiten dos tipos de semÃ¡foros:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Los <strong>semÃ¡foros anÃ³nimos</strong> que solo existen en el espacio de direcciones del proceso que los crea, de tal forma que estÃ¡n disponibles para sincronizar hilos del mismo proceso.</p>
<div class="paragraph">
<p>La forma de usarlos para sincronizar procesos diferentes o hilos en procesos diferentes depende del sistema operativo.
Con Windows API se pueden heredar de padres a hijos.
Mientras que en sistemas POSIX es necesario crear el <strong>semÃ¡foro</strong> en una regiÃ³n de <strong>memoria compartida</strong>, que hayamos creado previamente, e indicar un valor distinto de 0 en el argumento <code>pshared</code> de <a href="https://man7.org/linux/man-pages/man3/sem_init.3.html">sem_init()</a>.</p>
</div>
</li>
<li>
<p>Las <strong>semÃ¡foros con nombre</strong> son pÃºblicos al resto del sistema, por lo que teÃ³ricamente cualquier proceso con permisos puede abrirlos para utilizarlos.</p>
</li>
</ul>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Tabla 4. Funciones de la API para manipular semÃ¡foros.</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"></th>
<th class="tableblock halign-left valign-top">POSIX API</th>
<th class="tableblock halign-left valign-top">Windows API</th>
</tr>
</thead>
<tbody>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Crear semÃ¡foro anÃ³nimo</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://man7.org/linux/man-pages/man3/sem_init.3.html">sem_init()</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-createsemaphorea">CreateSemaphore()</a></p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Crear semÃ¡foro con nombre</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://man7.org/linux/man-pages/man3/sem_open.3.html">sem_open()</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-createsemaphorea">CreateSemaphore()</a></p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Abrir semÃ¡foro con nombre</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://man7.org/linux/man-pages/man3/sem_open.3.html">sem_open()</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.microsoft.com/en-us/windows/win32/api/synchapi/nf-synchapi-opensemaphorew">OpenSemaphore()</a></p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">OperaciÃ³n acquire</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://man7.org/linux/man-pages/man3/sem_wait.3.html">sem_wait()</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.microsoft.com/en-us/windows/win32/api/synchapi/nf-synchapi-waitforsingleobject">WaitForSingleObject()</a></p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">OperaciÃ³n release</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://man7.org/linux/man-pages/man3/sem_post.3.html">sem_post()</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.microsoft.com/en-us/windows/win32/api/synchapi/nf-synchapi-releasesemaphore">ReleaseSemaphore()</a></p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Cerrar semÃ¡foro con nombre</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://man7.org/linux/man-pages/man3/sem_close.3.html">sem_close()</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.microsoft.com/en-us/windows/win32/api/handleapi/nf-handleapi-closehandle">CloseHandle()</a></p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Destruir semÃ¡foro anÃ³nimo</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://man7.org/linux/man-pages/man3/sem_destroy.3.html">sem_destroy()</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="lightcell">[AutomÃ¡tico]</span></p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Destruir semÃ¡foro con nombre</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://man7.org/linux/man-pages/man3/sem_unlink.3.html">sem_unlink()</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="lightcell">[AutomÃ¡tico]</span></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_ejemplos_del_uso_de_semÃ¡foros"><a class="anchor" href="#_ejemplos_del_uso_de_semÃ¡foros"></a>13.3.2. Ejemplos del uso de semÃ¡foros</h4>
<div class="paragraph">
<p>En el ejemplo <a href="https://github.com/ull-esit-sistemas-operativos/ssoo-ejemplos/blob/so2223/src/cap11/anom-shared-memory.cpp">anom-shared-memory.cpp</a> de comunicaciÃ³n mediante memoria compartida, se usa un <strong>semÃ¡foro</strong> para que el proceso hijo indique al proceso padre que ha terminado de calcular el factorial y el resultado ya estÃ¡ en la memoria.</p>
</div>
<div class="paragraph">
<p>En <a href="https://github.com/ull-esit-sistemas-operativos/ssoo-ejemplos/blob/so2223/src/cap11/shared-memory-server.c">shared-memory-server.c</a> estÃ¡ el ejemplo completo de un programa que muestra periÃ³dicamente la hora del sistema y que puede ser controlado remotamente, mediante memoria compartida, con un cliente como el de <a href="https://github.com/ull-esit-sistemas-operativos/ssoo-ejemplos/blob/so2223/src/cap11/shared-memory-client.cpp">shared-memory-client.cpp</a>.</p>
</div>
<div class="paragraph">
<p>Para enviar los mensajes entre el cliente y el servidor, en la memoria compartida se reserva hueco para un bÃºfer en el que el cliente copia el comando que quiere enviar y para dos <strong>semÃ¡foros</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="k">struct</span> <span class="n">memory_content</span>
<span class="p">{</span>
    <span class="n">sem_t</span> <span class="n">empty</span><span class="p">;</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="n">sem_t</span> <span class="n">ready</span><span class="p">;</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="kt">char</span> <span class="n">command_buffer</span><span class="p">[</span><span class="n">MAX_COMMAND_SIZE</span><span class="p">];</span>
<span class="p">};</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Indica cuÃ¡ndo <code>command_buffer</code> estÃ¡ vacÃ­o, asÃ­ que se inicializa a 1.
El cliente usa <a href="https://man7.org/linux/man-pages/man3/sem_wait.3.html">sem_wait()</a> en este <strong>semÃ¡foro</strong> antes de escribir un nuevo comando en <code>command_buffer</code>:
<div class="ulist">
<ul>
<li>
<p>Si el <strong>semÃ¡foro</strong> estÃ¡ a 0, el cliente pasa y escribe el comando.
DespuÃ©s llama a <a href="https://man7.org/linux/man-pages/man3/sem_post.3.html">sem_post()</a> en <code>ready</code>.</p>
</li>
<li>
<p>Si el <strong>semÃ¡foro</strong> estÃ¡ a 1, el cliente queda bloqueado y tiene que esperar a que el servidor use <a href="https://man7.org/linux/man-pages/man3/sem_post.3.html">sem_post()</a> sobre el mismo <strong>semÃ¡foro</strong>.
El servidor lo hace despuÃ©s de leer el comando para interpretarlo.</p>
</li>
</ul>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Indica cuÃ¡ndo <code>command_buffer</code> tiene un comando, asÃ­ que se inicializa a 0.
El servidor usa <a href="https://man7.org/linux/man-pages/man3/sem_wait.3.html">sem_wait()</a> en este <strong>semaforo</strong> antes de leer el comando en <code>command_buffer</code> para interpretarlo:
<div class="ulist">
<ul>
<li>
<p>Si el <strong>semÃ¡foro</strong> estÃ¡ a 0, el cliente pasa y lee el comando.
DespuÃ©s llama a <a href="https://man7.org/linux/man-pages/man3/sem_post.3.html">sem_post()</a> en <code>empty</code>.</p>
</li>
<li>
<p>Si el <strong>semÃ¡foro</strong> estÃ¡ a 1, el servidor queda bloqueado y tiene que esperar a que el cliente use <a href="https://man7.org/linux/man-pages/man3/sem_post.3.html">sem_post()</a> sobre el mismo <strong>semÃ¡foro</strong>.
El cliente lo hace despuÃ©s de escribir un nuevo comando en <code>command_buffer</code>.</p>
</li>
</ul>
</div></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>El detalle de cÃ³mo cliente y servidor usan ambos semÃ¡foros, se puede ver en el cÃ³digo de <a href="https://github.com/ull-esit-sistemas-operativos/ssoo-ejemplos/blob/so2223/src/cap11/shared-memory-client.cpp">shared-memory-client.cpp</a> y <a href="https://github.com/ull-esit-sistemas-operativos/ssoo-ejemplos/blob/so2223/src/cap11/shared-memory-server.c">shared-memory-server.c</a>, respectivamente.</p>
</div>
<div class="paragraph">
<p>Finalmente, para resolver el <strong>problema del productor-consumidor</strong> tenemos que considerar que:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Necesitamos un semÃ¡foro para que haya <strong>exclusiÃ³n mutua</strong> entre ambos al insertar y extraer elementos del vector.</p>
</li>
<li>
<p>Necesitamos una forma de que el productor espere cuando el vector estÃ© lleno y que el consumidor haga lo mismo cuando el vector estÃ© vacÃ­o.
Una soluciÃ³n es usar dos semÃ¡foros, uno para que cuente el nÃºmero de elementos en el vector y otro para contar el nÃºmero de huecos libres:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="cpp"><span class="n">sem_t</span> <span class="n">mutex</span><span class="p">;</span>       <i class="conum" data-value="1"></i><b>(1)</b>
<span class="n">sem_t</span> <span class="n">fill_count</span><span class="p">;</span>  <i class="conum" data-value="2"></i><b>(2)</b>
<span class="n">sem_t</span> <span class="n">empty_count</span><span class="p">;</span> <i class="conum" data-value="3"></i><b>(3)</b>

<span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">item_t</span><span class="o">&gt;</span> <span class="n">buffer</span><span class="p">(</span> <span class="n">VECTOR_SIZE</span> <span class="p">);</span>

<span class="kt">void</span> <span class="nf">initialize</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">sem_init</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">mutex</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="p">);</span>  <i class="conum" data-value="1"></i><b>(1)</b> <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="n">sem_init</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">mutex</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>  <i class="conum" data-value="2"></i><b>(2)</b> <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="n">sem_init</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">mutex</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">VECTOR_SIZE</span> <span class="p">);</span>  <i class="conum" data-value="3"></i><b>(3)</b> <i class="conum" data-value="4"></i><b>(4)</b>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">productor</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// ...</span>

    <span class="k">while</span><span class="p">(</span><span class="cm">/* ... */</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">item_t</span> <span class="n">item</span> <span class="o">=</span> <span class="n">produce_item</span><span class="p">();</span>

        <span class="n">sem_wait</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">empty_count</span> <span class="p">);</span> <i class="conum" data-value="5"></i><b>(5)</b>
        <span class="n">sem_wait</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">mutex</span> <span class="p">);</span>       <i class="conum" data-value="7"></i><b>(7)</b>

        <span class="n">vector</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">item</span><span class="p">);</span>

        <span class="n">sem_post</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">mutex</span> <span class="p">);</span>       <i class="conum" data-value="7"></i><b>(7)</b>
        <span class="n">sem_post</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">fill_count</span> <span class="p">);</span>  <i class="conum" data-value="6"></i><b>(6)</b>
    <span class="p">}</span>

    <span class="c1">// ...</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">consumer</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// ...</span>

    <span class="k">while</span><span class="p">(</span><span class="cm">/* ... */</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">sem_wait</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">fill_count</span> <span class="p">);</span>  <i class="conum" data-value="6"></i><b>(6)</b>
        <span class="n">sem_wait</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">mutex</span> <span class="p">);</span>       <i class="conum" data-value="7"></i><b>(7)</b>

        <span class="n">item_t</span> <span class="n">item</span> <span class="o">=</span> <span class="n">vector</span><span class="p">.</span><span class="n">back</span><span class="p">();</span>
        <span class="n">vector</span><span class="p">.</span><span class="n">pop_back</span><span class="p">();</span>

        <span class="n">sem_post</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">mutex</span> <span class="p">);</span>       <i class="conum" data-value="7"></i><b>(7)</b>
        <span class="n">sem_post</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">empty_count</span> <span class="p">);</span> <i class="conum" data-value="5"></i><b>(5)</b>

        <span class="n">consume_item</span><span class="p">(</span><span class="n">item</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// ...</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><strong>SemÃ¡foro</strong> que se encarga de la exclusiÃ³n mutua.
Se inicializa a 1, para que el primer hilo que use <a href="https://man7.org/linux/man-pages/man3/sem_wait.3.html">sem_wait()</a> pueda entrar.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><strong>SemÃ¡foro</strong> que se encarga de contar huecos ocupados en el vector.
Se inicializa a 0, porque al principio no hay ningÃºn elemento.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><strong>SemÃ¡foro</strong> que se encarga de contar los huecos libres en el vector.
Se inicializa a VECTOR_SIZE, porque estÃ¡n todos vacÃ­os.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>El segundo argumento de <a href="https://man7.org/linux/man-pages/man3/sem_init.3.html">sem_init()</a> es <code>pshared</code>.
Se pone a 0 para indicar que este <strong>semaforo</strong> no se va a compartir entre procesos diferentes.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Antes de insertar un elemento se decrementa <code>empty_count</code>.
AsÃ­, si vale 0, es que el vector estÃ¡ lleno y el productor se bloquea.
El consumidor incrementa <code>empty_count</code> tras extraer un elemento y dejar hueco, despertando al productor.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Antes de extraer un elemento se decrementa <code>fill_count</code>.
AsÃ­, si vale 0, es que el vector estÃ¡ vacÃ­o y el consumidor se bloquea.
El productor incrementa <code>fill_count</code> tras insertar un elemento nuevo, despertando al consumidor.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>El acceso al vector con los elementos es en <strong>exclusiÃ³n mutua</strong>, asÃ­ que tanto productor como consumidor deben usar <a href="https://man7.org/linux/man-pages/man3/sem_wait.3.html">sem_wait()</a> sobre <code>mutex</code> antes de acceder a Ã©l.
Esto decrementa el semÃ¡foro, asÃ­ que solo uno de los dos pasa y ejecuta las lÃ­neas siguientes, mientras el otro queda bloqueado.
Cuando el que haya pasado termine, debe usar <a href="https://man7.org/linux/man-pages/man3/sem_post.3.html">sem_post()</a> sobre <code>mutex</code> para incrementar el semÃ¡foro y permitir que el otro hilo entre en su <strong>secciÃ³n crÃ­tica</strong>.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_mutex"><a class="anchor" href="#_mutex"></a>13.4. Mutex</h3>
<div class="paragraph">
<p>Los semÃ¡foros inicializados a 1 se denominan <strong><em>mutex</em></strong> âtÃ©rmino que tiene su origen en <em>mutual exclusion</em>â o <strong>semÃ¡foros binarios</strong>.
Por tanto, aunque un sistema o lenguaje solo soporte <strong>semÃ¡foros</strong>, es directo implementar <strong><em>mutex</em></strong>.
A la inversa ocurre igual.
Si un sistema o lenguaje soporta <strong><em>mutex</em></strong>, es muy sencillo hacer una implementaciÃ³n <strong>semÃ¡foros</strong>, si nos hiciera falta.</p>
</div>
<div class="paragraph">
<p>El estÃ¡ndar POSIX soporta <strong><em>mutex</em></strong> a travÃ©s de <a href="https://man7.org/linux/man-pages/man7/pthreads.7.html">POSIX Threads</a>.
Por defecto solo se pueden utilizar para sincronizar hilos del mismo proceso; pero tienen un atributo para permitir la sincronizaciÃ³n entre procesos diferentes, aunque para eso deben ser creados en una regiÃ³n de memoria compartida por dichos procesos.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Nota"></i>
</td>
<td class="content">
<div class="paragraph">
<p>La API de <a href="https://man7.org/linux/man-pages/man7/pthreads.7.html">POSIX Threads</a> no soporta <strong>semÃ¡foros</strong> porque, como vimos antes, ya eran parte del estÃ¡ndar POSIX.</p>
</div>
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Tabla 5. Funciones de la API para manipular <em>mutex</em>.</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"></th>
<th class="tableblock halign-left valign-top">C&#43;&#43;</th>
<th class="tableblock halign-left valign-top">POSIX API</th>
<th class="tableblock halign-left valign-top" colspan="2">Windows API</th>
</tr>
</thead>
<tbody>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Crear</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://en.cppreference.com/w/cpp/thread/mutex">std::mutex</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://man7.org/linux/man-pages/man3/pthread_mutex_init.3p.html">pthread_mutex_init()</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.microsoft.com/en-us/windows/win32/api/synchapi/nf-synchapi-initializecriticalsection">InitializeCriticalSection()</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.microsoft.com/en-us/windows/win32/api/synchapi/nf-synchapi-createmutexa">CreateMutex()</a></p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Abrir</p></th>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.microsoft.com/en-us/windows/win32/api/synchapi/nf-synchapi-openmutexw">OpenMutex()</a></p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">OperaciÃ³n acquire</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://en.cppreference.com/w/cpp/thread/mutex/lock">std::mutex:::lock()</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://man7.org/linux/man-pages/man3/pthread_mutex_lock.3p.html">pthread_mutex_lock()</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.microsoft.com/en-us/windows/win32/api/synchapi/nf-synchapi-entercriticalsection">EnterCriticalSection()</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.microsoft.com/en-us/windows/win32/api/synchapi/nf-synchapi-waitforsingleobject">WaitForSingleObject()</a></p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">OperaciÃ³n release</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://en.cppreference.com/w/cpp/thread/mutex/unlock">std::mutex::unlock()</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://man7.org/linux/man-pages/man3/pthread_mutex_unlock.3p.html">pthread_mutex_unlock()</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.microsoft.com/en-us/windows/win32/api/synchapi/nf-synchapi-leavecriticalsection">LeaveCriticalSection()</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.microsoft.com/en-us/windows/win32/api/synchapi/nf-synchapi-releasemutex">ReleaseMutex()</a></p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Destruir</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="lightcell">[Destructor]</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://man7.org/linux/man-pages/man3/pthread_mutex_destroy.3p.html">pthread_mutex_destroy()</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.microsoft.com/en-us/windows/win32/api/synchapi/nf-synchapi-deletecriticalsection">DeleteCriticalSection()</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.microsoft.com/en-us/windows/win32/api/handleapi/nf-handleapi-closehandle">CloseHandle()</a></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>En Windows API hay dos tipo de objetos equiparables a los <strong><em>mutex</em></strong>: los <strong><em>mutex</em></strong> y las <strong>secciones crÃ­ticas</strong>.
Las <strong>secciones crÃ­ticas</strong> son mÃ¡s ligeras, pero solo se pueden utilizar para sincronizar hilos del mismo proceso.
Mientras que los <strong><em>mutex</em></strong> de Windows API son objetos mÃ¡s costosos, pero se pueden compartir entre procesos sin utilizar memoria compartida; ya sea mediante herencia al crear un proceso hijo o asignando un nombre al <strong><em>mutex</em></strong>, como ocurre con los <strong>semÃ¡foros</strong>.</p>
</div>
<div class="sect3">
<h4 id="_ejemplos_del_uso_de_mutex"><a class="anchor" href="#_ejemplos_del_uso_de_mutex"></a>13.4.1. Ejemplos del uso de mutex</h4>
<div class="paragraph">
<p>En <a href="https://github.com/ull-esit-sistemas-operativos/ssoo-ejemplos/blob/so2223/src/cap13/pthreads-sync-factorial.cpp">pthreads-sync-factorial.cpp</a> se puede estudiar el cÃ³digo completo de un ejemplo similar a <a href="https://github.com/ull-esit-sistemas-operativos/ssoo-ejemplos/blob/so2223/src/cap12/pthreads.cpp">pthreads.cpp</a>, donde se calculaba el factorial de un nÃºmero, repartiendo la tarea entre dos hilos, usando la API de <a href="https://man7.org/linux/man-pages/man7/pthreads.7.html">POSIX Threads</a>.
La diferencia es que ahora los hilos no retornan el resultado, sino que cada uno lo mete en un vector compartido.
Al terminar, el hilo principal recorre el vector multiplicando los resultados parciales.</p>
</div>
<div class="paragraph">
<p>Como ahora ambos hilos acceden a una estructura de datos compartida, esta debe ir protegida por un <strong><em>mutex</em></strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="cpp"><span class="n">pthread_mutex_t</span> <span class="n">mutex</span><span class="p">;</span>
<span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">BigInt</span><span class="o">&gt;</span> <span class="n">partials</span><span class="p">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Antes de meter un nuevo valor, cada hilo debe adquirir el <code>mutex</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="cpp"><span class="c1">// Bloquear el mutex y guardar el resultado</span>
<span class="n">pthread_mutex_lock</span><span class="p">(</span> <span class="n">mutex</span> <span class="p">);</span>   <i class="conum" data-value="1"></i><b>(1)</b>
<span class="n">partials</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span> <span class="n">result</span> <span class="p">);</span>
<span class="n">pthread_mutex_unlock</span><span class="p">(</span> <span class="n">mutex</span> <span class="p">);</span> <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Adquirir <code>mutex</code> antes de entrar en la <strong>secciÃ³n crÃ­tica</strong>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Liberar <code>mutex</code> para salir de la <strong>secciÃ³n crÃ­tica</strong>.
Es importante no olvidarnos de liberar el <strong><em>mutex</em></strong> al terminar o de lo contrario uno de los hilos quedarÃ¡ dormido indefinidamente, al no poder entrar en la <strong>secciÃ³n crÃ­tica</strong>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>En <a href="https://github.com/ull-esit-sistemas-operativos/ssoo-ejemplos/blob/so2223/src/cap13/pthreads-sync-counter.cpp">pthreads-sync-counter.cpp</a> se puede observar un ejemplo mÃ¡s simple donde dos hilos intentan incrementar un contador.
El resultado es correcto siempre que cada hilo adquiera el mismo <strong><em>mutex</em></strong> antes del incremento:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="cpp"><span class="c1">// Bloquear el mutex antes de incrementar el contador.</span>
<span class="n">pthread_mutex_lock</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">mutex</span> <span class="p">);</span>
<span class="n">args</span><span class="o">-&gt;</span><span class="n">counter</span><span class="o">++</span><span class="p">;</span>
<span class="c1">// Desbloquear el mutex tras incrementar el contador.</span>
<span class="n">pthread_mutex_unlock</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">mutex</span> <span class="p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En <a href="https://github.com/ull-esit-sistemas-operativos/ssoo-ejemplos/blob/so2223/src/cap13/threads-sync-counter.cpp">threads-sync-counter.cpp</a> y <a href="https://github.com/ull-esit-sistemas-operativos/ssoo-ejemplos/blob/so2223/src/cap13/threads-sync-factorial.cpp">threads-sync-factorial.cpp</a> se puede ver ejemplos equivalentes pero usando <a href="https://en.cppreference.com/w/cpp/thread/thread">std::thread</a> y <a href="https://en.cppreference.com/w/cpp/thread/mutex">std::mutex</a>, de la librerÃ­a estÃ¡ndar de C&#43;&#43;.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_variables_de_condiciÃ³n"><a class="anchor" href="#_variables_de_condiciÃ³n"></a>13.5. Variables de condiciÃ³n</h3>
<div class="paragraph">
<p>
En la soluciÃ³n que dimos al <strong>problema del productor-consumidor</strong> usando <strong>semÃ¡foros</strong> (vÃ©ase el <a href="sincronizaciÃ³n.html#_ejemplos_del_uso_de_semÃ¡foros">Apartado 13.3.2</a>) empleamos <strong>semÃ¡foros</strong> para implementar las esperas del productor y el consumidor cuando el vector estÃ¡ lleno o vacÃ­o, respectivamente.
Lamentablemente, los <em>mutex</em> no se pueden usar de la misma manera para seÃ±alar eventos.
En su lugar necesitamos otro tipo de objeto llamado <strong>variable de condiciÃ³n</strong>.</p>
</div>
<div class="paragraph">
<p>Las <strong>variables de condiciÃ³n</strong> soportan tres primitivas principales:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">wait( mutex )</dt>
<dd>
<p>Es llamada por un hilo que desea esperar a que ocurra el evento que representa la variable de condiciÃ³n.
El hilo debe haber adquirido antes el <strong><em>mutex</em></strong>, es liberado en el momento de poner al hilo en estado <strong>esperando</strong>.
Varios hilos pueden llamar a <strong>wait</strong> sobre la misma variable de condiciÃ³n, a la espera de que alguno use <strong>notify</strong>.</p>
</dd>
<dt class="hdlist1">notify</dt>
<dd>
<p>Es llamada por un hilo que quiere notificar el suceso de un evento a los hilos que esperan en la variable de condiciÃ³n.
Uno de esos hilos es despertado, adquiere el <strong><em>mutex</em></strong> que liberÃ³ al llamar a <strong>wait</strong> y, finalmente, retorna de <strong>wait</strong> para seguir ejecutÃ¡ndose.</p>
</dd>
<dt class="hdlist1">notifyAll</dt>
<dd>
<p>Es llamada por un hilo que quiere notificar el suceso de un evento a los hilos que esperan en la variable de condiciÃ³n.
Todos los hilos son despertados e intentan adquirir el <strong><em>mutex</em></strong> que liberaron al llamar a <strong>wait</strong>.
Cuando lo consiguen, retornan de <strong>wait</strong> para seguir ejecutÃ¡ndose.
Obviamente, si todos hicieron <strong>wait</strong> sobre el mismo <strong><em>mutex</em></strong>, irÃ¡n retornando de <strong>wait</strong> de uno en uno, porque solo un hilo puede tener el <strong><em>mutex</em></strong> al mismo tiempo.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Tanto Windows API como el estÃ¡ndar POSIX, a travÃ©s de <a href="https://man7.org/linux/man-pages/man7/pthreads.7.html">POSIX Threads</a>, soportan <strong>variables de condiciÃ³n</strong>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Tabla 6. Funciones de la API para manipular variables de condiciÃ³n.</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"></th>
<th class="tableblock halign-left valign-top">C&#43;&#43;</th>
<th class="tableblock halign-left valign-top">POSIX API</th>
<th class="tableblock halign-left valign-top">Windows API</th>
</tr>
</thead>
<tbody>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Crear</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://en.cppreference.com/w/cpp/thread/condition_variable">std::condition_variable</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://man7.org/linux/man-pages/man3/pthread_cond_init.3p.html">pthread_cond_init()</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.microsoft.com/en-us/windows/win32/api/synchapi/nf-synchapi-initializeconditionvariable">InitializeConditionVariable()</a></p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">OperaciÃ³n wait</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://en.cppreference.com/w/cpp/thread/condition_variable/wait">std::condition_variable::wait()</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://man7.org/linux/man-pages/man3/pthread_cond_wait.3p.html">pthread_cond_wait()</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.microsoft.com/en-us/windows/win32/api/synchapi/nf-synchapi-sleepconditionvariablecs">SleepConditionVariableCS()</a></p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">OperaciÃ³n notify</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://en.cppreference.com/w/cpp/thread/condition_variable/notify_one">std::condition_variable::notify_one()</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://man7.org/linux/man-pages/man3/pthread_cond_signal.3p.html">pthread_cond_signal()</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.microsoft.com/en-us/windows/win32/api/synchapi/nf-synchapi-wakeconditionvariable">WakeConditionVariable()</a></p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">OperaciÃ³n notifyAll</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://en.cppreference.com/w/cpp/thread/condition_variable/notify_all">std::condition_variable::notify_all()</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://man7.org/linux/man-pages/man3/pthread_cond_broadcast.3p.html">pthread_cond_broadcast()</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.microsoft.com/en-us/windows/win32/api/synchapi/nf-synchapi-wakeallconditionvariable">WakeAllConditionVariable()</a></p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Destruir</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="lightcell">[Destructor]</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://man7.org/linux/man-pages/man3/pthread_cond_destroy.3p.html">pthread_cond_destroy()</a></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Por defecto, las <strong>variables de condiciÃ³n</strong> de <a href="https://man7.org/linux/man-pages/man7/pthreads.7.html">POSIX Threads</a> solo se pueden utilizar para sincronizar hilos del mismo proceso; pero tienen un atributo para permitir la sincronizaciÃ³n entre procesos diferentes.
Obviamente, para eso deben ser creadas en una regiÃ³n de memoria compartida por dichos procesos.</p>
</div>
<div class="paragraph">
<p>Las <strong>variables de condiciÃ³n</strong> de Windows API solo se pueden utilizar en hilos del mismo procesos.
Como alternativa, Windows API soporta <strong>eventos</strong>, que son un tipo de objeto similar a las <strong>variables de condiciÃ³n</strong>, pero que sÃ­ se puede utilizar entre hilos de procesos diferentes (vÃ©ase <a href="https://docs.microsoft.com/en-us/windows/win32/sync/using-event-objects">Â«Using Event Objects&#8201;&#8212;&#8201;Microsoft DocsÂ»</a>).</p>
</div>
<div class="paragraph">
<p>A los <strong>eventos</strong> se les puede asignar un nombre, para que sean accesibles por otros procesos, o heredarse de padres a hijos.
AdemÃ¡s son mÃ¡s pesados que las <strong>variables de condiciÃ³n</strong> de Windows API, no exigen un <strong><em>mutex</em></strong> para liberar al invocar su operaciÃ³n <strong>wait</strong>, ni admiten la operaciÃ³n <strong>notifyAll</strong>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Tabla 7. Funciones de la API para manipular eventos de Windows API.</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"></th>
<th class="tableblock halign-left valign-top">Windows API</th>
</tr>
</thead>
<tbody>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Crear</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.microsoft.com/en-us/windows/win32/api/synchapi/nf-synchapi-createeventa">CreateEvent()</a></p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Abrir</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.microsoft.com/en-us/windows/win32/api/synchapi/nf-synchapi-openeventa">OpenEvent()</a></p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">OperaciÃ³n wait</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.microsoft.com/en-us/windows/win32/api/synchapi/nf-synchapi-waitforsingleobject">WaitForSingleObject()</a></p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">OperaciÃ³n notify</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.microsoft.com/en-us/windows/win32/api/synchapi/nf-synchapi-setevent">SetEvent()</a></p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Resetear evento</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.microsoft.com/en-us/windows/win32/api/synchapi/nf-synchapi-resetevent">ResetEvent()</a></p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Destruir</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.microsoft.com/en-us/windows/win32/api/handleapi/nf-handleapi-closehandle">CloseHandle()</a></p></td>
</tr>
</tbody>
</table>
<div class="sect3">
<h4 id="_ejemplos_del_uso_de_variables_de_condiciÃ³n"><a class="anchor" href="#_ejemplos_del_uso_de_variables_de_condiciÃ³n"></a>13.5.1. Ejemplos del uso de variables de condiciÃ³n</h4>
<div class="paragraph">
<p>Vamos a intentar resolver el <strong>problema del productor-consumidor</strong> sin usar <strong>semÃ¡foros</strong>.
Para lo que, nuevamente, tenemos que considerar que:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Necesitamos <strong>exclusiÃ³n mutua</strong> entre ambos hilos al insertar y extraer elementos del vector para evitar <strong>condiciones de carrera</strong>, por tanto usamos un <strong><em>mutex</em></strong> para proteger la <strong>secciÃ³n crÃ­tica</strong>.</p>
</li>
<li>
<p>Necesitamos una forma de que el productor espere cuando el vector estÃ¡ lleno y que el consumidor haga lo mismo cuando el vector estÃ¡ vacÃ­o.
Para seÃ±alar estos eventos necesitamos dos <strong>variables de condiciÃ³n</strong>:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="cpp"><span class="n">std</span><span class="o">::</span><span class="n">mutext</span> <span class="n">mutex</span><span class="p">;</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="n">std</span><span class="o">::</span><span class="n">condition_variable</span> <span class="n">no_full</span><span class="p">;</span>  <i class="conum" data-value="2"></i><b>(2)</b>
<span class="n">std</span><span class="o">::</span><span class="n">condition_variable</span> <span class="n">no_empty</span><span class="p">;</span> <i class="conum" data-value="3"></i><b>(3)</b>

<span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">item_t</span><span class="o">&gt;</span> <span class="n">buffer</span><span class="p">(</span> <span class="n">VECTOR_SIZE</span> <span class="p">);</span>

<span class="kt">void</span> <span class="nf">productor</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// ...</span>

    <span class="k">while</span><span class="p">(</span><span class="cm">/* ... */</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">item_t</span> <span class="n">item</span> <span class="o">=</span> <span class="n">produce_item</span><span class="p">();</span>

        <span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span> <span class="n">lock</span><span class="p">{</span> <span class="n">mutex</span> <span class="p">};</span>  <i class="conum" data-value="4"></i><b>(4)</b> <i class="conum" data-value="5"></i><b>(5)</b>

        <span class="k">while</span><span class="p">(</span> <span class="n">buffer</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="n">VECTOR_SIZE</span> <span class="p">)</span>  <i class="conum" data-value="6"></i><b>(6)</b> <i class="conum" data-value="10"></i><b>(10)</b>
        <span class="p">{</span>
            <span class="n">no_full</span><span class="p">.</span><span class="n">wait</span><span class="p">(</span> <span class="n">mutex</span> <span class="p">);</span> <i class="conum" data-value="11"></i><b>(11)</b>
        <span class="p">}</span>

        <span class="n">vector</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span> <span class="n">item</span> <span class="p">);</span>  <i class="conum" data-value="11"></i><b>(11)</b>

        <span class="n">no_empty</span><span class="p">.</span><span class="n">notify_one</span><span class="p">();</span> <i class="conum" data-value="7"></i><b>(7)</b>
    <span class="p">}</span> <i class="conum" data-value="6"></i><b>(6)</b>

    <span class="c1">// ...</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">consumer</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// ...</span>

    <span class="k">while</span><span class="p">(</span><span class="cm">/* ... */</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span> <span class="n">lock</span><span class="p">{</span> <span class="n">mutex</span> <span class="p">};</span>  <i class="conum" data-value="4"></i><b>(4)</b> <i class="conum" data-value="5"></i><b>(5)</b>

        <span class="k">while</span><span class="p">(</span> <span class="n">buffer</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span>  <i class="conum" data-value="8"></i><b>(8)</b> <i class="conum" data-value="10"></i><b>(10)</b>
        <span class="p">{</span>
            <span class="n">no_empty</span><span class="p">.</span><span class="n">wait</span><span class="p">(</span> <span class="n">mutex</span> <span class="p">);</span>  <i class="conum" data-value="11"></i><b>(11)</b>
        <span class="p">}</span>

        <span class="n">item_t</span> <span class="n">item</span> <span class="o">=</span> <span class="n">vector</span><span class="p">.</span><span class="n">back</span><span class="p">();</span> <i class="conum" data-value="11"></i><b>(11)</b>
        <span class="n">vector</span><span class="p">.</span><span class="n">pop_back</span><span class="p">();</span>

        <span class="n">no_full</span><span class="p">.</span><span class="n">notify_one</span><span class="p">();</span> <i class="conum" data-value="9"></i><b>(9)</b>

        <span class="n">consume_item</span><span class="p">(</span><span class="n">item</span><span class="p">);</span>
    <span class="p">}</span> <i class="conum" data-value="6"></i><b>(6)</b>

    <span class="c1">// ...</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><strong><em>Mutex</em></strong> que se encarga de la exclusiÃ³n mutua.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><strong>Variable de condiciÃ³n</strong> que se encarga de indicar cuando el vector no estÃ¡ lleno.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><strong>Variable de condiciÃ³n</strong> que se encarga de indicar cuando el vector no estÃ¡ vacÃ­o.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Antes de acceder al vector es necesario bloquear <code>mutex</code>.
Ni siquiera es seguro preguntar por el nÃºmero de elementos guardados en <code>vector</code> sin antes adquirir el <strong><em>mutex</em></strong>, puesto que el otro hilo puede estar modificando <code>vector</code> al mismo tiempo.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Los <strong><em>mutex</em></strong> se pueden adquirir y liberar con <a href="https://en.cppreference.com/w/cpp/thread/mutex/lock">std::mutex:::lock()</a> y  cpp_mutex_unlock}, pero esa no es la forma recomendada.
Lo recomendado es crear alguno de los objetos <em>lock</em> incluidos en la librerÃ­a estÃ¡ndar.
Estos objetos bloquean el <strong><em>mutex</em></strong> al crearse y lo desbloquean automÃ¡ticamente al destruirse.
AsÃ­ es complicado que nos olvidemos de desbloquearlo al salir de la funciÃ³n.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Antes de insertar un elemento se comprueba si hay algÃºn hueco disponible.
Si no lo hay, se pone el hilo a la espera en la <strong>variable de condiciÃ³n</strong> <code>no_full</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>El consumidor despierta al productor de esa espera tras extraer un elemento, porque es seguro que al hacerlo habrÃ¡ dejado un hueco.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Antes de extraer un elemento se comprueba si hay alguno en el vector.
Si no lo hay, se pone el hilo a la espera en la <strong>variable de condiciÃ³n</strong> <code>no_empty</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>El productor despierta al consumidor de esta espera tras insertar un nuevo elemento.</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>El estÃ¡ndar de C&#43;&#43; indica que las esperas en las <strong>variables de condiciÃ³n</strong> son susceptibles de despertar de forma espuria.
Es decir, que el hilo puede salir de <a href="https://en.cppreference.com/w/cpp/thread/condition_variable/wait">std::condition_variable::wait()</a> sin que haya habido notificaciÃ³n.
Por eso hay que volver a comprobar la condiciÃ³n antes de continuar ejecutando sentencias en la <strong>secciÃ³n crÃ­tica</strong>.</td>
</tr>
<tr>
<td><i class="conum" data-value="11"></i><b>11</b></td>
<td>Cuando los hilos se bloquean en <a href="https://en.cppreference.com/w/cpp/thread/condition_variable/wait">std::condition_variable::wait()</a>, <code>mutex</code> es liberado para que el otro hilo pueda entrar y extraer o insertar un elemento.
De lo contrario, no podrÃ­a hacerlo y ambos se quedarÃ­an bloqueados indefinidamente âen una situaciÃ³n que se denomina <strong>interbloqueo</strong> o <strong><em>deadlock</em></strong>â.
Pero antes de salir de <a href="https://en.cppreference.com/w/cpp/thread/condition_variable/wait">std::condition_variable::wait()</a>, el hilo adquiere de nuevo el <code>mutex</code>.
AsÃ­ que el cÃ³digo que inserta y extrae elementos se ejecuta en <strong>exclusiÃ³n mutua</strong>, tal y como nos interesa.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_esperas"><a class="anchor" href="#_esperas"></a>13.6. Esperas</h3>
<div class="paragraph">
<p>Muchos de los objetos de sincronizaciÃ³n que hemos visto necesitan algÃºn mecanismo para poner en espera a los hilos que los usan.
Existen dos alternativas desde el punto de vista de cÃ³mo implementar esta espera:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>El sistema operativo puede cambiar el estado del hilo o proceso a <strong>esperado</strong> y moverlo a una cola de espera asociada al objeto de sincronizaciÃ³n, tal y como hemos comentado en varias ocasiones.
Entonces el planificador de la CPU escogerÃ¡ a otro proceso para ser ejecutado.</p>
</li>
<li>
<p>El hilo puede iterar comprobando constantemente la condiciÃ³n hasta que se cumple.
A esa tÃ©cnica se la denomina <strong>espera ocupada</strong>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Este tipo de <strong>espera ocupada</strong> desperdicia tiempo de CPU que otro hilo podrÃ­a utilizar de forma mÃ¡s productiva, por lo que solo se utiliza en el caso de esperas previsiblemente cortas.
Para evitar que las esperas ocupadas sean demasiado largas, los sistemas operativos nunca expulsan de la CPU a hilos que se estÃ©n ejecutando dentro de secciones crÃ­ticas controladas por objetos de sincronizaciÃ³n con este tipo de espera, con la idea de que salgan de la secciÃ³n crÃ­tica lo antes posible.</p>
</div>
<div class="paragraph">
<p>En Windows API, por ejemplo, se puede utilizar <a href="https://docs.microsoft.com/en-us/windows/win32/api/synchapi/nf-synchapi-initializecriticalsectionandspincount">InitializeCriticalSectionAndSpinCount()</a> para inicializar un objeto de <strong>secciÃ³n crÃ­tica</strong> donde el hilo que la intenta adquirir itera el nÃºmero especificado de veces en una <strong>espera ocupada</strong>, comprobando si la secciÃ³n es liberada, antes de bloquearse en el estado <strong>esperando</strong> si eso no ocurre.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Nota"></i>
</td>
<td class="content">
<div class="paragraph">
<p>La <strong>espera ocupada</strong> de estos objetos <strong>secciÃ³n crÃ­tica</strong> de Windows API solo ocurre en sistemas multiprocesador, donde el hilo que tiene adquirida la secciÃ³n puede estar ejecutÃ¡ndose en otro hilo y terminar rÃ¡pidamente.
En sistemas monoprocesador nunca hay <strong>espera ocupada</strong>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A los <strong><em>mutex</em></strong> con <strong>espera ocupada</strong> tambiÃ©n se los denomina <strong><em>(spinlock)</em></strong>.
Los <strong><em>spinlocks</em></strong> son utilizados frecuentemente para proteger las estructuras del nÃºcleo en los sistemas multiprocesador, cuando la tarea a realizar dentro de la secciÃ³n crÃ­tica en el nÃºcleo requiere poco tiempo y los diseÃ±adores calculan que se desperdicia mÃ¡s tiempo sacando de la CPU al hilo en espera para ejecutar otro en su lugar.</p>
</div>
</div>
<div class="sect2">
<h3 id="_funciones_reentrantes_y_seguras_en_hilos"><a class="anchor" href="#_funciones_reentrantes_y_seguras_en_hilos"></a>13.7. Funciones reentrantes y seguras en hilos</h3>
<div class="paragraph">
<p>Todas estas cuestiones sobre la sincronizaciÃ³n no solo afectan al cÃ³digo que escribimos sino tambiÃ©n a las librerÃ­as que podemos utilizar.
A la hora de decidir utilizar una librerÃ­a en un programa multihilo es necesario que tengamos en cuenta los conceptos de <strong>reentrante</strong> y <strong>seguridad de hilos</strong>.</p>
</div>
<div class="sect3">
<h4 id="_funciones_reentrantes"><a class="anchor" href="#_funciones_reentrantes"></a>13.7.1. Funciones reentrantes</h4>
<div class="paragraph">
<p>
Una funciÃ³n es <strong>reentrante</strong> puede ser interrumpida en medio de su ejecuciÃ³n y, mientras espera, volver a ser llamada con total seguridad.
Obviamente las funciones recursivas deben ser reentrantes para poder llamarse a sÃ­ mismas una y otra vez con seguridad.</p>
</div>
<div class="paragraph">
<p>En el contexto de la programaciÃ³n multihilo, ocurre una reentrada cuando durante la ejecuciÃ³n de una funciÃ³n por parte de un hilo, este es interrumpido por el sistema operativo para planificar posteriormente a otro del mismo proceso que invoca la misma funciÃ³n.</p>
</div>
<div class="paragraph">
<p>En general una funciÃ³n es reentrante, si:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>No modifica variables estÃ¡ticas o globales.
Si lo hiciera solo puede hacerlo mediante operaciones <strong>leer-modificar-escribir</strong> que sean ininterrumpibles âes decir, atÃ³micasâ.</p>
</li>
<li>
<p>No modifica su propio cÃ³digo y no llama a otras funciones que no sean reentrantes.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Como hemos mencionado anteriormente, los <strong>manejadores de seÃ±al</strong> deben ser funciones <strong>reentrantes</strong>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_seguridad_en_hilos"><a class="anchor" href="#_seguridad_en_hilos"></a>13.7.2. Seguridad en hilos</h4>
<div class="paragraph">
<p>
Una funciÃ³n es <strong>segura en hilos</strong> o <strong>thread-safe</strong> si al manipular estructuras compartidas de datos lo hace de tal manera que se garantiza la ejecuciÃ³n segura de la misma por mÃºltiples hilos al mismo tiempo.
Obviamente estamos hablando de un problema de secciones crÃ­ticas, por lo que las funciones lo  resuelven sincronizando el acceso a estos datos mediante el uso de <strong>semÃ¡foros</strong>, <strong><em>mutex</em></strong> u otros recursos similares ofrecidos por el sistema operativo.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Nota"></i>
</td>
<td class="content">
<div class="paragraph">
<p>En ocasiones, ambos conceptos se confunden porque es bastante comÃºn que el cÃ³digo reentrante tambiÃ©n sea seguro en hilos.
Sin embargo es posible crear cÃ³digo reentrante que no sea seguro en hilos y viceversa.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A la hora de usar una funciÃ³n o librerÃ­a que va a ser llamada desde mÃºltiples hilos, primero debemos consultar la documentaciÃ³n para averiguar si es <strong>segura en hilos</strong>.
Si no lo fuera, tendrÃ­amos que buscar funciones alternativas o recordar proteger las llamadas a las funciones no seguras con mecanismos de sincronizaciÃ³n, para asegurar que solo son invocadas desde un hilo al mismo tiempo.</p>
</div>
<div class="paragraph">
<p>Esto se aplica tanto a librerÃ­as de otros desarrolladores como a la librerÃ­a estÃ¡ndar del lenguaje que estemos usando y a la librerÃ­a del sistema.</p>
</div>
<div class="sect4">
<h5 id="_seguridad_en_hilos_en_c"><a class="anchor" href="#_seguridad_en_hilos_en_c"></a>Seguridad en hilos en C++</h5>
<div class="paragraph">
<p>La norma general es que las clases de la librerÃ­a estÃ¡ndar de C&#43;&#43; son seguras frente a mÃºltiples accesos de lectura desde diferentes hilos.
Pero si un hilo modifica un objeto, todas las lecturas y escrituras en el mismo objeto por ese y otros hilos deben estar protegidas.</p>
</div>
<div class="paragraph">
<p>Obviamente, las clases de mecanismos de sincronizaciÃ³n y gestiÃ³n de hilos generalmente ofrecen mayores garantÃ­as, para lo que hay que consultar la documentaciÃ³n.</p>
</div>
</div>
<div class="sect4">
<h5 id="_seguridad_en_hilos_en_c_2"><a class="anchor" href="#_seguridad_en_hilos_en_c_2"></a>Seguridad en hilos en C</h5>
<div class="paragraph">
<p>El estÃ¡ndar de C no menciona nada sobre <strong>seguridad en hilos</strong>, por lo que se debe suponer que las funciones de la librerÃ­a estÃ¡ndar no lo son o consultar la documentaciÃ³n ofrecida por el proveedor de la librerÃ­a.</p>
</div>
<div class="paragraph">
<p>Por ejemplo, todas las versiones de la librerÃ­a estÃ¡ndar de C en Windows actualmente son <strong>seguras en hilos</strong> (vÃ©ase <a href="https://docs.microsoft.com/en-us/cpp/parallel/multithreading-with-c-and-win32?view=vs-2019">Â«Multithreading with C and Win32&#8201;&#8212;&#8201;Microsoft DocsÂ»</a>).
Pero hasta hace unos aÃ±os Microsoft ofrecÃ­a varias versiones de la librerÃ­a, algunas <strong>seguras en hilos</strong>, para usar en aplicaciones multihilo, y otras no seguras para usar en aplicaciones monohilo.</p>
</div>
</div>
<div class="sect4">
<h5 id="_seguridad_en_hilos_en_posix"><a class="anchor" href="#_seguridad_en_hilos_en_posix"></a>Seguridad en hilos en POSIX</h5>
<div class="paragraph">
<p>La API POSIX es un superconjunto de la API de la librerÃ­a estÃ¡ndar de C.
Por lo que en esos sistemas el estÃ¡ndar POSIX es el que marca quÃ© funciones de la librerÃ­a estÃ¡ndar de C y del resto de la API POSIX son <strong>seguras en hilos</strong>.</p>
</div>
<div class="paragraph">
<p>En los sistemas POSIX, el estÃ¡ndar establece que todas las funciones son seguras excepto algunas muy concretas, que se pueden consultar en el apartado <a href="https://pubs.opengroup.org/onlinepubs/9699919799/functions/V2_chap02.html#tag_15_09_01">Â«2.9.1 Thread-SafetyÂ»</a> de la especificaciÃ³n.
Muchas de esas funciones no se especifican como <strong>seguras en hilos</strong> porque existe alguna alternativa que sÃ­ lo es.
Por ejemplo, <a href="https://man7.org/linux/man-pages/man3/strerror.3.html">strerror()</a> no es <strong>segura en hilos</strong>, pero <a href="https://man7.org/linux/man-pages/man3/strerror.3.html">strerror_r()</a> tiene una funcionalidad equivalente y sÃ­ lo es.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph nav-footer">
<p>âÂ Anterior:Â <a href="hilos.html">Hilos</a>Â | âÂ Subir:Â <a href="gestiÃ³n_de_procesos.html">GestiÃ³n de procesos</a>Â | âÂ Inicio:Â <a href="main.html">Sistemas Operativos</a>Â | Siguiente:Â <a href="planificaciÃ³n_de_la_cpu.html">PlanificaciÃ³n de la CPU</a>Â â</p>
</div>
</div>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  messageStyle: "none",
  tex2jax: {
    inlineMath: [["\\(", "\\)"]],
    displayMath: [["\\[", "\\]"]],
    ignoreClass: "nostem|nolatexmath"
  },
  asciimath2jax: {
    delimiters: [["\\$", "\\$"]],
    ignoreClass: "nostem|noasciimath"
  },
  TeX: { equationNumbers: { autoNumber: "none" } }
})
MathJax.Hub.Register.StartupHook("AsciiMath Jax Ready", function () {
  MathJax.InputJax.AsciiMath.postfilterHooks.Add(function (data, node) {
    if ((node = data.script.parentNode) && (node = node.parentNode) && node.classList.contains("stemblock")) {
      data.math.root.display = "block"
    }
    return data
  })
})
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js?config=TeX-MML-AM_HTMLorMML"></script>
<div id="footer">
    <div id="footer-text">
        Esta obra estÃ¡ sujeta a la licencia
        <a href="http://creativecommons.org/licenses/by/4.0/deed.es">Creative Commons AtribuciÃ³n 4.0 Internacional</a>,
        excepto donde se indique lo contrario.
    </div>
</div>
</body>
</html>